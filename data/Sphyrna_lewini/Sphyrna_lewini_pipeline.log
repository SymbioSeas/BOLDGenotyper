[2025-11-19 16:12:28] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:12:28] INFO: ================================================================================
[2025-11-19 16:12:28] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:12:28] INFO: ================================================================================
[2025-11-19 16:12:28] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:12:28] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:12:28] INFO: 
[2025-11-19 16:12:28] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:12:28] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:12:28] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:12:28] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:12:28] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:12:28] INFO: Read 685 rows and 88 columns
[2025-11-19 16:12:28] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:12:28] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:12:28] INFO: Data quality summary:
[2025-11-19 16:12:28] INFO:   total_rows: 675
[2025-11-19 16:12:28] INFO:   total_columns: 88
[2025-11-19 16:12:28] INFO:   unique_processids: 675
[2025-11-19 16:12:28] INFO:   sequences_present: 674
[2025-11-19 16:12:28] INFO:   sequences_missing: 1
[2025-11-19 16:12:28] INFO:   empty_sequences: 0
[2025-11-19 16:12:28] INFO:   coords_present: 229
[2025-11-19 16:12:28] INFO:   coords_missing: 446
[2025-11-19 16:12:28] INFO:   centroid_coords: 58
[2025-11-19 16:12:28] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:12:28] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:12:28] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:12:28] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:12:28] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:12:28] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:12:28] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:12:51] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:12:51] INFO: Creating point geometries from coordinates
[2025-11-19 16:12:51] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:12:51] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:12:52] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:12:52] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:12:52] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:12:52] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:12:52] INFO: 
[2025-11-19 16:12:52] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:12:52] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:12:52] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:12:52] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:12:52] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:12:52] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:12:52] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:12:52] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:12:57] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:12:57] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:12:59] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:12:59] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:12:59] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:13:16] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:13:16] INFO: Clustering sequences with average linkage, threshold=0.025
[2025-11-19 16:13:16] INFO: Clustering complete: 7 clusters formed
[2025-11-19 16:13:16] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:13:16] INFO:   ✓ Identified 7 unique genotypes
[2025-11-19 16:13:16] INFO: 
[2025-11-19 16:13:16] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:13:16] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:13:16] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:13:16] INFO: ======================================================================
[2025-11-19 16:13:16] INFO: Starting genotype assignment workflow
[2025-11-19 16:13:16] INFO: ======================================================================
[2025-11-19 16:13:16] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:13:16] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:13:16] INFO: Loaded 617 samples from metadata
[2025-11-19 16:13:16] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:13:16] INFO: Read 7 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:13:16] INFO: Loaded 7 consensus groups
[2025-11-19 16:13:16] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:13:16] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:13:16] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:13:16] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:13:16] INFO: Prepared 617 assignment tasks
[2025-11-19 16:13:16] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:13:16] INFO: Identity calculation method: target_based
[2025-11-19 16:13:16] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:13:19] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:13:19] INFO: Step 6/6: Writing outputs
[2025-11-19 16:13:19] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:13:19] INFO: Renamed 7 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:13:19] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:13:19] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:13:19] INFO: ======================================================================
[2025-11-19 16:13:19] INFO: Genotype assignment summary:
[2025-11-19 16:13:19] INFO:   Total samples: 617
[2025-11-19 16:13:19] INFO:   Successfully assigned: 579 (93.8%)
[2025-11-19 16:13:19] INFO:   Unassigned: 38 (6.2%)
[2025-11-19 16:13:19] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:13:19] INFO:     - Below identity threshold: 19
[2025-11-19 16:13:19] INFO:   Diagnostic flags:
[2025-11-19 16:13:19] INFO:     - Ties (ambiguous): 11
[2025-11-19 16:13:19] INFO:     - Low confidence: 2
[2025-11-19 16:13:19] INFO: ======================================================================
[2025-11-19 16:13:19] INFO:   ✓ Assigned 579/617 samples to genotypes
[2025-11-19 16:13:19] INFO:   ✓ Assignment rate: 93.8%
[2025-11-19 16:13:19] INFO: 
[2025-11-19 16:13:19] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:13:19] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:13:19] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:13:19] INFO:   ✓ Assigned taxonomy to 7 consensus groups
[2025-11-19 16:13:19] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:13:19] INFO: 
[2025-11-19 16:13:19] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:13:19] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:13:19] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:13:19] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:13:20] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:13:20] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:13:20] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:13:20] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:13:20] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:13:20] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:13:20] INFO: Loaded 7 label mappings from taxonomy CSV
[2025-11-19 16:13:20] INFO: Created 7 base name mappings
[2025-11-19 16:13:20] INFO: Relabeled 7 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:13:20] INFO: Relabeled 7 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:13:20] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:13:20] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:13:20] INFO: 
[2025-11-19 16:13:20] INFO: PHASE 6: Visualization
[2025-11-19 16:13:20] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:13:20] INFO: 6.1: Generating plots...
[2025-11-19 16:13:22] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:13:23] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:13:23] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:13:23] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:13:23] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 16:13:23] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:13:28] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:13:30] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:13:30] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:13:30] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:13:31] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:13:31] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:13:31] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 16:13:31] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:13:32] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:13:32] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:13:32] INFO:   ✓ Generated visualization plots
[2025-11-19 16:13:32] INFO: 
[2025-11-19 16:13:32] INFO: PHASE 7: Generating Reports
[2025-11-19 16:13:32] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:13:32] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:13:32] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:13:32] INFO: 
[2025-11-19 16:13:32] INFO: Cleaning up empty directories...
[2025-11-19 16:13:32] INFO:   ✓ Removed empty directories
[2025-11-19 16:13:32] INFO: 
[2025-11-19 16:13:32] INFO: Generating HTML summary report...
[2025-11-19 16:13:32] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:13:32] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:13:32] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:13:32] INFO: 
[2025-11-19 16:13:32] INFO: ================================================================================
[2025-11-19 16:13:32] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:13:32] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:13:32] INFO:   Key files:
[2025-11-19 16:13:32] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:13:32] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:13:32] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:13:32] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:13:32] INFO: ================================================================================
[2025-11-19 16:17:49] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:17:49] INFO: ================================================================================
[2025-11-19 16:17:49] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:17:49] INFO: ================================================================================
[2025-11-19 16:17:49] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:17:49] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:17:49] INFO: 
[2025-11-19 16:17:49] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:17:49] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:17:49] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:17:49] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:17:49] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:17:49] INFO: Read 685 rows and 88 columns
[2025-11-19 16:17:49] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:17:49] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:17:49] INFO: Data quality summary:
[2025-11-19 16:17:49] INFO:   total_rows: 675
[2025-11-19 16:17:49] INFO:   total_columns: 88
[2025-11-19 16:17:49] INFO:   unique_processids: 675
[2025-11-19 16:17:49] INFO:   sequences_present: 674
[2025-11-19 16:17:49] INFO:   sequences_missing: 1
[2025-11-19 16:17:49] INFO:   empty_sequences: 0
[2025-11-19 16:17:49] INFO:   coords_present: 229
[2025-11-19 16:17:49] INFO:   coords_missing: 446
[2025-11-19 16:17:49] INFO:   centroid_coords: 58
[2025-11-19 16:17:49] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:17:49] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:17:49] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:17:49] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:17:49] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:17:49] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:17:49] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:18:11] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:18:11] INFO: Creating point geometries from coordinates
[2025-11-19 16:18:11] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:18:12] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:18:12] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:18:12] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:18:12] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:18:12] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:18:12] INFO: 
[2025-11-19 16:18:12] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:18:12] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:12] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:18:12] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:18:12] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:18:12] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:18:12] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:18:12] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:18:17] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:18:17] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:18:19] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:18:19] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:18:19] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:18:37] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:18:37] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 16:18:37] INFO: Clustering complete: 6 clusters formed
[2025-11-19 16:18:37] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:18:37] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 16:18:37] INFO: 
[2025-11-19 16:18:37] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:18:37] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:37] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:18:37] INFO: ======================================================================
[2025-11-19 16:18:37] INFO: Starting genotype assignment workflow
[2025-11-19 16:18:37] INFO: ======================================================================
[2025-11-19 16:18:37] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:18:37] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:18:37] INFO: Loaded 617 samples from metadata
[2025-11-19 16:18:37] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:18:37] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:18:37] INFO: Loaded 6 consensus groups
[2025-11-19 16:18:37] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:18:37] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:18:37] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:18:37] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:18:37] INFO: Prepared 617 assignment tasks
[2025-11-19 16:18:37] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:18:37] INFO: Identity calculation method: target_based
[2025-11-19 16:18:37] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:18:41] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:18:41] INFO: Step 6/6: Writing outputs
[2025-11-19 16:18:41] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:18:41] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:18:41] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:18:41] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:18:41] INFO: ======================================================================
[2025-11-19 16:18:41] INFO: Genotype assignment summary:
[2025-11-19 16:18:41] INFO:   Total samples: 617
[2025-11-19 16:18:41] INFO:   Successfully assigned: 579 (93.8%)
[2025-11-19 16:18:41] INFO:   Unassigned: 38 (6.2%)
[2025-11-19 16:18:41] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:18:41] INFO:     - Below identity threshold: 19
[2025-11-19 16:18:41] INFO:   Diagnostic flags:
[2025-11-19 16:18:41] INFO:     - Ties (ambiguous): 2
[2025-11-19 16:18:41] INFO:     - Low confidence: 2
[2025-11-19 16:18:41] INFO: ======================================================================
[2025-11-19 16:18:41] INFO:   ✓ Assigned 579/617 samples to genotypes
[2025-11-19 16:18:41] INFO:   ✓ Assignment rate: 93.8%
[2025-11-19 16:18:41] INFO: 
[2025-11-19 16:18:41] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:18:41] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:41] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:18:41] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 16:18:41] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:18:41] INFO: 
[2025-11-19 16:18:41] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:18:41] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:41] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:18:41] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:18:42] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:18:42] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:18:42] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:18:42] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:18:42] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:18:42] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:18:42] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 16:18:42] INFO: Created 6 base name mappings
[2025-11-19 16:18:42] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:18:42] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:18:42] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:18:42] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:18:42] INFO: 
[2025-11-19 16:18:42] INFO: PHASE 6: Visualization
[2025-11-19 16:18:42] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:42] INFO: 6.1: Generating plots...
[2025-11-19 16:18:44] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:18:44] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:18:45] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:18:45] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:18:45] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 16:18:45] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:18:51] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:18:52] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:18:52] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:18:53] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:18:53] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:18:53] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:18:53] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 16:18:53] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:18:54] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:18:55] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:18:55] INFO:   ✓ Generated visualization plots
[2025-11-19 16:18:55] INFO: 
[2025-11-19 16:18:55] INFO: PHASE 7: Generating Reports
[2025-11-19 16:18:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:18:55] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:18:55] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:18:55] INFO: 
[2025-11-19 16:18:55] INFO: Cleaning up empty directories...
[2025-11-19 16:18:55] INFO:   ✓ Removed empty directories
[2025-11-19 16:18:55] INFO: 
[2025-11-19 16:18:55] INFO: Generating HTML summary report...
[2025-11-19 16:18:55] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:18:55] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:18:55] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:18:55] INFO: 
[2025-11-19 16:18:55] INFO: ================================================================================
[2025-11-19 16:18:55] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:18:55] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:18:55] INFO:   Key files:
[2025-11-19 16:18:55] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:18:55] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:18:55] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:18:55] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:18:55] INFO: ================================================================================
[2025-11-19 16:20:02] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:20:02] INFO: ================================================================================
[2025-11-19 16:20:02] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:20:02] INFO: ================================================================================
[2025-11-19 16:20:02] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:20:02] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:20:02] INFO: 
[2025-11-19 16:20:02] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:20:02] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:20:02] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:02] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:20:02] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:20:02] INFO: Read 685 rows and 88 columns
[2025-11-19 16:20:02] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:20:02] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:20:02] INFO: Data quality summary:
[2025-11-19 16:20:02] INFO:   total_rows: 675
[2025-11-19 16:20:02] INFO:   total_columns: 88
[2025-11-19 16:20:02] INFO:   unique_processids: 675
[2025-11-19 16:20:02] INFO:   sequences_present: 674
[2025-11-19 16:20:02] INFO:   sequences_missing: 1
[2025-11-19 16:20:02] INFO:   empty_sequences: 0
[2025-11-19 16:20:02] INFO:   coords_present: 229
[2025-11-19 16:20:02] INFO:   coords_missing: 446
[2025-11-19 16:20:02] INFO:   centroid_coords: 58
[2025-11-19 16:20:02] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:20:02] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:20:02] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:20:02] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:20:02] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:20:02] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:20:02] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:20:26] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:20:26] INFO: Creating point geometries from coordinates
[2025-11-19 16:20:26] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:20:26] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:20:27] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:20:27] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:20:27] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:20:27] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:20:27] INFO: 
[2025-11-19 16:20:27] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:20:27] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:27] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:20:27] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:20:27] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:20:27] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:20:27] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:20:27] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:20:32] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:20:32] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:20:33] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:20:33] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:20:33] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:20:52] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:20:52] INFO: Clustering sequences with average linkage, threshold=0.04
[2025-11-19 16:20:52] INFO: Clustering complete: 4 clusters formed
[2025-11-19 16:20:52] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:20:52] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 16:20:52] INFO: 
[2025-11-19 16:20:52] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:20:52] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:52] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:20:52] INFO: ======================================================================
[2025-11-19 16:20:52] INFO: Starting genotype assignment workflow
[2025-11-19 16:20:52] INFO: ======================================================================
[2025-11-19 16:20:52] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:20:52] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:20:52] INFO: Loaded 617 samples from metadata
[2025-11-19 16:20:52] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:20:52] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:20:52] INFO: Loaded 4 consensus groups
[2025-11-19 16:20:52] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:20:52] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:20:52] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:20:52] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:20:52] INFO: Prepared 617 assignment tasks
[2025-11-19 16:20:52] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:20:52] INFO: Identity calculation method: target_based
[2025-11-19 16:20:52] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:20:55] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:20:55] INFO: Step 6/6: Writing outputs
[2025-11-19 16:20:55] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:20:55] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:20:55] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:20:55] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:20:55] INFO: ======================================================================
[2025-11-19 16:20:55] INFO: Genotype assignment summary:
[2025-11-19 16:20:55] INFO:   Total samples: 617
[2025-11-19 16:20:55] INFO:   Successfully assigned: 569 (92.2%)
[2025-11-19 16:20:55] INFO:   Unassigned: 48 (7.8%)
[2025-11-19 16:20:55] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:20:55] INFO:     - Below identity threshold: 29
[2025-11-19 16:20:55] INFO:   Diagnostic flags:
[2025-11-19 16:20:55] INFO:     - Ties (ambiguous): 0
[2025-11-19 16:20:55] INFO:     - Low confidence: 9
[2025-11-19 16:20:55] INFO: ======================================================================
[2025-11-19 16:20:55] INFO:   ✓ Assigned 569/617 samples to genotypes
[2025-11-19 16:20:55] INFO:   ✓ Assignment rate: 92.2%
[2025-11-19 16:20:55] INFO: 
[2025-11-19 16:20:55] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:20:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:55] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:20:55] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 16:20:55] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:20:55] INFO: 
[2025-11-19 16:20:55] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:20:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:55] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:20:55] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:20:56] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:20:56] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:20:56] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:20:56] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:20:56] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:20:56] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:20:56] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 16:20:56] INFO: Created 4 base name mappings
[2025-11-19 16:20:56] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:20:56] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:20:56] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:20:56] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:20:56] INFO: 
[2025-11-19 16:20:56] INFO: PHASE 6: Visualization
[2025-11-19 16:20:56] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:20:56] INFO: 6.1: Generating plots...
[2025-11-19 16:20:57] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:20:58] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:20:58] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:20:58] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:20:58] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:20:59] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:21:03] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:21:03] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:21:04] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:21:04] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:21:04] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:21:04] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:21:04] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:21:04] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:21:05] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:21:05] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:21:05] INFO:   ✓ Generated visualization plots
[2025-11-19 16:21:05] INFO: 
[2025-11-19 16:21:05] INFO: PHASE 7: Generating Reports
[2025-11-19 16:21:05] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:21:05] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:21:05] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:21:05] INFO: 
[2025-11-19 16:21:05] INFO: Cleaning up empty directories...
[2025-11-19 16:21:05] INFO:   ✓ Removed empty directories
[2025-11-19 16:21:05] INFO: 
[2025-11-19 16:21:05] INFO: Generating HTML summary report...
[2025-11-19 16:21:05] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:21:05] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:21:05] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:21:05] INFO: 
[2025-11-19 16:21:05] INFO: ================================================================================
[2025-11-19 16:21:05] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:21:05] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:21:05] INFO:   Key files:
[2025-11-19 16:21:05] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:21:05] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:21:05] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:21:05] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:21:05] INFO: ================================================================================
[2025-11-19 16:25:21] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:25:21] INFO: ================================================================================
[2025-11-19 16:25:21] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:25:21] INFO: ================================================================================
[2025-11-19 16:25:21] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:25:21] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:25:21] INFO: 
[2025-11-19 16:25:21] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:25:21] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:25:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:25:21] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:25:21] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:25:21] INFO: Read 685 rows and 88 columns
[2025-11-19 16:25:21] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:25:21] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:25:21] INFO: Data quality summary:
[2025-11-19 16:25:21] INFO:   total_rows: 675
[2025-11-19 16:25:21] INFO:   total_columns: 88
[2025-11-19 16:25:21] INFO:   unique_processids: 675
[2025-11-19 16:25:21] INFO:   sequences_present: 674
[2025-11-19 16:25:21] INFO:   sequences_missing: 1
[2025-11-19 16:25:21] INFO:   empty_sequences: 0
[2025-11-19 16:25:21] INFO:   coords_present: 229
[2025-11-19 16:25:21] INFO:   coords_missing: 446
[2025-11-19 16:25:21] INFO:   centroid_coords: 58
[2025-11-19 16:25:21] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:25:21] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:25:21] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:25:21] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:25:21] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:25:21] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:25:21] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:25:45] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:25:45] INFO: Creating point geometries from coordinates
[2025-11-19 16:25:45] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:25:45] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:25:46] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:25:46] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:25:46] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:25:46] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:25:46] INFO: 
[2025-11-19 16:25:46] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:25:46] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:25:46] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:25:46] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:25:46] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:25:46] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:25:46] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:25:46] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:25:51] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:25:51] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:25:53] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:25:53] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:25:53] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:26:10] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:26:10] INFO: Clustering sequences with average linkage, threshold=0.04
[2025-11-19 16:26:10] INFO: Clustering complete: 4 clusters formed
[2025-11-19 16:26:10] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:26:10] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 16:26:10] INFO: 
[2025-11-19 16:26:10] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:26:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:26:10] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:26:10] INFO: ======================================================================
[2025-11-19 16:26:10] INFO: Starting genotype assignment workflow
[2025-11-19 16:26:10] INFO: ======================================================================
[2025-11-19 16:26:10] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:26:10] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:26:10] INFO: Loaded 617 samples from metadata
[2025-11-19 16:26:10] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:26:10] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:26:10] INFO: Loaded 4 consensus groups
[2025-11-19 16:26:10] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:26:10] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:26:10] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:26:10] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:26:10] INFO: Prepared 617 assignment tasks
[2025-11-19 16:26:10] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:26:10] INFO: Identity calculation method: target_based
[2025-11-19 16:26:10] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:26:13] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:26:13] INFO: Step 6/6: Writing outputs
[2025-11-19 16:26:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:26:13] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:26:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:26:13] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:26:13] INFO: ======================================================================
[2025-11-19 16:26:13] INFO: Genotype assignment summary:
[2025-11-19 16:26:13] INFO:   Total samples: 617
[2025-11-19 16:26:13] INFO:   Successfully assigned: 588 (95.3%)
[2025-11-19 16:26:13] INFO:   Unassigned: 29 (4.7%)
[2025-11-19 16:26:13] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:26:13] INFO:     - Below identity threshold: 10
[2025-11-19 16:26:13] INFO:   Diagnostic flags:
[2025-11-19 16:26:13] INFO:     - Ties (ambiguous): 0
[2025-11-19 16:26:13] INFO:     - Low confidence: 4
[2025-11-19 16:26:13] INFO: ======================================================================
[2025-11-19 16:26:13] INFO:   ✓ Assigned 588/617 samples to genotypes
[2025-11-19 16:26:13] INFO:   ✓ Assignment rate: 95.3%
[2025-11-19 16:26:13] INFO: 
[2025-11-19 16:26:13] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:26:13] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:26:13] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:26:13] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 16:26:13] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:26:13] INFO: 
[2025-11-19 16:26:13] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:26:13] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:26:13] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:26:13] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:26:14] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:26:14] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:26:14] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:26:14] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:26:14] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:26:14] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:26:14] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 16:26:14] INFO: Created 4 base name mappings
[2025-11-19 16:26:14] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:26:14] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:26:14] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:26:14] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:26:14] INFO: 
[2025-11-19 16:26:14] INFO: PHASE 6: Visualization
[2025-11-19 16:26:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:26:14] INFO: 6.1: Generating plots...
[2025-11-19 16:26:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:26:16] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:26:16] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:26:16] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:26:16] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:26:17] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:26:21] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:26:21] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:26:22] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:26:22] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:26:22] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:26:22] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:26:22] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:26:22] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:26:23] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:26:23] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:26:23] INFO:   ✓ Generated visualization plots
[2025-11-19 16:26:23] INFO: 
[2025-11-19 16:26:23] INFO: PHASE 7: Generating Reports
[2025-11-19 16:26:23] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:26:23] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:26:23] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:26:23] INFO: 
[2025-11-19 16:26:23] INFO: Cleaning up empty directories...
[2025-11-19 16:26:23] INFO:   ✓ Removed empty directories
[2025-11-19 16:26:23] INFO: 
[2025-11-19 16:26:23] INFO: Generating HTML summary report...
[2025-11-19 16:26:23] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:26:23] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:26:23] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:26:23] INFO: 
[2025-11-19 16:26:23] INFO: ================================================================================
[2025-11-19 16:26:23] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:26:23] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:26:23] INFO:   Key files:
[2025-11-19 16:26:23] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:26:23] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:26:23] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:26:23] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:26:23] INFO: ================================================================================
[2025-11-19 16:28:23] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:28:23] INFO: ================================================================================
[2025-11-19 16:28:23] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:28:23] INFO: ================================================================================
[2025-11-19 16:28:23] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:28:23] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:28:23] INFO: 
[2025-11-19 16:28:23] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:28:23] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:28:23] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:28:23] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:28:23] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:28:23] INFO: Read 685 rows and 88 columns
[2025-11-19 16:28:23] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:28:23] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:28:23] INFO: Data quality summary:
[2025-11-19 16:28:23] INFO:   total_rows: 675
[2025-11-19 16:28:23] INFO:   total_columns: 88
[2025-11-19 16:28:23] INFO:   unique_processids: 675
[2025-11-19 16:28:23] INFO:   sequences_present: 674
[2025-11-19 16:28:23] INFO:   sequences_missing: 1
[2025-11-19 16:28:23] INFO:   empty_sequences: 0
[2025-11-19 16:28:23] INFO:   coords_present: 229
[2025-11-19 16:28:23] INFO:   coords_missing: 446
[2025-11-19 16:28:23] INFO:   centroid_coords: 58
[2025-11-19 16:28:23] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:28:23] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:28:23] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:28:23] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:28:23] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:28:23] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:28:23] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:28:46] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:28:46] INFO: Creating point geometries from coordinates
[2025-11-19 16:28:46] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:28:46] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:28:47] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:28:47] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:28:47] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:28:47] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:28:47] INFO: 
[2025-11-19 16:28:47] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:28:47] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:28:47] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:28:47] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:28:47] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:28:47] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:28:47] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:28:47] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:28:52] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:28:52] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:28:53] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:28:53] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:28:53] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:29:11] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:29:11] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-19 16:29:11] INFO: Clustering complete: 4 clusters formed
[2025-11-19 16:29:11] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:29:11] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 16:29:11] INFO: 
[2025-11-19 16:29:11] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:29:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:29:11] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:29:11] INFO: ======================================================================
[2025-11-19 16:29:11] INFO: Starting genotype assignment workflow
[2025-11-19 16:29:11] INFO: ======================================================================
[2025-11-19 16:29:11] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:29:11] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:29:11] INFO: Loaded 617 samples from metadata
[2025-11-19 16:29:11] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:29:11] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:29:11] INFO: Loaded 4 consensus groups
[2025-11-19 16:29:11] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:29:11] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:29:11] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:29:11] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:29:11] INFO: Prepared 617 assignment tasks
[2025-11-19 16:29:11] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:29:11] INFO: Identity calculation method: target_based
[2025-11-19 16:29:11] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:29:14] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:29:14] INFO: Step 6/6: Writing outputs
[2025-11-19 16:29:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:29:14] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:29:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:29:14] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:29:14] INFO: ======================================================================
[2025-11-19 16:29:14] INFO: Genotype assignment summary:
[2025-11-19 16:29:14] INFO:   Total samples: 617
[2025-11-19 16:29:14] INFO:   Successfully assigned: 588 (95.3%)
[2025-11-19 16:29:14] INFO:   Unassigned: 29 (4.7%)
[2025-11-19 16:29:14] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:29:14] INFO:     - Below identity threshold: 10
[2025-11-19 16:29:14] INFO:   Diagnostic flags:
[2025-11-19 16:29:14] INFO:     - Ties (ambiguous): 0
[2025-11-19 16:29:14] INFO:     - Low confidence: 4
[2025-11-19 16:29:14] INFO: ======================================================================
[2025-11-19 16:29:14] INFO:   ✓ Assigned 588/617 samples to genotypes
[2025-11-19 16:29:14] INFO:   ✓ Assignment rate: 95.3%
[2025-11-19 16:29:14] INFO: 
[2025-11-19 16:29:14] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:29:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:29:14] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:29:14] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 16:29:14] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:29:14] INFO: 
[2025-11-19 16:29:14] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:29:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:29:14] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:29:14] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:29:15] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:29:15] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:29:15] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:29:15] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:29:15] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:29:15] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:29:15] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 16:29:15] INFO: Created 4 base name mappings
[2025-11-19 16:29:15] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:29:15] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:29:15] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:29:15] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:29:15] INFO: 
[2025-11-19 16:29:15] INFO: PHASE 6: Visualization
[2025-11-19 16:29:15] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:29:15] INFO: 6.1: Generating plots...
[2025-11-19 16:29:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:29:17] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:29:17] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:29:17] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:29:17] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:29:18] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:29:22] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:29:22] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:29:23] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:29:23] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:29:23] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:29:23] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:29:23] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:29:23] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:29:24] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:29:24] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:29:24] INFO:   ✓ Generated visualization plots
[2025-11-19 16:29:24] INFO: 
[2025-11-19 16:29:24] INFO: PHASE 7: Generating Reports
[2025-11-19 16:29:24] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:29:24] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:29:24] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:29:24] INFO: 
[2025-11-19 16:29:24] INFO: Cleaning up empty directories...
[2025-11-19 16:29:24] INFO:   ✓ Removed empty directories
[2025-11-19 16:29:24] INFO: 
[2025-11-19 16:29:24] INFO: Generating HTML summary report...
[2025-11-19 16:29:24] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:29:24] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:29:24] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:29:24] INFO: 
[2025-11-19 16:29:24] INFO: ================================================================================
[2025-11-19 16:29:24] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:29:24] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:29:24] INFO:   Key files:
[2025-11-19 16:29:24] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:29:24] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:29:24] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:29:24] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:29:24] INFO: ================================================================================
[2025-11-19 16:30:17] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:30:17] INFO: ================================================================================
[2025-11-19 16:30:17] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:30:17] INFO: ================================================================================
[2025-11-19 16:30:17] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:30:17] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:30:17] INFO: 
[2025-11-19 16:30:17] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:30:17] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:30:17] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:30:17] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:30:17] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:30:17] INFO: Read 685 rows and 88 columns
[2025-11-19 16:30:17] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:30:17] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:30:17] INFO: Data quality summary:
[2025-11-19 16:30:17] INFO:   total_rows: 675
[2025-11-19 16:30:17] INFO:   total_columns: 88
[2025-11-19 16:30:17] INFO:   unique_processids: 675
[2025-11-19 16:30:17] INFO:   sequences_present: 674
[2025-11-19 16:30:17] INFO:   sequences_missing: 1
[2025-11-19 16:30:17] INFO:   empty_sequences: 0
[2025-11-19 16:30:17] INFO:   coords_present: 229
[2025-11-19 16:30:17] INFO:   coords_missing: 446
[2025-11-19 16:30:17] INFO:   centroid_coords: 58
[2025-11-19 16:30:17] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:30:17] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:30:17] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:30:17] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:30:17] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:30:17] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:30:17] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:30:41] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:30:41] INFO: Creating point geometries from coordinates
[2025-11-19 16:30:41] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:30:41] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:30:42] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:30:42] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:30:42] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:30:42] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:30:42] INFO: 
[2025-11-19 16:30:42] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:30:42] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:30:42] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:30:42] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:30:42] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:30:42] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:30:42] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:30:42] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:30:47] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:30:47] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:30:49] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:30:49] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:30:49] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:31:06] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:31:06] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-19 16:31:06] INFO: Clustering complete: 4 clusters formed
[2025-11-19 16:31:07] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:31:07] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 16:31:07] INFO: 
[2025-11-19 16:31:07] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:31:07] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:31:07] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:31:07] INFO: ======================================================================
[2025-11-19 16:31:07] INFO: Starting genotype assignment workflow
[2025-11-19 16:31:07] INFO: ======================================================================
[2025-11-19 16:31:07] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:31:07] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:31:07] INFO: Loaded 617 samples from metadata
[2025-11-19 16:31:07] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:31:07] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:31:07] INFO: Loaded 4 consensus groups
[2025-11-19 16:31:07] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:31:07] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:31:07] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:31:07] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:31:07] INFO: Prepared 617 assignment tasks
[2025-11-19 16:31:07] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:31:07] INFO: Identity calculation method: target_based
[2025-11-19 16:31:07] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:31:10] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:31:10] INFO: Step 6/6: Writing outputs
[2025-11-19 16:31:10] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:31:10] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:31:10] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:31:10] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:31:10] INFO: ======================================================================
[2025-11-19 16:31:10] INFO: Genotype assignment summary:
[2025-11-19 16:31:10] INFO:   Total samples: 617
[2025-11-19 16:31:10] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 16:31:10] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 16:31:10] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:31:10] INFO:     - Below identity threshold: 3
[2025-11-19 16:31:10] INFO:   Diagnostic flags:
[2025-11-19 16:31:10] INFO:     - Ties (ambiguous): 0
[2025-11-19 16:31:10] INFO:     - Low confidence: 0
[2025-11-19 16:31:10] INFO: ======================================================================
[2025-11-19 16:31:10] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 16:31:10] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 16:31:10] INFO: 
[2025-11-19 16:31:10] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:31:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:31:10] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:31:10] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 16:31:10] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:31:10] INFO: 
[2025-11-19 16:31:10] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:31:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:31:10] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:31:10] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:31:11] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:31:11] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:31:11] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:31:11] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:31:11] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:31:11] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:31:11] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 16:31:11] INFO: Created 4 base name mappings
[2025-11-19 16:31:11] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:31:11] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:31:11] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:31:11] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:31:11] INFO: 
[2025-11-19 16:31:11] INFO: PHASE 6: Visualization
[2025-11-19 16:31:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:31:11] INFO: 6.1: Generating plots...
[2025-11-19 16:31:12] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:31:13] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:31:14] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:31:14] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:31:14] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:31:14] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:31:18] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:31:19] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:31:19] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:31:20] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:31:20] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:31:20] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:31:20] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 16:31:20] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:31:21] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:31:21] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:31:21] INFO:   ✓ Generated visualization plots
[2025-11-19 16:31:21] INFO: 
[2025-11-19 16:31:21] INFO: PHASE 7: Generating Reports
[2025-11-19 16:31:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:31:21] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:31:21] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:31:21] INFO: 
[2025-11-19 16:31:21] INFO: Cleaning up empty directories...
[2025-11-19 16:31:21] INFO:   ✓ Removed empty directories
[2025-11-19 16:31:21] INFO: 
[2025-11-19 16:31:21] INFO: Generating HTML summary report...
[2025-11-19 16:31:21] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:31:21] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:31:21] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:31:21] INFO: 
[2025-11-19 16:31:21] INFO: ================================================================================
[2025-11-19 16:31:21] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:31:21] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:31:21] INFO:   Key files:
[2025-11-19 16:31:21] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:31:21] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:31:21] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:31:21] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:31:21] INFO: ================================================================================
[2025-11-19 16:32:23] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 16:32:23] INFO: ================================================================================
[2025-11-19 16:32:23] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 16:32:23] INFO: ================================================================================
[2025-11-19 16:32:23] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:32:23] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:32:23] INFO: 
[2025-11-19 16:32:23] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 16:32:23] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 16:32:23] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:32:23] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 16:32:23] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 16:32:24] INFO: Read 685 rows and 88 columns
[2025-11-19 16:32:24] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 16:32:24] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 16:32:24] INFO: Data quality summary:
[2025-11-19 16:32:24] INFO:   total_rows: 675
[2025-11-19 16:32:24] INFO:   total_columns: 88
[2025-11-19 16:32:24] INFO:   unique_processids: 675
[2025-11-19 16:32:24] INFO:   sequences_present: 674
[2025-11-19 16:32:24] INFO:   sequences_missing: 1
[2025-11-19 16:32:24] INFO:   empty_sequences: 0
[2025-11-19 16:32:24] INFO:   coords_present: 229
[2025-11-19 16:32:24] INFO:   coords_missing: 446
[2025-11-19 16:32:24] INFO:   centroid_coords: 58
[2025-11-19 16:32:24] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 16:32:24] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 16:32:24] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 16:32:24] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 16:32:24] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 16:32:24] INFO: 1.3: Assigning ocean basins...
[2025-11-19 16:32:24] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 16:32:46] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 16:32:46] INFO: Creating point geometries from coordinates
[2025-11-19 16:32:46] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 16:32:46] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 16:32:47] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 16:32:47] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 16:32:47] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 16:32:47] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 16:32:47] INFO: 
[2025-11-19 16:32:47] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 16:32:47] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:32:47] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 16:32:47] INFO:   Minimum sequence length: 400 bp
[2025-11-19 16:32:47] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 16:32:47] INFO:   ✓ Created 598 FASTA records
[2025-11-19 16:32:47] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 16:32:47] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:32:52] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:32:52] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 16:32:53] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 16:32:53] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 16:32:53] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 16:33:11] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 16:33:11] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 16:33:11] INFO: Clustering complete: 6 clusters formed
[2025-11-19 16:33:11] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 16:33:11] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 16:33:11] INFO: 
[2025-11-19 16:33:11] INFO: PHASE 3: Genotype Assignment
[2025-11-19 16:33:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:33:11] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 16:33:11] INFO: ======================================================================
[2025-11-19 16:33:11] INFO: Starting genotype assignment workflow
[2025-11-19 16:33:11] INFO: ======================================================================
[2025-11-19 16:33:11] INFO: Using edlib for fast edit distance calculation
[2025-11-19 16:33:11] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 16:33:11] INFO: Loaded 617 samples from metadata
[2025-11-19 16:33:11] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:33:11] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:33:11] INFO: Loaded 6 consensus groups
[2025-11-19 16:33:11] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:33:11] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 16:33:11] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 16:33:11] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 16:33:11] INFO: Prepared 617 assignment tasks
[2025-11-19 16:33:11] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 16:33:11] INFO: Identity calculation method: target_based
[2025-11-19 16:33:11] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 16:33:14] INFO: Completed genotype assignment for 617 samples
[2025-11-19 16:33:14] INFO: Step 6/6: Writing outputs
[2025-11-19 16:33:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:33:14] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 16:33:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 16:33:14] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 16:33:14] INFO: ======================================================================
[2025-11-19 16:33:14] INFO: Genotype assignment summary:
[2025-11-19 16:33:14] INFO:   Total samples: 617
[2025-11-19 16:33:14] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 16:33:14] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 16:33:14] INFO:     - No sequence in FASTA: 19
[2025-11-19 16:33:14] INFO:     - Below identity threshold: 3
[2025-11-19 16:33:14] INFO:   Diagnostic flags:
[2025-11-19 16:33:14] INFO:     - Ties (ambiguous): 2
[2025-11-19 16:33:14] INFO:     - Low confidence: 0
[2025-11-19 16:33:14] INFO: ======================================================================
[2025-11-19 16:33:14] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 16:33:14] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 16:33:14] INFO: 
[2025-11-19 16:33:14] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 16:33:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:33:14] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 16:33:14] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 16:33:14] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:33:14] INFO: 
[2025-11-19 16:33:14] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 16:33:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:33:14] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 16:33:14] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:33:15] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:33:15] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 16:33:15] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:33:15] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:33:15] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 16:33:15] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 16:33:15] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 16:33:15] INFO: Created 6 base name mappings
[2025-11-19 16:33:15] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:33:15] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:33:15] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:33:15] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 16:33:15] INFO: 
[2025-11-19 16:33:15] INFO: PHASE 6: Visualization
[2025-11-19 16:33:15] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:33:15] INFO: 6.1: Generating plots...
[2025-11-19 16:33:17] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 16:33:17] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 16:33:17] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 16:33:17] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:33:17] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 16:33:18] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:33:23] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 16:33:24] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 16:33:25] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 16:33:25] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 16:33:25] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 16:33:25] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 16:33:25] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 16:33:25] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 16:33:26] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 16:33:27] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 16:33:27] INFO:   ✓ Generated visualization plots
[2025-11-19 16:33:27] INFO: 
[2025-11-19 16:33:27] INFO: PHASE 7: Generating Reports
[2025-11-19 16:33:27] INFO: --------------------------------------------------------------------------------
[2025-11-19 16:33:27] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:33:27] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 16:33:27] INFO: 
[2025-11-19 16:33:27] INFO: Cleaning up empty directories...
[2025-11-19 16:33:27] INFO:   ✓ Removed empty directories
[2025-11-19 16:33:27] INFO: 
[2025-11-19 16:33:27] INFO: Generating HTML summary report...
[2025-11-19 16:33:27] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 16:33:27] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:33:27] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:33:27] INFO: 
[2025-11-19 16:33:27] INFO: ================================================================================
[2025-11-19 16:33:27] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 16:33:27] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 16:33:27] INFO:   Key files:
[2025-11-19 16:33:27] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 16:33:27] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 16:33:27] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 16:33:27] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 16:33:27] INFO: ================================================================================
[2025-11-19 17:31:32] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:31:32] INFO: ================================================================================
[2025-11-19 17:31:32] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:31:32] INFO: ================================================================================
[2025-11-19 17:31:32] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:31:32] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:31:32] INFO: 
[2025-11-19 17:31:32] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:31:32] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:31:32] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:31:32] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:31:32] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:31:32] INFO: Read 685 rows and 88 columns
[2025-11-19 17:31:32] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:31:32] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:31:32] INFO: Data quality summary:
[2025-11-19 17:31:32] INFO:   total_rows: 675
[2025-11-19 17:31:32] INFO:   total_columns: 88
[2025-11-19 17:31:32] INFO:   unique_processids: 675
[2025-11-19 17:31:32] INFO:   sequences_present: 674
[2025-11-19 17:31:32] INFO:   sequences_missing: 1
[2025-11-19 17:31:32] INFO:   empty_sequences: 0
[2025-11-19 17:31:32] INFO:   coords_present: 229
[2025-11-19 17:31:32] INFO:   coords_missing: 446
[2025-11-19 17:31:32] INFO:   centroid_coords: 58
[2025-11-19 17:31:32] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:31:32] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:31:32] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:31:32] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:31:32] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:31:32] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:31:32] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:31:55] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:31:55] INFO: Creating point geometries from coordinates
[2025-11-19 17:31:55] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:31:55] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:31:55] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:31:55] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:31:55] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:31:55] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:31:55] INFO: 
[2025-11-19 17:31:55] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:31:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:31:55] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:31:55] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:31:55] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:31:55] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:31:55] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:31:55] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:32:01] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:32:01] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:32:02] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:32:02] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:32:02] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:32:20] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:32:21] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 17:32:21] INFO: Clustering complete: 6 clusters formed
[2025-11-19 17:32:21] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:32:21] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 17:32:21] INFO: 
[2025-11-19 17:32:21] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:32:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:32:21] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:32:21] INFO: ======================================================================
[2025-11-19 17:32:21] INFO: Starting genotype assignment workflow
[2025-11-19 17:32:21] INFO: ======================================================================
[2025-11-19 17:32:21] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:32:21] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:32:21] INFO: Loaded 617 samples from metadata
[2025-11-19 17:32:21] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:32:21] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:32:21] INFO: Loaded 6 consensus groups
[2025-11-19 17:32:21] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:32:21] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:32:21] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:32:21] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:32:21] INFO: Prepared 617 assignment tasks
[2025-11-19 17:32:21] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:32:21] INFO: Identity calculation method: target_based
[2025-11-19 17:32:21] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:32:25] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:32:25] INFO: Step 6/6: Writing outputs
[2025-11-19 17:32:25] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:32:25] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:32:25] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:32:25] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:32:25] INFO: ======================================================================
[2025-11-19 17:32:25] INFO: Genotype assignment summary:
[2025-11-19 17:32:25] INFO:   Total samples: 617
[2025-11-19 17:32:25] INFO:   Successfully assigned: 564 (91.4%)
[2025-11-19 17:32:25] INFO:   Unassigned: 53 (8.6%)
[2025-11-19 17:32:25] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:32:25] INFO:     - Below identity threshold: 34
[2025-11-19 17:32:25] INFO:   Diagnostic flags:
[2025-11-19 17:32:25] INFO:     - Ties (ambiguous): 2
[2025-11-19 17:32:25] INFO:     - Low confidence: 11
[2025-11-19 17:32:25] INFO: ======================================================================
[2025-11-19 17:32:25] INFO:   ✓ Assigned 564/617 samples to genotypes
[2025-11-19 17:32:25] INFO:   ✓ Assignment rate: 91.4%
[2025-11-19 17:32:25] INFO: 
[2025-11-19 17:32:25] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:32:25] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:32:25] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:32:25] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 17:32:25] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:32:25] INFO: 
[2025-11-19 17:32:25] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:32:25] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:32:25] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:32:25] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:32:26] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:32:26] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:32:26] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:32:26] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:32:26] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:32:26] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:32:26] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 17:32:26] INFO: Created 6 base name mappings
[2025-11-19 17:32:26] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:32:26] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:32:26] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:32:26] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:32:26] INFO: 
[2025-11-19 17:32:26] INFO: PHASE 6: Visualization
[2025-11-19 17:32:26] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:32:26] INFO: 6.1: Generating plots...
[2025-11-19 17:32:28] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:32:28] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:32:29] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:32:29] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:32:29] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:32:29] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:32:34] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:32:35] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:32:36] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:32:36] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:32:36] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:32:36] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:32:36] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:32:36] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:32:38] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:32:38] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:32:38] INFO:   ✓ Generated visualization plots
[2025-11-19 17:32:38] INFO: 
[2025-11-19 17:32:38] INFO: PHASE 7: Generating Reports
[2025-11-19 17:32:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:32:38] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:32:38] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:32:38] INFO: 
[2025-11-19 17:32:38] INFO: Cleaning up empty directories...
[2025-11-19 17:32:38] INFO:   ✓ Removed empty directories
[2025-11-19 17:32:38] INFO: 
[2025-11-19 17:32:38] INFO: Generating HTML summary report...
[2025-11-19 17:32:38] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:32:38] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:32:38] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:32:38] INFO: 
[2025-11-19 17:32:38] INFO: ================================================================================
[2025-11-19 17:32:38] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:32:38] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:32:38] INFO:   Key files:
[2025-11-19 17:32:38] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:32:38] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:32:38] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:32:38] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:32:38] INFO: ================================================================================
[2025-11-19 17:33:43] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:33:43] INFO: ================================================================================
[2025-11-19 17:33:43] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:33:43] INFO: ================================================================================
[2025-11-19 17:33:43] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:33:43] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:33:43] INFO: 
[2025-11-19 17:33:43] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:33:43] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:33:43] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:33:43] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:33:43] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:33:43] INFO: Read 685 rows and 88 columns
[2025-11-19 17:33:43] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:33:43] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:33:43] INFO: Data quality summary:
[2025-11-19 17:33:43] INFO:   total_rows: 675
[2025-11-19 17:33:43] INFO:   total_columns: 88
[2025-11-19 17:33:43] INFO:   unique_processids: 675
[2025-11-19 17:33:43] INFO:   sequences_present: 674
[2025-11-19 17:33:43] INFO:   sequences_missing: 1
[2025-11-19 17:33:43] INFO:   empty_sequences: 0
[2025-11-19 17:33:43] INFO:   coords_present: 229
[2025-11-19 17:33:43] INFO:   coords_missing: 446
[2025-11-19 17:33:43] INFO:   centroid_coords: 58
[2025-11-19 17:33:43] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:33:43] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:33:43] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:33:43] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:33:43] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:33:43] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:33:43] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:34:06] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:34:06] INFO: Creating point geometries from coordinates
[2025-11-19 17:34:06] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:34:06] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:34:07] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:34:07] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:34:07] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:34:07] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:34:07] INFO: 
[2025-11-19 17:34:07] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:34:07] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:07] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:34:07] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:34:07] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:34:07] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:34:07] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:34:07] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:34:12] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:34:12] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:34:14] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:34:14] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:34:14] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:34:35] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:34:35] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 17:34:35] INFO: Clustering complete: 6 clusters formed
[2025-11-19 17:34:35] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:34:35] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 17:34:35] INFO: 
[2025-11-19 17:34:35] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:34:35] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:35] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:34:35] INFO: ======================================================================
[2025-11-19 17:34:35] INFO: Starting genotype assignment workflow
[2025-11-19 17:34:35] INFO: ======================================================================
[2025-11-19 17:34:35] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:34:35] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:34:35] INFO: Loaded 617 samples from metadata
[2025-11-19 17:34:35] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:34:35] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:34:35] INFO: Loaded 6 consensus groups
[2025-11-19 17:34:35] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:34:36] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:34:36] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:34:36] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:34:36] INFO: Prepared 617 assignment tasks
[2025-11-19 17:34:36] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:34:36] INFO: Identity calculation method: target_based
[2025-11-19 17:34:36] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:34:39] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:34:39] INFO: Step 6/6: Writing outputs
[2025-11-19 17:34:39] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:34:39] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:34:39] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:34:39] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:34:39] INFO: ======================================================================
[2025-11-19 17:34:39] INFO: Genotype assignment summary:
[2025-11-19 17:34:39] INFO:   Total samples: 617
[2025-11-19 17:34:39] INFO:   Successfully assigned: 564 (91.4%)
[2025-11-19 17:34:39] INFO:   Unassigned: 53 (8.6%)
[2025-11-19 17:34:39] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:34:39] INFO:     - Below identity threshold: 34
[2025-11-19 17:34:39] INFO:   Diagnostic flags:
[2025-11-19 17:34:39] INFO:     - Ties (ambiguous): 2
[2025-11-19 17:34:39] INFO:     - Low confidence: 11
[2025-11-19 17:34:39] INFO: ======================================================================
[2025-11-19 17:34:39] INFO:   ✓ Assigned 564/617 samples to genotypes
[2025-11-19 17:34:39] INFO:   ✓ Assignment rate: 91.4%
[2025-11-19 17:34:39] INFO: 
[2025-11-19 17:34:39] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:34:39] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:39] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:34:39] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 17:34:39] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:34:39] INFO: 
[2025-11-19 17:34:39] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:34:39] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:39] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:34:39] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:34:40] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:34:40] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:34:40] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:34:40] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:34:40] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:34:40] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:34:40] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 17:34:40] INFO: Created 6 base name mappings
[2025-11-19 17:34:40] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:34:40] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:34:40] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:34:40] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:34:40] INFO: 
[2025-11-19 17:34:40] INFO: PHASE 6: Visualization
[2025-11-19 17:34:40] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:40] INFO: 6.1: Generating plots...
[2025-11-19 17:34:41] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:34:42] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:34:42] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:34:42] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:34:42] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:34:43] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:34:48] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:34:49] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:34:50] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:34:50] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:34:50] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:34:50] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:34:50] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:34:50] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:34:52] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:34:52] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:34:52] INFO:   ✓ Generated visualization plots
[2025-11-19 17:34:52] INFO: 
[2025-11-19 17:34:52] INFO: PHASE 7: Generating Reports
[2025-11-19 17:34:52] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:34:52] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:34:52] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:34:52] INFO: 
[2025-11-19 17:34:52] INFO: Cleaning up empty directories...
[2025-11-19 17:34:52] INFO:   ✓ Removed empty directories
[2025-11-19 17:34:52] INFO: 
[2025-11-19 17:34:52] INFO: Generating HTML summary report...
[2025-11-19 17:34:52] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:34:52] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:34:52] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:34:52] INFO: 
[2025-11-19 17:34:52] INFO: ================================================================================
[2025-11-19 17:34:52] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:34:52] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:34:52] INFO:   Key files:
[2025-11-19 17:34:52] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:34:52] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:34:52] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:34:52] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:34:52] INFO: ================================================================================
[2025-11-19 17:37:20] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:37:20] INFO: ================================================================================
[2025-11-19 17:37:20] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:37:20] INFO: ================================================================================
[2025-11-19 17:37:20] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:37:20] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:37:20] INFO: 
[2025-11-19 17:37:20] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:37:20] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:37:20] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:37:20] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:37:20] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:37:20] INFO: Read 685 rows and 88 columns
[2025-11-19 17:37:20] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:37:20] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:37:20] INFO: Data quality summary:
[2025-11-19 17:37:20] INFO:   total_rows: 675
[2025-11-19 17:37:20] INFO:   total_columns: 88
[2025-11-19 17:37:20] INFO:   unique_processids: 675
[2025-11-19 17:37:20] INFO:   sequences_present: 674
[2025-11-19 17:37:20] INFO:   sequences_missing: 1
[2025-11-19 17:37:20] INFO:   empty_sequences: 0
[2025-11-19 17:37:20] INFO:   coords_present: 229
[2025-11-19 17:37:20] INFO:   coords_missing: 446
[2025-11-19 17:37:20] INFO:   centroid_coords: 58
[2025-11-19 17:37:20] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:37:20] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:37:20] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:37:20] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:37:20] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:37:20] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:37:20] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:37:45] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:37:45] INFO: Creating point geometries from coordinates
[2025-11-19 17:37:45] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:37:45] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:37:45] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:37:45] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:37:45] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:37:45] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:37:45] INFO: 
[2025-11-19 17:37:45] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:37:45] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:37:45] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:37:45] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:37:45] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:37:45] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:37:45] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:37:45] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:37:51] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:37:51] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:37:52] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:37:52] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:37:52] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:38:10] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:38:10] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 17:38:10] INFO: Clustering complete: 6 clusters formed
[2025-11-19 17:38:10] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:38:10] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 17:38:10] INFO: 
[2025-11-19 17:38:10] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:38:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:38:10] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:38:10] INFO: ======================================================================
[2025-11-19 17:38:10] INFO: Starting genotype assignment workflow
[2025-11-19 17:38:10] INFO: ======================================================================
[2025-11-19 17:38:10] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:38:10] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:38:10] INFO: Loaded 617 samples from metadata
[2025-11-19 17:38:10] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:38:10] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:38:10] INFO: Loaded 6 consensus groups
[2025-11-19 17:38:10] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:38:10] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:38:10] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:38:10] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:38:10] INFO: Prepared 617 assignment tasks
[2025-11-19 17:38:10] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:38:10] INFO: Identity calculation method: target_based
[2025-11-19 17:38:10] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:38:14] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:38:14] INFO: Step 6/6: Writing outputs
[2025-11-19 17:38:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:38:14] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:38:14] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:38:14] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:38:14] INFO: ======================================================================
[2025-11-19 17:38:14] INFO: Genotype assignment summary:
[2025-11-19 17:38:14] INFO:   Total samples: 617
[2025-11-19 17:38:14] INFO:   Successfully assigned: 564 (91.4%)
[2025-11-19 17:38:14] INFO:   Unassigned: 53 (8.6%)
[2025-11-19 17:38:14] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:38:14] INFO:     - Below identity threshold: 34
[2025-11-19 17:38:14] INFO:   Diagnostic flags:
[2025-11-19 17:38:14] INFO:     - Ties (ambiguous): 2
[2025-11-19 17:38:14] INFO:     - Low confidence: 11
[2025-11-19 17:38:14] INFO: ======================================================================
[2025-11-19 17:38:14] INFO:   ✓ Assigned 564/617 samples to genotypes
[2025-11-19 17:38:14] INFO:   ✓ Assignment rate: 91.4%
[2025-11-19 17:38:14] INFO: 
[2025-11-19 17:38:14] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:38:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:38:14] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:38:14] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 17:38:14] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:38:14] INFO: 
[2025-11-19 17:38:14] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:38:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:38:14] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:38:14] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:38:15] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:38:15] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:38:15] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:38:15] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:38:15] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:38:15] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:38:15] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 17:38:15] INFO: Created 6 base name mappings
[2025-11-19 17:38:15] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:38:15] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:38:15] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:38:15] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:38:15] INFO: 
[2025-11-19 17:38:15] INFO: PHASE 6: Visualization
[2025-11-19 17:38:15] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:38:15] INFO: 6.1: Generating plots...
[2025-11-19 17:38:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:38:16] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:38:17] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:38:17] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:38:17] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:38:17] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:38:22] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:38:23] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:38:24] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:38:24] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:38:24] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:38:24] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:38:24] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:38:24] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:38:26] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:38:26] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:38:26] INFO:   ✓ Generated visualization plots
[2025-11-19 17:38:26] INFO: 
[2025-11-19 17:38:26] INFO: PHASE 7: Generating Reports
[2025-11-19 17:38:26] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:38:26] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:38:26] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:38:26] INFO: 
[2025-11-19 17:38:26] INFO: Cleaning up empty directories...
[2025-11-19 17:38:26] INFO:   ✓ Removed empty directories
[2025-11-19 17:38:26] INFO: 
[2025-11-19 17:38:26] INFO: Generating HTML summary report...
[2025-11-19 17:38:26] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:38:26] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:38:26] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:38:26] INFO: 
[2025-11-19 17:38:26] INFO: ================================================================================
[2025-11-19 17:38:26] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:38:26] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:38:26] INFO:   Key files:
[2025-11-19 17:38:26] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:38:26] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:38:26] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:38:26] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:38:26] INFO: ================================================================================
[2025-11-19 17:48:58] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:48:58] INFO: ================================================================================
[2025-11-19 17:48:58] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:48:58] INFO: ================================================================================
[2025-11-19 17:48:58] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:48:58] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:48:58] INFO: 
[2025-11-19 17:48:58] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:48:58] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:48:58] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:48:58] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:48:58] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:48:58] INFO: Read 685 rows and 88 columns
[2025-11-19 17:48:58] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:48:58] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:48:58] INFO: Data quality summary:
[2025-11-19 17:48:58] INFO:   total_rows: 675
[2025-11-19 17:48:58] INFO:   total_columns: 88
[2025-11-19 17:48:58] INFO:   unique_processids: 675
[2025-11-19 17:48:58] INFO:   sequences_present: 674
[2025-11-19 17:48:58] INFO:   sequences_missing: 1
[2025-11-19 17:48:58] INFO:   empty_sequences: 0
[2025-11-19 17:48:58] INFO:   coords_present: 229
[2025-11-19 17:48:58] INFO:   coords_missing: 446
[2025-11-19 17:48:58] INFO:   centroid_coords: 58
[2025-11-19 17:48:58] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:48:58] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:48:58] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:48:58] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:48:58] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:48:58] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:48:58] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:49:21] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:49:21] INFO: Creating point geometries from coordinates
[2025-11-19 17:49:21] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:49:21] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:49:21] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:49:21] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:49:21] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:49:21] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:49:21] INFO: 
[2025-11-19 17:49:21] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:49:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:49:21] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:49:21] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:49:22] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:49:22] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:49:22] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:49:22] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:49:27] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:49:27] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:49:28] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:49:28] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:49:28] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:49:46] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:49:46] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 17:49:46] INFO: Clustering complete: 6 clusters formed
[2025-11-19 17:49:47] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:49:47] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 17:49:47] INFO: 
[2025-11-19 17:49:47] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:49:47] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:49:47] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:49:47] INFO: ======================================================================
[2025-11-19 17:49:47] INFO: Starting genotype assignment workflow
[2025-11-19 17:49:47] INFO: ======================================================================
[2025-11-19 17:49:47] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:49:47] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:49:47] INFO: Loaded 617 samples from metadata
[2025-11-19 17:49:47] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:49:47] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:49:47] INFO: Loaded 6 consensus groups
[2025-11-19 17:49:47] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:49:47] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:49:47] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:49:47] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:49:47] INFO: Prepared 617 assignment tasks
[2025-11-19 17:49:47] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:49:47] INFO: Identity calculation method: target_based
[2025-11-19 17:49:47] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:49:50] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:49:50] INFO: Step 6/6: Writing outputs
[2025-11-19 17:49:50] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:49:50] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:49:50] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:49:50] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:49:50] INFO: ======================================================================
[2025-11-19 17:49:50] INFO: Genotype assignment summary:
[2025-11-19 17:49:50] INFO:   Total samples: 617
[2025-11-19 17:49:50] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 17:49:50] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 17:49:50] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:49:50] INFO:     - Below identity threshold: 3
[2025-11-19 17:49:50] INFO:   Diagnostic flags:
[2025-11-19 17:49:50] INFO:     - Ties (ambiguous): 2
[2025-11-19 17:49:50] INFO:     - Low confidence: 0
[2025-11-19 17:49:50] INFO: ======================================================================
[2025-11-19 17:49:50] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 17:49:50] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 17:49:50] INFO: 
[2025-11-19 17:49:50] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:49:50] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:49:50] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:49:50] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 17:49:50] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:49:50] INFO: 
[2025-11-19 17:49:50] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:49:50] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:49:50] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:49:50] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:49:51] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:49:51] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:49:51] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:49:51] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:49:51] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:49:51] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:49:51] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 17:49:51] INFO: Created 6 base name mappings
[2025-11-19 17:49:51] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:49:51] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:49:51] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:49:51] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:49:51] INFO: 
[2025-11-19 17:49:51] INFO: PHASE 6: Visualization
[2025-11-19 17:49:51] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:49:51] INFO: 6.1: Generating plots...
[2025-11-19 17:49:52] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:49:53] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:49:53] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:49:53] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:49:53] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:49:53] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:49:59] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:50:00] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:50:01] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:50:01] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:50:01] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:50:01] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:50:01] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:50:01] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:50:03] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:50:03] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:50:03] INFO:   ✓ Generated visualization plots
[2025-11-19 17:50:03] INFO: 
[2025-11-19 17:50:03] INFO: PHASE 7: Generating Reports
[2025-11-19 17:50:03] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:50:03] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:50:03] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:50:03] INFO: 
[2025-11-19 17:50:03] INFO: Cleaning up empty directories...
[2025-11-19 17:50:03] INFO:   ✓ Removed empty directories
[2025-11-19 17:50:03] INFO: 
[2025-11-19 17:50:03] INFO: Generating HTML summary report...
[2025-11-19 17:50:03] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:50:03] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:50:03] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:50:03] INFO: 
[2025-11-19 17:50:03] INFO: ================================================================================
[2025-11-19 17:50:03] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:50:03] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:50:03] INFO:   Key files:
[2025-11-19 17:50:03] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:50:03] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:50:03] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:50:03] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:50:03] INFO: ================================================================================
[2025-11-19 17:52:24] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:52:24] INFO: ================================================================================
[2025-11-19 17:52:24] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:52:24] INFO: ================================================================================
[2025-11-19 17:52:24] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:52:24] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:52:24] INFO: 
[2025-11-19 17:52:24] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:52:24] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:52:24] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:52:24] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:52:24] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:52:24] INFO: Read 685 rows and 88 columns
[2025-11-19 17:52:24] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:52:24] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:52:24] INFO: Data quality summary:
[2025-11-19 17:52:24] INFO:   total_rows: 675
[2025-11-19 17:52:24] INFO:   total_columns: 88
[2025-11-19 17:52:24] INFO:   unique_processids: 675
[2025-11-19 17:52:24] INFO:   sequences_present: 674
[2025-11-19 17:52:24] INFO:   sequences_missing: 1
[2025-11-19 17:52:24] INFO:   empty_sequences: 0
[2025-11-19 17:52:24] INFO:   coords_present: 229
[2025-11-19 17:52:24] INFO:   coords_missing: 446
[2025-11-19 17:52:24] INFO:   centroid_coords: 58
[2025-11-19 17:52:24] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:52:24] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:52:24] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:52:24] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:52:24] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:52:24] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:52:24] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:52:48] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:52:48] INFO: Creating point geometries from coordinates
[2025-11-19 17:52:48] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:52:48] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:52:48] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:52:48] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:52:48] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:52:48] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:52:48] INFO: 
[2025-11-19 17:52:48] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:52:48] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:52:48] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:52:48] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:52:48] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:52:48] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:52:48] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:52:48] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:52:54] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:52:54] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:52:55] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:52:55] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:52:55] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:53:13] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:53:13] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 17:53:13] INFO: Clustering complete: 6 clusters formed
[2025-11-19 17:53:14] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:53:14] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 17:53:14] INFO: 
[2025-11-19 17:53:14] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:53:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:53:14] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:53:14] INFO: ======================================================================
[2025-11-19 17:53:14] INFO: Starting genotype assignment workflow
[2025-11-19 17:53:14] INFO: ======================================================================
[2025-11-19 17:53:14] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:53:14] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:53:14] INFO: Loaded 617 samples from metadata
[2025-11-19 17:53:14] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:53:14] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:53:14] INFO: Loaded 6 consensus groups
[2025-11-19 17:53:14] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:53:14] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:53:14] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:53:14] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:53:14] INFO: Prepared 617 assignment tasks
[2025-11-19 17:53:14] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:53:14] INFO: Identity calculation method: target_based
[2025-11-19 17:53:14] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:53:17] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:53:17] INFO: Step 6/6: Writing outputs
[2025-11-19 17:53:17] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:53:17] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:53:17] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:53:17] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:53:17] INFO: ======================================================================
[2025-11-19 17:53:17] INFO: Genotype assignment summary:
[2025-11-19 17:53:17] INFO:   Total samples: 617
[2025-11-19 17:53:17] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 17:53:17] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 17:53:17] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:53:17] INFO:     - Below identity threshold: 3
[2025-11-19 17:53:17] INFO:   Diagnostic flags:
[2025-11-19 17:53:17] INFO:     - Ties (ambiguous): 2
[2025-11-19 17:53:17] INFO:     - Low confidence: 0
[2025-11-19 17:53:17] INFO: ======================================================================
[2025-11-19 17:53:17] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 17:53:17] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 17:53:17] INFO: 
[2025-11-19 17:53:17] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:53:17] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:53:17] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:53:17] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 17:53:17] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:53:17] INFO: 
[2025-11-19 17:53:17] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:53:17] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:53:17] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:53:17] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:53:18] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:53:18] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:53:18] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:53:18] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:53:18] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:53:18] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:53:18] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 17:53:18] INFO: Created 6 base name mappings
[2025-11-19 17:53:18] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:53:18] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:53:18] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:53:18] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:53:18] INFO: 
[2025-11-19 17:53:18] INFO: PHASE 6: Visualization
[2025-11-19 17:53:18] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:53:18] INFO: 6.1: Generating plots...
[2025-11-19 17:53:20] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:53:20] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:53:21] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:53:21] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:53:21] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:53:21] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:53:26] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:53:27] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:53:28] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:53:28] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:53:28] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:53:28] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:53:28] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 17:53:28] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:53:29] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:53:30] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:53:30] INFO:   ✓ Generated visualization plots
[2025-11-19 17:53:30] INFO: 
[2025-11-19 17:53:30] INFO: PHASE 7: Generating Reports
[2025-11-19 17:53:30] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:53:30] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:53:30] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:53:30] INFO: 
[2025-11-19 17:53:30] INFO: Cleaning up empty directories...
[2025-11-19 17:53:30] INFO:   ✓ Removed empty directories
[2025-11-19 17:53:30] INFO: 
[2025-11-19 17:53:30] INFO: Generating HTML summary report...
[2025-11-19 17:53:30] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:53:30] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:53:30] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:53:30] INFO: 
[2025-11-19 17:53:30] INFO: ================================================================================
[2025-11-19 17:53:30] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:53:30] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:53:30] INFO:   Key files:
[2025-11-19 17:53:30] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:53:30] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:53:30] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:53:30] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:53:30] INFO: ================================================================================
[2025-11-19 17:57:07] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 17:57:07] INFO: ================================================================================
[2025-11-19 17:57:07] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 17:57:07] INFO: ================================================================================
[2025-11-19 17:57:07] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:57:07] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:57:07] INFO: 
[2025-11-19 17:57:07] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 17:57:07] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 17:57:07] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:57:07] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 17:57:07] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 17:57:07] INFO: Read 685 rows and 88 columns
[2025-11-19 17:57:07] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 17:57:07] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 17:57:07] INFO: Data quality summary:
[2025-11-19 17:57:07] INFO:   total_rows: 675
[2025-11-19 17:57:07] INFO:   total_columns: 88
[2025-11-19 17:57:07] INFO:   unique_processids: 675
[2025-11-19 17:57:07] INFO:   sequences_present: 674
[2025-11-19 17:57:07] INFO:   sequences_missing: 1
[2025-11-19 17:57:07] INFO:   empty_sequences: 0
[2025-11-19 17:57:07] INFO:   coords_present: 229
[2025-11-19 17:57:07] INFO:   coords_missing: 446
[2025-11-19 17:57:07] INFO:   centroid_coords: 58
[2025-11-19 17:57:07] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 17:57:07] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 17:57:07] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 17:57:07] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 17:57:07] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 17:57:07] INFO: 1.3: Assigning ocean basins...
[2025-11-19 17:57:07] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 17:57:31] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 17:57:31] INFO: Creating point geometries from coordinates
[2025-11-19 17:57:31] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 17:57:31] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 17:57:31] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 17:57:31] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 17:57:31] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 17:57:31] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 17:57:31] INFO: 
[2025-11-19 17:57:31] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 17:57:31] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:57:31] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 17:57:31] INFO:   Minimum sequence length: 400 bp
[2025-11-19 17:57:31] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 17:57:31] INFO:   ✓ Created 598 FASTA records
[2025-11-19 17:57:31] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 17:57:31] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:57:36] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:57:36] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 17:57:38] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 17:57:38] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 17:57:38] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 17:57:56] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 17:57:56] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-19 17:57:56] INFO: Clustering complete: 4 clusters formed
[2025-11-19 17:57:57] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 17:57:57] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 17:57:57] INFO: 
[2025-11-19 17:57:57] INFO: PHASE 3: Genotype Assignment
[2025-11-19 17:57:57] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:57:57] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 17:57:57] INFO: ======================================================================
[2025-11-19 17:57:57] INFO: Starting genotype assignment workflow
[2025-11-19 17:57:57] INFO: ======================================================================
[2025-11-19 17:57:57] INFO: Using edlib for fast edit distance calculation
[2025-11-19 17:57:57] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 17:57:57] INFO: Loaded 617 samples from metadata
[2025-11-19 17:57:57] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:57:57] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:57:57] INFO: Loaded 4 consensus groups
[2025-11-19 17:57:57] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:57:57] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 17:57:57] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 17:57:57] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 17:57:57] INFO: Prepared 617 assignment tasks
[2025-11-19 17:57:57] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 17:57:57] INFO: Identity calculation method: target_based
[2025-11-19 17:57:57] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 17:58:00] INFO: Completed genotype assignment for 617 samples
[2025-11-19 17:58:00] INFO: Step 6/6: Writing outputs
[2025-11-19 17:58:00] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:58:00] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 17:58:00] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 17:58:00] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 17:58:00] INFO: ======================================================================
[2025-11-19 17:58:00] INFO: Genotype assignment summary:
[2025-11-19 17:58:00] INFO:   Total samples: 617
[2025-11-19 17:58:00] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 17:58:00] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 17:58:00] INFO:     - No sequence in FASTA: 19
[2025-11-19 17:58:00] INFO:     - Below identity threshold: 3
[2025-11-19 17:58:00] INFO:   Diagnostic flags:
[2025-11-19 17:58:00] INFO:     - Ties (ambiguous): 0
[2025-11-19 17:58:00] INFO:     - Low confidence: 0
[2025-11-19 17:58:00] INFO: ======================================================================
[2025-11-19 17:58:00] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 17:58:00] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 17:58:00] INFO: 
[2025-11-19 17:58:00] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 17:58:00] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:58:00] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 17:58:00] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 17:58:00] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:58:00] INFO: 
[2025-11-19 17:58:00] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 17:58:00] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:58:00] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 17:58:00] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:58:01] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:58:01] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 17:58:01] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:58:01] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:58:01] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 17:58:01] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 17:58:01] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 17:58:01] INFO: Created 4 base name mappings
[2025-11-19 17:58:01] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:58:01] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:58:01] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:58:01] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 17:58:01] INFO: 
[2025-11-19 17:58:01] INFO: PHASE 6: Visualization
[2025-11-19 17:58:01] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:58:01] INFO: 6.1: Generating plots...
[2025-11-19 17:58:02] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 17:58:03] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 17:58:03] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 17:58:03] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:58:03] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 17:58:03] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:58:07] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 17:58:08] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 17:58:09] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 17:58:09] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 17:58:09] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 17:58:09] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 17:58:09] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 17:58:09] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 17:58:10] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 17:58:10] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 17:58:10] INFO:   ✓ Generated visualization plots
[2025-11-19 17:58:10] INFO: 
[2025-11-19 17:58:10] INFO: PHASE 7: Generating Reports
[2025-11-19 17:58:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 17:58:10] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:58:10] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 17:58:10] INFO: 
[2025-11-19 17:58:10] INFO: Cleaning up empty directories...
[2025-11-19 17:58:10] INFO:   ✓ Removed empty directories
[2025-11-19 17:58:10] INFO: 
[2025-11-19 17:58:10] INFO: Generating HTML summary report...
[2025-11-19 17:58:10] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 17:58:10] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:58:10] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:58:10] INFO: 
[2025-11-19 17:58:10] INFO: ================================================================================
[2025-11-19 17:58:10] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 17:58:10] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 17:58:10] INFO:   Key files:
[2025-11-19 17:58:10] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 17:58:10] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 17:58:10] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 17:58:10] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 17:58:10] INFO: ================================================================================
[2025-11-19 18:02:14] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:02:14] INFO: ================================================================================
[2025-11-19 18:02:14] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:02:14] INFO: ================================================================================
[2025-11-19 18:02:14] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:02:14] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:02:14] INFO: 
[2025-11-19 18:02:14] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:02:14] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:02:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:02:14] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:02:14] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:02:14] INFO: Read 685 rows and 88 columns
[2025-11-19 18:02:14] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:02:14] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:02:14] INFO: Data quality summary:
[2025-11-19 18:02:14] INFO:   total_rows: 675
[2025-11-19 18:02:14] INFO:   total_columns: 88
[2025-11-19 18:02:14] INFO:   unique_processids: 675
[2025-11-19 18:02:14] INFO:   sequences_present: 674
[2025-11-19 18:02:14] INFO:   sequences_missing: 1
[2025-11-19 18:02:14] INFO:   empty_sequences: 0
[2025-11-19 18:02:14] INFO:   coords_present: 229
[2025-11-19 18:02:14] INFO:   coords_missing: 446
[2025-11-19 18:02:14] INFO:   centroid_coords: 58
[2025-11-19 18:02:14] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:02:14] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:02:14] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:02:14] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:02:14] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:02:14] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:02:14] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:02:38] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:02:38] INFO: Creating point geometries from coordinates
[2025-11-19 18:02:38] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:02:38] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:02:38] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:02:38] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:02:38] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:02:38] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:02:38] INFO: 
[2025-11-19 18:02:38] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:02:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:02:38] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:02:38] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:02:38] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:02:38] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:02:38] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:02:38] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:02:44] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:02:44] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:02:45] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:02:45] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:02:45] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:03:03] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:03:03] INFO: Clustering sequences with average linkage, threshold=0.025
[2025-11-19 18:03:03] INFO: Clustering complete: 7 clusters formed
[2025-11-19 18:03:04] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:03:04] INFO:   ✓ Identified 7 unique genotypes
[2025-11-19 18:03:04] INFO: 
[2025-11-19 18:03:04] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:03:04] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:04] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:03:04] INFO: ======================================================================
[2025-11-19 18:03:04] INFO: Starting genotype assignment workflow
[2025-11-19 18:03:04] INFO: ======================================================================
[2025-11-19 18:03:04] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:03:04] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:03:04] INFO: Loaded 617 samples from metadata
[2025-11-19 18:03:04] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:03:04] INFO: Read 7 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:03:04] INFO: Loaded 7 consensus groups
[2025-11-19 18:03:04] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:03:04] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:03:04] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:03:04] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:03:04] INFO: Prepared 617 assignment tasks
[2025-11-19 18:03:04] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:03:04] INFO: Identity calculation method: target_based
[2025-11-19 18:03:04] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:03:08] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:03:08] INFO: Step 6/6: Writing outputs
[2025-11-19 18:03:08] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:03:08] INFO: Renamed 7 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:03:08] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:03:08] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:03:08] INFO: ======================================================================
[2025-11-19 18:03:08] INFO: Genotype assignment summary:
[2025-11-19 18:03:08] INFO:   Total samples: 617
[2025-11-19 18:03:08] INFO:   Successfully assigned: 579 (93.8%)
[2025-11-19 18:03:08] INFO:   Unassigned: 38 (6.2%)
[2025-11-19 18:03:08] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:03:08] INFO:     - Below identity threshold: 19
[2025-11-19 18:03:08] INFO:   Diagnostic flags:
[2025-11-19 18:03:08] INFO:     - Ties (ambiguous): 11
[2025-11-19 18:03:08] INFO:     - Low confidence: 2
[2025-11-19 18:03:08] INFO: ======================================================================
[2025-11-19 18:03:08] INFO:   ✓ Assigned 579/617 samples to genotypes
[2025-11-19 18:03:08] INFO:   ✓ Assignment rate: 93.8%
[2025-11-19 18:03:08] INFO: 
[2025-11-19 18:03:08] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:03:08] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:08] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:03:08] INFO:   ✓ Assigned taxonomy to 7 consensus groups
[2025-11-19 18:03:08] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:03:08] INFO: 
[2025-11-19 18:03:08] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:03:08] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:08] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:03:08] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:03:09] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:03:09] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:03:09] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:03:09] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:03:09] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:03:09] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:03:09] INFO: Loaded 7 label mappings from taxonomy CSV
[2025-11-19 18:03:09] INFO: Created 7 base name mappings
[2025-11-19 18:03:09] INFO: Relabeled 7 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:03:09] INFO: Relabeled 7 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:03:09] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:03:09] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:03:09] INFO: 
[2025-11-19 18:03:09] INFO: PHASE 6: Visualization
[2025-11-19 18:03:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:09] INFO: 6.1: Generating plots...
[2025-11-19 18:03:10] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:03:11] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:03:11] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:03:11] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:03:11] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 18:03:12] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:03:17] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:03:18] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:03:19] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:03:19] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:03:19] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:03:19] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:03:19] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 18:03:19] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:03:20] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:03:21] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:03:21] INFO:   ✓ Generated visualization plots
[2025-11-19 18:03:21] INFO: 
[2025-11-19 18:03:21] INFO: PHASE 7: Generating Reports
[2025-11-19 18:03:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:21] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:03:21] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:03:21] INFO: 
[2025-11-19 18:03:21] INFO: Cleaning up empty directories...
[2025-11-19 18:03:21] INFO:   ✓ Removed empty directories
[2025-11-19 18:03:21] INFO: 
[2025-11-19 18:03:21] INFO: Generating HTML summary report...
[2025-11-19 18:03:21] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:03:21] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:03:21] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:03:21] INFO: 
[2025-11-19 18:03:21] INFO: ================================================================================
[2025-11-19 18:03:21] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:03:21] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:03:21] INFO:   Key files:
[2025-11-19 18:03:21] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:03:21] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:03:21] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:03:21] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:03:21] INFO: ================================================================================
[2025-11-19 18:03:48] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:03:48] INFO: ================================================================================
[2025-11-19 18:03:48] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:03:48] INFO: ================================================================================
[2025-11-19 18:03:48] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:03:48] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:03:48] INFO: 
[2025-11-19 18:03:48] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:03:48] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:03:48] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:03:48] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:03:48] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:03:48] INFO: Read 685 rows and 88 columns
[2025-11-19 18:03:48] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:03:48] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:03:48] INFO: Data quality summary:
[2025-11-19 18:03:48] INFO:   total_rows: 675
[2025-11-19 18:03:48] INFO:   total_columns: 88
[2025-11-19 18:03:48] INFO:   unique_processids: 675
[2025-11-19 18:03:48] INFO:   sequences_present: 674
[2025-11-19 18:03:48] INFO:   sequences_missing: 1
[2025-11-19 18:03:48] INFO:   empty_sequences: 0
[2025-11-19 18:03:48] INFO:   coords_present: 229
[2025-11-19 18:03:48] INFO:   coords_missing: 446
[2025-11-19 18:03:48] INFO:   centroid_coords: 58
[2025-11-19 18:03:48] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:03:48] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:03:48] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:03:48] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:03:48] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:03:48] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:03:48] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:04:12] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:04:12] INFO: Creating point geometries from coordinates
[2025-11-19 18:04:12] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:04:12] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:04:12] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:04:12] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:04:12] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:04:12] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:04:12] INFO: 
[2025-11-19 18:04:12] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:04:12] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:12] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:04:12] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:04:12] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:04:12] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:04:12] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:04:12] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:04:18] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:04:18] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:04:19] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:04:19] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:04:19] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:04:36] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:04:36] INFO: Clustering sequences with average linkage, threshold=0.025
[2025-11-19 18:04:36] INFO: Clustering complete: 7 clusters formed
[2025-11-19 18:04:36] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:04:36] INFO:   ✓ Identified 7 unique genotypes
[2025-11-19 18:04:36] INFO: 
[2025-11-19 18:04:36] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:04:36] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:36] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:04:36] INFO: ======================================================================
[2025-11-19 18:04:36] INFO: Starting genotype assignment workflow
[2025-11-19 18:04:36] INFO: ======================================================================
[2025-11-19 18:04:36] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:04:36] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:04:36] INFO: Loaded 617 samples from metadata
[2025-11-19 18:04:36] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:04:36] INFO: Read 7 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:04:36] INFO: Loaded 7 consensus groups
[2025-11-19 18:04:36] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:04:36] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:04:36] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:04:36] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:04:36] INFO: Prepared 617 assignment tasks
[2025-11-19 18:04:36] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:04:36] INFO: Identity calculation method: target_based
[2025-11-19 18:04:36] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:04:40] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:04:40] INFO: Step 6/6: Writing outputs
[2025-11-19 18:04:40] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:04:40] INFO: Renamed 7 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:04:40] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:04:40] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:04:40] INFO: ======================================================================
[2025-11-19 18:04:40] INFO: Genotype assignment summary:
[2025-11-19 18:04:40] INFO:   Total samples: 617
[2025-11-19 18:04:40] INFO:   Successfully assigned: 579 (93.8%)
[2025-11-19 18:04:40] INFO:   Unassigned: 38 (6.2%)
[2025-11-19 18:04:40] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:04:40] INFO:     - Below identity threshold: 19
[2025-11-19 18:04:40] INFO:   Diagnostic flags:
[2025-11-19 18:04:40] INFO:     - Ties (ambiguous): 11
[2025-11-19 18:04:40] INFO:     - Low confidence: 2
[2025-11-19 18:04:40] INFO: ======================================================================
[2025-11-19 18:04:40] INFO:   ✓ Assigned 579/617 samples to genotypes
[2025-11-19 18:04:40] INFO:   ✓ Assignment rate: 93.8%
[2025-11-19 18:04:41] INFO: 
[2025-11-19 18:04:41] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:04:41] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:41] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:04:41] INFO:   ✓ Assigned taxonomy to 7 consensus groups
[2025-11-19 18:04:41] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:04:41] INFO: 
[2025-11-19 18:04:41] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:04:41] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:41] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:04:41] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:04:42] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:04:42] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:04:42] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:04:42] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:04:42] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:04:42] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:04:42] INFO: Loaded 7 label mappings from taxonomy CSV
[2025-11-19 18:04:42] INFO: Created 7 base name mappings
[2025-11-19 18:04:42] INFO: Relabeled 7 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:04:42] INFO: Relabeled 7 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:04:42] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:04:42] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:04:42] INFO: 
[2025-11-19 18:04:42] INFO: PHASE 6: Visualization
[2025-11-19 18:04:42] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:42] INFO: 6.1: Generating plots...
[2025-11-19 18:04:44] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:04:44] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:04:45] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:04:45] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:04:45] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 18:04:45] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:04:50] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:04:51] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:04:52] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:04:52] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:04:52] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:04:52] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:04:52] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-19 18:04:52] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:04:54] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:04:54] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:04:54] INFO:   ✓ Generated visualization plots
[2025-11-19 18:04:54] INFO: 
[2025-11-19 18:04:54] INFO: PHASE 7: Generating Reports
[2025-11-19 18:04:54] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:04:54] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:04:54] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:04:54] INFO: 
[2025-11-19 18:04:54] INFO: Cleaning up empty directories...
[2025-11-19 18:04:54] INFO:   ✓ Removed empty directories
[2025-11-19 18:04:54] INFO: 
[2025-11-19 18:04:54] INFO: Generating HTML summary report...
[2025-11-19 18:04:54] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:04:54] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:04:54] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:04:54] INFO: 
[2025-11-19 18:04:54] INFO: ================================================================================
[2025-11-19 18:04:54] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:04:54] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:04:54] INFO:   Key files:
[2025-11-19 18:04:54] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:04:54] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:04:54] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:04:54] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:04:54] INFO: ================================================================================
[2025-11-19 18:06:05] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:06:05] INFO: ================================================================================
[2025-11-19 18:06:05] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:06:05] INFO: ================================================================================
[2025-11-19 18:06:05] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:06:05] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:06:05] INFO: 
[2025-11-19 18:06:05] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:06:05] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:06:05] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:06:05] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:06:05] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:06:05] INFO: Read 685 rows and 88 columns
[2025-11-19 18:06:05] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:06:05] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:06:05] INFO: Data quality summary:
[2025-11-19 18:06:05] INFO:   total_rows: 675
[2025-11-19 18:06:05] INFO:   total_columns: 88
[2025-11-19 18:06:05] INFO:   unique_processids: 675
[2025-11-19 18:06:05] INFO:   sequences_present: 674
[2025-11-19 18:06:05] INFO:   sequences_missing: 1
[2025-11-19 18:06:05] INFO:   empty_sequences: 0
[2025-11-19 18:06:05] INFO:   coords_present: 229
[2025-11-19 18:06:05] INFO:   coords_missing: 446
[2025-11-19 18:06:05] INFO:   centroid_coords: 58
[2025-11-19 18:06:05] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:06:05] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:06:05] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:06:05] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:06:05] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:06:05] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:06:05] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:06:30] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:06:31] INFO: Creating point geometries from coordinates
[2025-11-19 18:06:31] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:06:31] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:06:31] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:06:31] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:06:31] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:06:31] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:06:31] INFO: 
[2025-11-19 18:06:31] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:06:31] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:06:31] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:06:31] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:06:31] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:06:31] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:06:31] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:06:31] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:06:36] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:06:36] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:06:38] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:06:38] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:06:38] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:06:55] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:06:55] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 18:06:55] INFO: Clustering complete: 6 clusters formed
[2025-11-19 18:06:56] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:06:56] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 18:06:56] INFO: 
[2025-11-19 18:06:56] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:06:56] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:06:56] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:06:56] INFO: ======================================================================
[2025-11-19 18:06:56] INFO: Starting genotype assignment workflow
[2025-11-19 18:06:56] INFO: ======================================================================
[2025-11-19 18:06:56] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:06:56] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:06:56] INFO: Loaded 617 samples from metadata
[2025-11-19 18:06:56] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:06:56] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:06:56] INFO: Loaded 6 consensus groups
[2025-11-19 18:06:56] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:06:56] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:06:56] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:06:56] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:06:56] INFO: Prepared 617 assignment tasks
[2025-11-19 18:06:56] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:06:56] INFO: Identity calculation method: target_based
[2025-11-19 18:06:56] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:06:58] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:06:58] INFO: Step 6/6: Writing outputs
[2025-11-19 18:06:59] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:06:59] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:06:59] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:06:59] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:06:59] INFO: ======================================================================
[2025-11-19 18:06:59] INFO: Genotype assignment summary:
[2025-11-19 18:06:59] INFO:   Total samples: 617
[2025-11-19 18:06:59] INFO:   Successfully assigned: 579 (93.8%)
[2025-11-19 18:06:59] INFO:   Unassigned: 38 (6.2%)
[2025-11-19 18:06:59] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:06:59] INFO:     - Below identity threshold: 19
[2025-11-19 18:06:59] INFO:   Diagnostic flags:
[2025-11-19 18:06:59] INFO:     - Ties (ambiguous): 2
[2025-11-19 18:06:59] INFO:     - Low confidence: 2
[2025-11-19 18:06:59] INFO: ======================================================================
[2025-11-19 18:06:59] INFO:   ✓ Assigned 579/617 samples to genotypes
[2025-11-19 18:06:59] INFO:   ✓ Assignment rate: 93.8%
[2025-11-19 18:06:59] INFO: 
[2025-11-19 18:06:59] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:06:59] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:06:59] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:06:59] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 18:06:59] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:06:59] INFO: 
[2025-11-19 18:06:59] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:06:59] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:06:59] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:06:59] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:07:00] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:07:00] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:07:00] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:07:00] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:07:00] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:07:00] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:07:00] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 18:07:00] INFO: Created 6 base name mappings
[2025-11-19 18:07:00] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:07:00] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:07:00] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:07:00] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:07:00] INFO: 
[2025-11-19 18:07:00] INFO: PHASE 6: Visualization
[2025-11-19 18:07:00] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:07:00] INFO: 6.1: Generating plots...
[2025-11-19 18:07:01] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:07:02] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:07:02] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:07:02] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:07:02] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:07:02] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:07:08] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:07:09] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:07:10] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:07:10] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:07:10] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:07:10] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:07:10] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:07:10] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:07:12] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:07:12] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:07:12] INFO:   ✓ Generated visualization plots
[2025-11-19 18:07:12] INFO: 
[2025-11-19 18:07:12] INFO: PHASE 7: Generating Reports
[2025-11-19 18:07:12] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:07:12] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:07:12] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:07:12] INFO: 
[2025-11-19 18:07:12] INFO: Cleaning up empty directories...
[2025-11-19 18:07:12] INFO:   ✓ Removed empty directories
[2025-11-19 18:07:12] INFO: 
[2025-11-19 18:07:12] INFO: Generating HTML summary report...
[2025-11-19 18:07:12] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:07:12] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:07:12] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:07:12] INFO: 
[2025-11-19 18:07:12] INFO: ================================================================================
[2025-11-19 18:07:12] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:07:12] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:07:12] INFO:   Key files:
[2025-11-19 18:07:12] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:07:12] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:07:12] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:07:12] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:07:12] INFO: ================================================================================
[2025-11-19 18:08:45] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:08:45] INFO: ================================================================================
[2025-11-19 18:08:45] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:08:45] INFO: ================================================================================
[2025-11-19 18:08:45] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:08:45] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:08:45] INFO: 
[2025-11-19 18:08:45] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:08:45] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:08:45] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:08:45] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:08:45] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:08:45] INFO: Read 685 rows and 88 columns
[2025-11-19 18:08:45] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:08:45] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:08:45] INFO: Data quality summary:
[2025-11-19 18:08:45] INFO:   total_rows: 675
[2025-11-19 18:08:45] INFO:   total_columns: 88
[2025-11-19 18:08:45] INFO:   unique_processids: 675
[2025-11-19 18:08:45] INFO:   sequences_present: 674
[2025-11-19 18:08:45] INFO:   sequences_missing: 1
[2025-11-19 18:08:45] INFO:   empty_sequences: 0
[2025-11-19 18:08:45] INFO:   coords_present: 229
[2025-11-19 18:08:45] INFO:   coords_missing: 446
[2025-11-19 18:08:45] INFO:   centroid_coords: 58
[2025-11-19 18:08:45] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:08:45] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:08:45] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:08:45] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:08:45] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:08:45] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:08:45] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:09:09] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:09:09] INFO: Creating point geometries from coordinates
[2025-11-19 18:09:09] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:09:09] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:09:09] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:09:09] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:09:09] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:09:09] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:09:09] INFO: 
[2025-11-19 18:09:09] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:09:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:09] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:09:09] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:09:09] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:09:09] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:09:09] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:09:09] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:09:15] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:09:15] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:09:16] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:09:16] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:09:16] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:09:34] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:09:34] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-19 18:09:34] INFO: Clustering complete: 4 clusters formed
[2025-11-19 18:09:34] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:09:34] INFO:   ✓ Identified 4 unique genotypes
[2025-11-19 18:09:34] INFO: 
[2025-11-19 18:09:34] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:09:34] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:34] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:09:34] INFO: ======================================================================
[2025-11-19 18:09:34] INFO: Starting genotype assignment workflow
[2025-11-19 18:09:34] INFO: ======================================================================
[2025-11-19 18:09:34] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:09:34] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:09:34] INFO: Loaded 617 samples from metadata
[2025-11-19 18:09:34] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:09:34] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:09:34] INFO: Loaded 4 consensus groups
[2025-11-19 18:09:34] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:09:34] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:09:34] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:09:34] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:09:34] INFO: Prepared 617 assignment tasks
[2025-11-19 18:09:34] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:09:34] INFO: Identity calculation method: target_based
[2025-11-19 18:09:34] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:09:37] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:09:37] INFO: Step 6/6: Writing outputs
[2025-11-19 18:09:37] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:09:37] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:09:37] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:09:38] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:09:38] INFO: ======================================================================
[2025-11-19 18:09:38] INFO: Genotype assignment summary:
[2025-11-19 18:09:38] INFO:   Total samples: 617
[2025-11-19 18:09:38] INFO:   Successfully assigned: 569 (92.2%)
[2025-11-19 18:09:38] INFO:   Unassigned: 48 (7.8%)
[2025-11-19 18:09:38] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:09:38] INFO:     - Below identity threshold: 29
[2025-11-19 18:09:38] INFO:   Diagnostic flags:
[2025-11-19 18:09:38] INFO:     - Ties (ambiguous): 0
[2025-11-19 18:09:38] INFO:     - Low confidence: 9
[2025-11-19 18:09:38] INFO: ======================================================================
[2025-11-19 18:09:38] INFO:   ✓ Assigned 569/617 samples to genotypes
[2025-11-19 18:09:38] INFO:   ✓ Assignment rate: 92.2%
[2025-11-19 18:09:38] INFO: 
[2025-11-19 18:09:38] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:09:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:38] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:09:38] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-19 18:09:38] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:09:38] INFO: 
[2025-11-19 18:09:38] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:09:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:38] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:09:38] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:09:39] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:09:39] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:09:39] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:09:39] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:09:39] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:09:39] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:09:39] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-19 18:09:39] INFO: Created 4 base name mappings
[2025-11-19 18:09:39] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:09:39] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:09:39] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:09:39] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:09:39] INFO: 
[2025-11-19 18:09:39] INFO: PHASE 6: Visualization
[2025-11-19 18:09:39] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:39] INFO: 6.1: Generating plots...
[2025-11-19 18:09:40] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:09:40] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:09:41] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:09:41] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:09:41] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 18:09:41] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:09:45] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:09:46] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:09:46] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:09:46] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:09:47] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:09:47] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:09:47] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-19 18:09:47] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:09:48] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:09:48] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:09:48] INFO:   ✓ Generated visualization plots
[2025-11-19 18:09:48] INFO: 
[2025-11-19 18:09:48] INFO: PHASE 7: Generating Reports
[2025-11-19 18:09:48] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:09:48] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:09:48] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:09:48] INFO: 
[2025-11-19 18:09:48] INFO: Cleaning up empty directories...
[2025-11-19 18:09:48] INFO:   ✓ Removed empty directories
[2025-11-19 18:09:48] INFO: 
[2025-11-19 18:09:48] INFO: Generating HTML summary report...
[2025-11-19 18:09:48] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:09:48] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:09:48] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:09:48] INFO: 
[2025-11-19 18:09:48] INFO: ================================================================================
[2025-11-19 18:09:48] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:09:48] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:09:48] INFO:   Key files:
[2025-11-19 18:09:48] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:09:48] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:09:48] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:09:48] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:09:48] INFO: ================================================================================
[2025-11-19 18:13:02] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:13:02] INFO: ================================================================================
[2025-11-19 18:13:02] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:13:02] INFO: ================================================================================
[2025-11-19 18:13:02] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:13:02] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:13:02] INFO: 
[2025-11-19 18:13:02] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:13:02] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:13:02] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:02] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:13:02] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:13:02] INFO: Read 685 rows and 88 columns
[2025-11-19 18:13:02] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:13:02] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:13:03] INFO: Data quality summary:
[2025-11-19 18:13:03] INFO:   total_rows: 675
[2025-11-19 18:13:03] INFO:   total_columns: 88
[2025-11-19 18:13:03] INFO:   unique_processids: 675
[2025-11-19 18:13:03] INFO:   sequences_present: 674
[2025-11-19 18:13:03] INFO:   sequences_missing: 1
[2025-11-19 18:13:03] INFO:   empty_sequences: 0
[2025-11-19 18:13:03] INFO:   coords_present: 229
[2025-11-19 18:13:03] INFO:   coords_missing: 446
[2025-11-19 18:13:03] INFO:   centroid_coords: 58
[2025-11-19 18:13:03] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:13:03] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:13:03] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:13:03] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:13:03] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:13:03] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:13:03] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:13:27] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:13:27] INFO: Creating point geometries from coordinates
[2025-11-19 18:13:27] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:13:27] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:13:27] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:13:27] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:13:27] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:13:27] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:13:27] INFO: 
[2025-11-19 18:13:27] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:13:27] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:27] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:13:27] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:13:27] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:13:27] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:13:27] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:13:27] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:13:33] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:13:33] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:13:34] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:13:34] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:13:34] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:13:52] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:13:52] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 18:13:52] INFO: Clustering complete: 6 clusters formed
[2025-11-19 18:13:52] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:13:52] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 18:13:52] INFO: 
[2025-11-19 18:13:52] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:13:52] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:52] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:13:52] INFO: ======================================================================
[2025-11-19 18:13:52] INFO: Starting genotype assignment workflow
[2025-11-19 18:13:52] INFO: ======================================================================
[2025-11-19 18:13:52] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:13:52] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:13:52] INFO: Loaded 617 samples from metadata
[2025-11-19 18:13:52] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:13:52] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:13:52] INFO: Loaded 6 consensus groups
[2025-11-19 18:13:52] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:13:52] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:13:52] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:13:52] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:13:52] INFO: Prepared 617 assignment tasks
[2025-11-19 18:13:52] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:13:52] INFO: Identity calculation method: target_based
[2025-11-19 18:13:52] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:13:55] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:13:55] INFO: Step 6/6: Writing outputs
[2025-11-19 18:13:55] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:13:55] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:13:55] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:13:55] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:13:55] INFO: ======================================================================
[2025-11-19 18:13:55] INFO: Genotype assignment summary:
[2025-11-19 18:13:55] INFO:   Total samples: 617
[2025-11-19 18:13:55] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 18:13:55] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 18:13:55] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:13:55] INFO:     - Below identity threshold: 3
[2025-11-19 18:13:55] INFO:   Diagnostic flags:
[2025-11-19 18:13:55] INFO:     - Ties (ambiguous): 2
[2025-11-19 18:13:55] INFO:     - Low confidence: 0
[2025-11-19 18:13:55] INFO: ======================================================================
[2025-11-19 18:13:55] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 18:13:55] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 18:13:55] INFO: 
[2025-11-19 18:13:55] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:13:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:55] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:13:55] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 18:13:55] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:13:55] INFO: 
[2025-11-19 18:13:55] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:13:55] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:55] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:13:55] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:13:56] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:13:56] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:13:57] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:13:57] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:13:57] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:13:57] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:13:57] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 18:13:57] INFO: Created 6 base name mappings
[2025-11-19 18:13:57] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:13:57] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:13:57] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:13:57] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:13:57] INFO: 
[2025-11-19 18:13:57] INFO: PHASE 6: Visualization
[2025-11-19 18:13:57] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:13:57] INFO: 6.1: Generating plots...
[2025-11-19 18:13:58] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:13:59] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:13:59] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:13:59] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:13:59] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:14:00] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:14:05] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:14:06] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:14:06] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:14:07] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:14:07] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:14:07] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:14:07] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:14:07] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:14:08] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:14:09] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:14:09] INFO:   ✓ Generated visualization plots
[2025-11-19 18:14:09] INFO: 
[2025-11-19 18:14:09] INFO: PHASE 7: Generating Reports
[2025-11-19 18:14:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:14:09] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:14:09] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:14:09] INFO: 
[2025-11-19 18:14:09] INFO: Cleaning up empty directories...
[2025-11-19 18:14:09] INFO:   ✓ Removed empty directories
[2025-11-19 18:14:09] INFO: 
[2025-11-19 18:14:09] INFO: Generating HTML summary report...
[2025-11-19 18:14:09] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:14:09] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:14:09] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:14:09] INFO: 
[2025-11-19 18:14:09] INFO: ================================================================================
[2025-11-19 18:14:09] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:14:09] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:14:09] INFO:   Key files:
[2025-11-19 18:14:09] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:14:09] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:14:09] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:14:09] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:14:09] INFO: ================================================================================
[2025-11-19 18:31:38] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:31:38] INFO: ================================================================================
[2025-11-19 18:31:38] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:31:38] INFO: ================================================================================
[2025-11-19 18:31:38] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:31:38] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:31:38] INFO: 
[2025-11-19 18:31:38] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:31:38] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:31:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:31:38] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:31:38] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:31:38] INFO: Read 685 rows and 88 columns
[2025-11-19 18:31:38] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:31:38] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:31:38] INFO: Data quality summary:
[2025-11-19 18:31:38] INFO:   total_rows: 675
[2025-11-19 18:31:38] INFO:   total_columns: 88
[2025-11-19 18:31:38] INFO:   unique_processids: 675
[2025-11-19 18:31:38] INFO:   sequences_present: 674
[2025-11-19 18:31:38] INFO:   sequences_missing: 1
[2025-11-19 18:31:38] INFO:   empty_sequences: 0
[2025-11-19 18:31:38] INFO:   coords_present: 229
[2025-11-19 18:31:38] INFO:   coords_missing: 446
[2025-11-19 18:31:38] INFO:   centroid_coords: 58
[2025-11-19 18:31:38] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:31:38] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:31:38] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:31:38] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:31:38] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:31:38] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:31:38] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:32:01] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:32:01] INFO: Creating point geometries from coordinates
[2025-11-19 18:32:01] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:32:01] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:32:02] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:32:02] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:32:02] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:32:02] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:32:02] INFO: 
[2025-11-19 18:32:02] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:32:02] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:02] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:32:02] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:32:02] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:32:02] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:32:02] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:32:02] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:32:07] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:32:07] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:32:09] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:32:09] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:32:09] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:32:26] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:32:26] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 18:32:26] INFO: Clustering complete: 6 clusters formed
[2025-11-19 18:32:27] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:32:27] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 18:32:27] INFO: 
[2025-11-19 18:32:27] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:32:27] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:27] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:32:27] INFO: ======================================================================
[2025-11-19 18:32:27] INFO: Starting genotype assignment workflow
[2025-11-19 18:32:27] INFO: ======================================================================
[2025-11-19 18:32:27] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:32:27] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:32:27] INFO: Loaded 617 samples from metadata
[2025-11-19 18:32:27] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:32:27] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:32:27] INFO: Loaded 6 consensus groups
[2025-11-19 18:32:27] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:32:27] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:32:27] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:32:27] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:32:27] INFO: Prepared 617 assignment tasks
[2025-11-19 18:32:27] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:32:27] INFO: Identity calculation method: target_based
[2025-11-19 18:32:27] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:32:30] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:32:30] INFO: Step 6/6: Writing outputs
[2025-11-19 18:32:30] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:32:30] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:32:30] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:32:30] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:32:30] INFO: ======================================================================
[2025-11-19 18:32:30] INFO: Genotype assignment summary:
[2025-11-19 18:32:30] INFO:   Total samples: 617
[2025-11-19 18:32:30] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 18:32:30] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 18:32:30] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:32:30] INFO:     - Below identity threshold: 3
[2025-11-19 18:32:30] INFO:   Diagnostic flags:
[2025-11-19 18:32:30] INFO:     - Ties (ambiguous): 2
[2025-11-19 18:32:30] INFO:     - Low confidence: 0
[2025-11-19 18:32:30] INFO: ======================================================================
[2025-11-19 18:32:30] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 18:32:30] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 18:32:30] INFO: 
[2025-11-19 18:32:30] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:32:30] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:30] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:32:31] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 18:32:31] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:32:31] INFO: 
[2025-11-19 18:32:31] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:32:31] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:31] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:32:31] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:32:32] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:32:32] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:32:32] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:32:32] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:32:32] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:32:32] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:32:32] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 18:32:32] INFO: Created 6 base name mappings
[2025-11-19 18:32:32] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:32:32] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:32:32] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:32:32] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:32:32] INFO: 
[2025-11-19 18:32:32] INFO: PHASE 6: Visualization
[2025-11-19 18:32:32] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:32] INFO: 6.1: Generating plots...
[2025-11-19 18:32:33] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:32:33] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:32:34] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:32:34] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:32:34] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:32:34] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:32:34] WARNING: Faceted distribution map generation failed: PathCollection.set() got an unexpected keyword argument 'markeredgecolor'
Traceback (most recent call last):
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/cli.py", line 543, in run_pipeline
    visualization.plot_distribution_map_faceted(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        df=df_final,
        ^^^^^^^^^^^^
    ...<8 lines>...
        show_scale_bar=cfg.visualization.show_scale_bar
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/visualization.py", line 755, in plot_distribution_map_faceted
    ax.scatter(
    ~~~~~~~~~~^
        sub[longitude_col], sub[latitude_col],
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
        label=str(g) if facet_by == "species" else None
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 291, in wrapper
    return func(self, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 1677, in scatter
    result = super().scatter(*args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/_api/deprecation.py", line 453, in wrapper
    return func(*args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/__init__.py", line 1524, in inner
    return func(
        ax,
        *map(cbook.sanitize_sequence, args),
        **{k: cbook.sanitize_sequence(v) for k, v in kwargs.items()})
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/axes/_axes.py", line 5055, in scatter
    collection._internal_update(kwargs)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 1233, in _internal_update
    return self._update_props(
           ~~~~~~~~~~~~~~~~~~^
        kwargs, "{cls.__name__}.set() got an unexpected keyword argument "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        "{prop_name!r}")
        ^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 1206, in _update_props
    raise AttributeError(
        errfmt.format(cls=type(self), prop_name=k),
        name=k)
AttributeError: PathCollection.set() got an unexpected keyword argument 'markeredgecolor'
[2025-11-19 18:32:35] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:32:36] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:32:36] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:32:36] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:32:36] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:32:36] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:32:36] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:32:36] WARNING: Faceted distribution map generation failed: PathCollection.set() got an unexpected keyword argument 'markeredgecolor'
Traceback (most recent call last):
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/cli.py", line 543, in run_pipeline
    visualization.plot_distribution_map_faceted(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        df=df_final,
        ^^^^^^^^^^^^
    ...<8 lines>...
        show_scale_bar=cfg.visualization.show_scale_bar
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/visualization.py", line 755, in plot_distribution_map_faceted
    ax.scatter(
    ~~~~~~~~~~^
        sub[longitude_col], sub[latitude_col],
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
        label=str(g) if facet_by == "species" else None
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 291, in wrapper
    return func(self, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 1677, in scatter
    result = super().scatter(*args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/_api/deprecation.py", line 453, in wrapper
    return func(*args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/__init__.py", line 1524, in inner
    return func(
        ax,
        *map(cbook.sanitize_sequence, args),
        **{k: cbook.sanitize_sequence(v) for k, v in kwargs.items()})
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/axes/_axes.py", line 5055, in scatter
    collection._internal_update(kwargs)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 1233, in _internal_update
    return self._update_props(
           ~~~~~~~~~~~~~~~~~~^
        kwargs, "{cls.__name__}.set() got an unexpected keyword argument "
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        "{prop_name!r}")
        ^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 1206, in _update_props
    raise AttributeError(
        errfmt.format(cls=type(self), prop_name=k),
        name=k)
AttributeError: PathCollection.set() got an unexpected keyword argument 'markeredgecolor'
[2025-11-19 18:32:36] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:32:36] INFO:   ✓ Generated visualization plots
[2025-11-19 18:32:36] INFO: 
[2025-11-19 18:32:36] INFO: PHASE 7: Generating Reports
[2025-11-19 18:32:36] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:32:36] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:32:36] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:32:36] INFO: 
[2025-11-19 18:32:36] INFO: Cleaning up empty directories...
[2025-11-19 18:32:36] INFO:   ✓ Removed empty directories
[2025-11-19 18:32:36] INFO: 
[2025-11-19 18:32:36] INFO: Generating HTML summary report...
[2025-11-19 18:32:36] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:32:37] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:32:37] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:32:37] INFO: 
[2025-11-19 18:32:37] INFO: ================================================================================
[2025-11-19 18:32:37] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:32:37] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:32:37] INFO:   Key files:
[2025-11-19 18:32:37] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:32:37] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:32:37] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:32:37] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:32:37] INFO: ================================================================================
[2025-11-19 18:34:11] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:34:11] INFO: ================================================================================
[2025-11-19 18:34:11] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:34:11] INFO: ================================================================================
[2025-11-19 18:34:11] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:34:11] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:34:11] INFO: 
[2025-11-19 18:34:11] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:34:11] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:34:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:34:11] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:34:11] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:34:11] INFO: Read 685 rows and 88 columns
[2025-11-19 18:34:11] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:34:11] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:34:11] INFO: Data quality summary:
[2025-11-19 18:34:11] INFO:   total_rows: 675
[2025-11-19 18:34:11] INFO:   total_columns: 88
[2025-11-19 18:34:11] INFO:   unique_processids: 675
[2025-11-19 18:34:11] INFO:   sequences_present: 674
[2025-11-19 18:34:11] INFO:   sequences_missing: 1
[2025-11-19 18:34:11] INFO:   empty_sequences: 0
[2025-11-19 18:34:11] INFO:   coords_present: 229
[2025-11-19 18:34:11] INFO:   coords_missing: 446
[2025-11-19 18:34:11] INFO:   centroid_coords: 58
[2025-11-19 18:34:11] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:34:11] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:34:11] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:34:11] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:34:11] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:34:11] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:34:11] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:34:35] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:34:35] INFO: Creating point geometries from coordinates
[2025-11-19 18:34:35] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:34:35] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:34:35] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:34:35] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:34:35] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:34:35] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:34:35] INFO: 
[2025-11-19 18:34:35] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:34:35] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:34:35] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:34:35] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:34:36] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:34:36] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:34:36] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:34:36] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:34:41] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:34:41] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:34:42] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:34:42] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:34:42] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:35:00] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:35:00] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 18:35:00] INFO: Clustering complete: 6 clusters formed
[2025-11-19 18:35:01] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:35:01] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 18:35:01] INFO: 
[2025-11-19 18:35:01] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:35:01] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:01] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:35:01] INFO: ======================================================================
[2025-11-19 18:35:01] INFO: Starting genotype assignment workflow
[2025-11-19 18:35:01] INFO: ======================================================================
[2025-11-19 18:35:01] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:35:01] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:35:01] INFO: Loaded 617 samples from metadata
[2025-11-19 18:35:01] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:35:01] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:35:01] INFO: Loaded 6 consensus groups
[2025-11-19 18:35:01] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:35:01] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:35:01] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:35:01] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:35:01] INFO: Prepared 617 assignment tasks
[2025-11-19 18:35:01] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:35:01] INFO: Identity calculation method: target_based
[2025-11-19 18:35:01] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:35:04] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:35:04] INFO: Step 6/6: Writing outputs
[2025-11-19 18:35:04] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:35:04] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:35:04] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:35:04] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:35:04] INFO: ======================================================================
[2025-11-19 18:35:04] INFO: Genotype assignment summary:
[2025-11-19 18:35:04] INFO:   Total samples: 617
[2025-11-19 18:35:04] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 18:35:04] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 18:35:04] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:35:04] INFO:     - Below identity threshold: 3
[2025-11-19 18:35:04] INFO:   Diagnostic flags:
[2025-11-19 18:35:04] INFO:     - Ties (ambiguous): 2
[2025-11-19 18:35:04] INFO:     - Low confidence: 0
[2025-11-19 18:35:04] INFO: ======================================================================
[2025-11-19 18:35:04] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 18:35:04] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 18:35:04] INFO: 
[2025-11-19 18:35:04] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:35:04] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:04] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:35:04] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 18:35:04] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:35:04] INFO: 
[2025-11-19 18:35:04] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:35:04] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:04] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:35:04] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:35:05] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:35:05] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:35:05] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:35:05] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:35:05] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:35:05] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:35:05] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 18:35:05] INFO: Created 6 base name mappings
[2025-11-19 18:35:05] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:35:05] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:35:05] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:35:05] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:35:05] INFO: 
[2025-11-19 18:35:05] INFO: PHASE 6: Visualization
[2025-11-19 18:35:05] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:05] INFO: 6.1: Generating plots...
[2025-11-19 18:35:07] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:35:07] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:35:08] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:35:08] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:35:08] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:35:08] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:35:13] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:35:14] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:35:15] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:35:15] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:35:15] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:35:15] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:35:15] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:35:15] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:35:17] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:35:17] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:35:17] INFO:   ✓ Generated visualization plots
[2025-11-19 18:35:17] INFO: 
[2025-11-19 18:35:17] INFO: PHASE 7: Generating Reports
[2025-11-19 18:35:17] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:17] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:35:17] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:35:17] INFO: 
[2025-11-19 18:35:17] INFO: Cleaning up empty directories...
[2025-11-19 18:35:17] INFO:   ✓ Removed empty directories
[2025-11-19 18:35:17] INFO: 
[2025-11-19 18:35:17] INFO: Generating HTML summary report...
[2025-11-19 18:35:17] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:35:17] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:35:17] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:35:17] INFO: 
[2025-11-19 18:35:17] INFO: ================================================================================
[2025-11-19 18:35:17] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:35:17] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:35:17] INFO:   Key files:
[2025-11-19 18:35:17] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:35:17] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:35:17] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:35:17] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:35:17] INFO: ================================================================================
[2025-11-19 18:35:21] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 18:35:21] INFO: ================================================================================
[2025-11-19 18:35:21] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 18:35:21] INFO: ================================================================================
[2025-11-19 18:35:21] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:35:21] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:35:21] INFO: 
[2025-11-19 18:35:21] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 18:35:21] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 18:35:21] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:21] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 18:35:21] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 18:35:22] INFO: Read 685 rows and 88 columns
[2025-11-19 18:35:22] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 18:35:22] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 18:35:22] INFO: Data quality summary:
[2025-11-19 18:35:22] INFO:   total_rows: 675
[2025-11-19 18:35:22] INFO:   total_columns: 88
[2025-11-19 18:35:22] INFO:   unique_processids: 675
[2025-11-19 18:35:22] INFO:   sequences_present: 674
[2025-11-19 18:35:22] INFO:   sequences_missing: 1
[2025-11-19 18:35:22] INFO:   empty_sequences: 0
[2025-11-19 18:35:22] INFO:   coords_present: 229
[2025-11-19 18:35:22] INFO:   coords_missing: 446
[2025-11-19 18:35:22] INFO:   centroid_coords: 58
[2025-11-19 18:35:22] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 18:35:22] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 18:35:22] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 18:35:22] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 18:35:22] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 18:35:22] INFO: 1.3: Assigning ocean basins...
[2025-11-19 18:35:22] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 18:35:45] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 18:35:45] INFO: Creating point geometries from coordinates
[2025-11-19 18:35:45] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 18:35:45] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 18:35:46] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 18:35:46] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 18:35:46] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 18:35:46] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 18:35:46] INFO: 
[2025-11-19 18:35:46] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 18:35:46] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:35:46] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 18:35:46] INFO:   Minimum sequence length: 400 bp
[2025-11-19 18:35:46] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 18:35:46] INFO:   ✓ Created 598 FASTA records
[2025-11-19 18:35:46] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 18:35:46] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:35:51] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:35:51] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 18:35:53] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 18:35:53] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 18:35:53] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 18:36:10] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 18:36:10] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 18:36:10] INFO: Clustering complete: 6 clusters formed
[2025-11-19 18:36:10] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 18:36:10] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 18:36:10] INFO: 
[2025-11-19 18:36:10] INFO: PHASE 3: Genotype Assignment
[2025-11-19 18:36:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:36:10] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 18:36:10] INFO: ======================================================================
[2025-11-19 18:36:10] INFO: Starting genotype assignment workflow
[2025-11-19 18:36:10] INFO: ======================================================================
[2025-11-19 18:36:10] INFO: Using edlib for fast edit distance calculation
[2025-11-19 18:36:10] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 18:36:10] INFO: Loaded 617 samples from metadata
[2025-11-19 18:36:10] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:36:10] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:36:10] INFO: Loaded 6 consensus groups
[2025-11-19 18:36:10] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:36:10] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 18:36:10] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 18:36:10] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 18:36:10] INFO: Prepared 617 assignment tasks
[2025-11-19 18:36:10] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 18:36:10] INFO: Identity calculation method: target_based
[2025-11-19 18:36:10] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 18:36:13] INFO: Completed genotype assignment for 617 samples
[2025-11-19 18:36:13] INFO: Step 6/6: Writing outputs
[2025-11-19 18:36:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:36:13] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 18:36:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 18:36:13] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 18:36:13] INFO: ======================================================================
[2025-11-19 18:36:13] INFO: Genotype assignment summary:
[2025-11-19 18:36:13] INFO:   Total samples: 617
[2025-11-19 18:36:13] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 18:36:13] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 18:36:13] INFO:     - No sequence in FASTA: 19
[2025-11-19 18:36:13] INFO:     - Below identity threshold: 3
[2025-11-19 18:36:13] INFO:   Diagnostic flags:
[2025-11-19 18:36:13] INFO:     - Ties (ambiguous): 2
[2025-11-19 18:36:13] INFO:     - Low confidence: 0
[2025-11-19 18:36:13] INFO: ======================================================================
[2025-11-19 18:36:13] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 18:36:13] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 18:36:13] INFO: 
[2025-11-19 18:36:13] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 18:36:13] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:36:13] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 18:36:13] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 18:36:13] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:36:13] INFO: 
[2025-11-19 18:36:13] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 18:36:13] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:36:13] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 18:36:13] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:36:14] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:36:14] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 18:36:14] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:36:14] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:36:14] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 18:36:14] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 18:36:14] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 18:36:14] INFO: Created 6 base name mappings
[2025-11-19 18:36:14] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:36:14] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:36:14] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:36:14] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 18:36:14] INFO: 
[2025-11-19 18:36:14] INFO: PHASE 6: Visualization
[2025-11-19 18:36:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:36:14] INFO: 6.1: Generating plots...
[2025-11-19 18:36:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 18:36:16] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 18:36:17] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 18:36:17] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:36:17] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:36:17] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:36:22] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 18:36:23] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 18:36:24] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 18:36:24] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 18:36:24] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 18:36:24] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 18:36:24] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 18:36:24] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 18:36:25] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 18:36:26] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 18:36:26] INFO:   ✓ Generated visualization plots
[2025-11-19 18:36:26] INFO: 
[2025-11-19 18:36:26] INFO: PHASE 7: Generating Reports
[2025-11-19 18:36:26] INFO: --------------------------------------------------------------------------------
[2025-11-19 18:36:26] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:36:26] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 18:36:26] INFO: 
[2025-11-19 18:36:26] INFO: Cleaning up empty directories...
[2025-11-19 18:36:26] INFO:   ✓ Removed empty directories
[2025-11-19 18:36:26] INFO: 
[2025-11-19 18:36:26] INFO: Generating HTML summary report...
[2025-11-19 18:36:26] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 18:36:26] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:36:26] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:36:26] INFO: 
[2025-11-19 18:36:26] INFO: ================================================================================
[2025-11-19 18:36:26] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 18:36:26] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 18:36:26] INFO:   Key files:
[2025-11-19 18:36:26] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 18:36:26] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 18:36:26] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 18:36:26] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 18:36:26] INFO: ================================================================================
[2025-11-19 19:05:25] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:05:25] INFO: ================================================================================
[2025-11-19 19:05:25] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:05:25] INFO: ================================================================================
[2025-11-19 19:05:25] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:05:25] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:05:25] INFO: 
[2025-11-19 19:05:25] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:05:25] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:05:25] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:05:25] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:05:25] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:05:25] INFO: Read 685 rows and 88 columns
[2025-11-19 19:05:25] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:05:25] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:05:25] INFO: Data quality summary:
[2025-11-19 19:05:25] INFO:   total_rows: 675
[2025-11-19 19:05:25] INFO:   total_columns: 88
[2025-11-19 19:05:25] INFO:   unique_processids: 675
[2025-11-19 19:05:25] INFO:   sequences_present: 674
[2025-11-19 19:05:25] INFO:   sequences_missing: 1
[2025-11-19 19:05:25] INFO:   empty_sequences: 0
[2025-11-19 19:05:25] INFO:   coords_present: 229
[2025-11-19 19:05:25] INFO:   coords_missing: 446
[2025-11-19 19:05:25] INFO:   centroid_coords: 58
[2025-11-19 19:05:25] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:05:25] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:05:25] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:05:25] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:05:25] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:05:25] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:05:25] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:05:48] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:05:48] INFO: Creating point geometries from coordinates
[2025-11-19 19:05:48] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:05:48] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:05:49] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:05:49] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:05:49] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:05:49] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:05:49] INFO: 
[2025-11-19 19:05:49] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:05:49] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:05:49] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:05:49] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:05:49] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:05:49] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:05:49] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:05:49] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:05:54] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:05:54] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:05:56] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:05:56] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:05:56] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:06:14] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:06:14] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:06:14] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:06:14] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:06:14] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:06:14] INFO: 
[2025-11-19 19:06:14] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:06:14] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:06:14] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:06:14] INFO: ======================================================================
[2025-11-19 19:06:14] INFO: Starting genotype assignment workflow
[2025-11-19 19:06:14] INFO: ======================================================================
[2025-11-19 19:06:14] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:06:14] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:06:14] INFO: Loaded 617 samples from metadata
[2025-11-19 19:06:14] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:06:14] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:06:14] INFO: Loaded 6 consensus groups
[2025-11-19 19:06:14] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:06:14] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:06:14] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:06:14] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:06:14] INFO: Prepared 617 assignment tasks
[2025-11-19 19:06:14] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:06:14] INFO: Identity calculation method: target_based
[2025-11-19 19:06:14] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:06:18] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:06:18] INFO: Step 6/6: Writing outputs
[2025-11-19 19:06:18] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:06:18] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:06:18] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:06:18] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:06:18] INFO: ======================================================================
[2025-11-19 19:06:18] INFO: Genotype assignment summary:
[2025-11-19 19:06:18] INFO:   Total samples: 617
[2025-11-19 19:06:18] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:06:18] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:06:18] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:06:18] INFO:     - Below identity threshold: 3
[2025-11-19 19:06:18] INFO:   Diagnostic flags:
[2025-11-19 19:06:18] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:06:18] INFO:     - Low confidence: 0
[2025-11-19 19:06:18] INFO: ======================================================================
[2025-11-19 19:06:18] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:06:18] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:06:18] INFO: 
[2025-11-19 19:06:18] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:06:18] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:06:18] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:06:18] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:06:18] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:06:18] INFO: 
[2025-11-19 19:06:18] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:06:18] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:06:18] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:06:18] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:06:19] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:06:19] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:06:19] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:06:19] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:06:19] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:06:19] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:06:19] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:06:19] INFO: Created 6 base name mappings
[2025-11-19 19:06:19] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:06:19] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:06:19] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:06:19] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:06:19] INFO: 
[2025-11-19 19:06:19] INFO: PHASE 6: Visualization
[2025-11-19 19:06:19] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:06:19] INFO: 6.1: Generating plots...
[2025-11-19 19:06:21] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:06:22] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:06:22] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:06:22] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:06:22] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:06:22] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:06:27] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:06:29] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:06:29] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:06:29] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:06:30] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:06:30] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:06:30] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:06:30] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:06:30] WARNING: Faceted distribution map generation failed: At least one value in the dash list must be positive
Traceback (most recent call last):
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/cli.py", line 543, in run_pipeline
    visualization.plot_distribution_map_faceted(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        df=df_final,
        ^^^^^^^^^^^^
    ...<8 lines>...
        show_scale_bar=cfg.visualization.show_scale_bar
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/visualization.py", line 868, in plot_distribution_map_faceted
    plt.savefig(out, bbox_inches="tight")
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/pyplot.py", line 1251, in savefig
    res = fig.savefig(*args, **kwargs)  # type: ignore[func-returns-value]
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/figure.py", line 3490, in savefig
    self.canvas.print_figure(fname, **kwargs)
    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 2186, in print_figure
    result = print_method(
        filename,
    ...<3 lines>...
        bbox_inches_restore=_bbox_inches_restore,
        **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 2042, in <lambda>
    print_method = functools.wraps(meth)(lambda *args, **kwargs: meth(
                                                                 ~~~~^
        *args, **{k: v for k, v in kwargs.items() if k not in skip}))
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backends/backend_pdf.py", line 2786, in print_pdf
    self.figure.draw(renderer)
    ~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 94, in draw_wrapper
    result = draw(artist, renderer, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/figure.py", line 3257, in draw
    mimage._draw_list_compositing_images(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        renderer, self, artists, self.suppressComposite)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/image.py", line 134, in _draw_list_compositing_images
    a.draw(renderer)
    ~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 509, in draw
    return super().draw(renderer=renderer, **kwargs)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/axes/_base.py", line 3226, in draw
    mimage._draw_list_compositing_images(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        renderer, self, artists, self.get_figure(root=True).suppressComposite)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/image.py", line 134, in _draw_list_compositing_images
    a.draw(renderer)
    ~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 38, in draw_wrapper
    return draw(artist, renderer, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/gridliner.py", line 1258, in draw
    c.draw(renderer=renderer)
    ~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/collections.py", line 430, in draw
    renderer.draw_path_collection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        gc, transform.frozen(), paths,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
        self._antialiaseds, self._urls,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        "screen")  # offset_position, kept for backcompat.
        ^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backends/backend_pdf.py", line 2071, in draw_path_collection
    return RendererBase.draw_path_collection(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, gc, master_transform, paths, all_transforms,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        offsets, offset_trans, facecolors, edgecolors,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        linewidths, linestyles, antialiaseds, urls,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        offset_position)
        ^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 236, in draw_path_collection
    for xo, yo, path_id, gc0, rgbFace in self._iter_collection(
                                         ~~~~~~~~~~~~~~~~~~~~~^
            gc, list(path_ids), offsets, offset_trans,
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            facecolors, edgecolors, linewidths, linestyles,
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            antialiaseds, urls, offset_position):
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 401, in _iter_collection
    gc0.set_dashes(*ls)
    ~~~~~~~~~~~~~~^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 879, in set_dashes
    raise ValueError(
        'At least one value in the dash list must be positive')
ValueError: At least one value in the dash list must be positive
[2025-11-19 19:06:31] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:06:31] INFO:   ✓ Generated visualization plots
[2025-11-19 19:06:31] INFO: 
[2025-11-19 19:06:31] INFO: PHASE 7: Generating Reports
[2025-11-19 19:06:31] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:06:31] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:06:31] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:06:31] INFO: 
[2025-11-19 19:06:31] INFO: Cleaning up empty directories...
[2025-11-19 19:06:31] INFO:   ✓ Removed empty directories
[2025-11-19 19:06:31] INFO: 
[2025-11-19 19:06:31] INFO: Generating HTML summary report...
[2025-11-19 19:06:31] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:06:31] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:06:31] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:06:31] INFO: 
[2025-11-19 19:06:31] INFO: ================================================================================
[2025-11-19 19:06:31] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:06:31] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:06:31] INFO:   Key files:
[2025-11-19 19:06:31] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:06:31] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:06:31] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:06:31] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:06:31] INFO: ================================================================================
[2025-11-19 19:19:16] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:19:16] INFO: ================================================================================
[2025-11-19 19:19:16] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:19:16] INFO: ================================================================================
[2025-11-19 19:19:16] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:19:16] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:19:16] INFO: 
[2025-11-19 19:19:16] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:19:16] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:19:16] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:19:16] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:19:16] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:19:16] INFO: Read 685 rows and 88 columns
[2025-11-19 19:19:16] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:19:16] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:19:16] INFO: Data quality summary:
[2025-11-19 19:19:16] INFO:   total_rows: 675
[2025-11-19 19:19:16] INFO:   total_columns: 88
[2025-11-19 19:19:16] INFO:   unique_processids: 675
[2025-11-19 19:19:16] INFO:   sequences_present: 674
[2025-11-19 19:19:16] INFO:   sequences_missing: 1
[2025-11-19 19:19:16] INFO:   empty_sequences: 0
[2025-11-19 19:19:16] INFO:   coords_present: 229
[2025-11-19 19:19:16] INFO:   coords_missing: 446
[2025-11-19 19:19:16] INFO:   centroid_coords: 58
[2025-11-19 19:19:16] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:19:16] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:19:16] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:19:16] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:19:16] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:19:16] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:19:16] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:19:40] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:19:40] INFO: Creating point geometries from coordinates
[2025-11-19 19:19:40] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:19:40] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:19:40] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:19:40] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:19:40] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:19:40] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:19:41] INFO: 
[2025-11-19 19:19:41] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:19:41] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:19:41] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:19:41] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:19:41] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:19:41] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:19:41] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:19:41] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:19:46] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:19:46] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:19:47] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:19:47] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:19:47] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:20:05] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:20:05] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:20:05] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:20:06] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:20:06] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:20:06] INFO: 
[2025-11-19 19:20:06] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:20:06] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:20:06] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:20:06] INFO: ======================================================================
[2025-11-19 19:20:06] INFO: Starting genotype assignment workflow
[2025-11-19 19:20:06] INFO: ======================================================================
[2025-11-19 19:20:06] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:20:06] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:20:06] INFO: Loaded 617 samples from metadata
[2025-11-19 19:20:06] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:20:06] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:20:06] INFO: Loaded 6 consensus groups
[2025-11-19 19:20:06] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:20:06] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:20:06] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:20:06] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:20:06] INFO: Prepared 617 assignment tasks
[2025-11-19 19:20:06] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:20:06] INFO: Identity calculation method: target_based
[2025-11-19 19:20:06] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:20:09] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:20:09] INFO: Step 6/6: Writing outputs
[2025-11-19 19:20:09] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:20:09] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:20:09] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:20:09] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:20:09] INFO: ======================================================================
[2025-11-19 19:20:09] INFO: Genotype assignment summary:
[2025-11-19 19:20:09] INFO:   Total samples: 617
[2025-11-19 19:20:09] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:20:09] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:20:09] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:20:09] INFO:     - Below identity threshold: 3
[2025-11-19 19:20:09] INFO:   Diagnostic flags:
[2025-11-19 19:20:09] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:20:09] INFO:     - Low confidence: 0
[2025-11-19 19:20:09] INFO: ======================================================================
[2025-11-19 19:20:09] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:20:09] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:20:09] INFO: 
[2025-11-19 19:20:09] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:20:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:20:09] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:20:09] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:20:09] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:20:09] INFO: 
[2025-11-19 19:20:09] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:20:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:20:09] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:20:09] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:20:10] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:20:10] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:20:10] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:20:10] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:20:10] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:20:10] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:20:10] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:20:10] INFO: Created 6 base name mappings
[2025-11-19 19:20:10] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:20:10] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:20:10] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:20:10] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:20:10] INFO: 
[2025-11-19 19:20:10] INFO: PHASE 6: Visualization
[2025-11-19 19:20:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:20:10] INFO: 6.1: Generating plots...
[2025-11-19 19:20:11] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:20:12] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:20:12] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:20:12] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:20:12] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:20:12] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:20:17] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:20:19] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:20:19] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:20:19] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:20:19] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:20:19] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:20:19] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:20:19] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:20:20] WARNING: Faceted distribution map generation failed: At least one value in the dash list must be positive
Traceback (most recent call last):
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/cli.py", line 543, in run_pipeline
    visualization.plot_distribution_map_faceted(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        df=df_final,
        ^^^^^^^^^^^^
    ...<8 lines>...
        show_scale_bar=cfg.visualization.show_scale_bar
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/stesmith/Documents/depredation/boldgenotyper/boldgenotyper/visualization.py", line 868, in plot_distribution_map_faceted
    plt.savefig(out, bbox_inches="tight")
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/pyplot.py", line 1251, in savefig
    res = fig.savefig(*args, **kwargs)  # type: ignore[func-returns-value]
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/figure.py", line 3490, in savefig
    self.canvas.print_figure(fname, **kwargs)
    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 2186, in print_figure
    result = print_method(
        filename,
    ...<3 lines>...
        bbox_inches_restore=_bbox_inches_restore,
        **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 2042, in <lambda>
    print_method = functools.wraps(meth)(lambda *args, **kwargs: meth(
                                                                 ~~~~^
        *args, **{k: v for k, v in kwargs.items() if k not in skip}))
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backends/backend_pdf.py", line 2786, in print_pdf
    self.figure.draw(renderer)
    ~~~~~~~~~~~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 94, in draw_wrapper
    result = draw(artist, renderer, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/figure.py", line 3257, in draw
    mimage._draw_list_compositing_images(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        renderer, self, artists, self.suppressComposite)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/image.py", line 134, in _draw_list_compositing_images
    a.draw(renderer)
    ~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/geoaxes.py", line 509, in draw
    return super().draw(renderer=renderer, **kwargs)
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/axes/_base.py", line 3226, in draw
    mimage._draw_list_compositing_images(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        renderer, self, artists, self.get_figure(root=True).suppressComposite)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/image.py", line 134, in _draw_list_compositing_images
    a.draw(renderer)
    ~~~~~~^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 38, in draw_wrapper
    return draw(artist, renderer, *args, **kwargs)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/cartopy/mpl/gridliner.py", line 1258, in draw
    c.draw(renderer=renderer)
    ~~~~~~^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/artist.py", line 71, in draw_wrapper
    return draw(artist, renderer)
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/collections.py", line 430, in draw
    renderer.draw_path_collection(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        gc, transform.frozen(), paths,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
        self._antialiaseds, self._urls,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        "screen")  # offset_position, kept for backcompat.
        ^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backends/backend_pdf.py", line 2071, in draw_path_collection
    return RendererBase.draw_path_collection(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, gc, master_transform, paths, all_transforms,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        offsets, offset_trans, facecolors, edgecolors,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        linewidths, linestyles, antialiaseds, urls,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        offset_position)
        ^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 236, in draw_path_collection
    for xo, yo, path_id, gc0, rgbFace in self._iter_collection(
                                         ~~~~~~~~~~~~~~~~~~~~~^
            gc, list(path_ids), offsets, offset_trans,
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            facecolors, edgecolors, linewidths, linestyles,
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            antialiaseds, urls, offset_position):
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 401, in _iter_collection
    gc0.set_dashes(*ls)
    ~~~~~~~~~~~~~~^^^^^
  File "/Users/stesmith/opt/anaconda3/envs/boldgenotyper/lib/python3.13/site-packages/matplotlib/backend_bases.py", line 879, in set_dashes
    raise ValueError(
        'At least one value in the dash list must be positive')
ValueError: At least one value in the dash list must be positive
[2025-11-19 19:20:20] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:20:20] INFO:   ✓ Generated visualization plots
[2025-11-19 19:20:20] INFO: 
[2025-11-19 19:20:20] INFO: PHASE 7: Generating Reports
[2025-11-19 19:20:20] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:20:21] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:20:21] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:20:21] INFO: 
[2025-11-19 19:20:21] INFO: Cleaning up empty directories...
[2025-11-19 19:20:21] INFO:   ✓ Removed empty directories
[2025-11-19 19:20:21] INFO: 
[2025-11-19 19:20:21] INFO: Generating HTML summary report...
[2025-11-19 19:20:21] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:20:21] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:20:21] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:20:21] INFO: 
[2025-11-19 19:20:21] INFO: ================================================================================
[2025-11-19 19:20:21] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:20:21] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:20:21] INFO:   Key files:
[2025-11-19 19:20:21] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:20:21] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:20:21] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:20:21] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:20:21] INFO: ================================================================================
[2025-11-19 19:26:16] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:26:16] INFO: ================================================================================
[2025-11-19 19:26:16] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:26:16] INFO: ================================================================================
[2025-11-19 19:26:16] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:26:16] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:26:16] INFO: 
[2025-11-19 19:26:16] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:26:16] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:26:16] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:26:16] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:26:16] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:26:16] INFO: Read 685 rows and 88 columns
[2025-11-19 19:26:16] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:26:16] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:26:16] INFO: Data quality summary:
[2025-11-19 19:26:16] INFO:   total_rows: 675
[2025-11-19 19:26:16] INFO:   total_columns: 88
[2025-11-19 19:26:16] INFO:   unique_processids: 675
[2025-11-19 19:26:16] INFO:   sequences_present: 674
[2025-11-19 19:26:16] INFO:   sequences_missing: 1
[2025-11-19 19:26:16] INFO:   empty_sequences: 0
[2025-11-19 19:26:16] INFO:   coords_present: 229
[2025-11-19 19:26:16] INFO:   coords_missing: 446
[2025-11-19 19:26:16] INFO:   centroid_coords: 58
[2025-11-19 19:26:16] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:26:16] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:26:16] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:26:16] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:26:16] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:26:16] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:26:16] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:26:40] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:26:40] INFO: Creating point geometries from coordinates
[2025-11-19 19:26:40] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:26:40] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:26:40] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:26:40] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:26:40] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:26:40] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:26:40] INFO: 
[2025-11-19 19:26:40] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:26:40] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:26:40] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:26:40] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:26:40] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:26:40] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:26:40] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:26:40] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:26:45] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:26:45] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:26:47] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:26:47] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:26:47] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:27:05] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:27:05] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:27:05] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:27:06] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:27:06] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:27:06] INFO: 
[2025-11-19 19:27:06] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:27:06] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:27:06] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:27:06] INFO: ======================================================================
[2025-11-19 19:27:06] INFO: Starting genotype assignment workflow
[2025-11-19 19:27:06] INFO: ======================================================================
[2025-11-19 19:27:06] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:27:06] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:27:06] INFO: Loaded 617 samples from metadata
[2025-11-19 19:27:06] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:27:06] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:27:06] INFO: Loaded 6 consensus groups
[2025-11-19 19:27:06] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:27:06] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:27:06] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:27:06] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:27:06] INFO: Prepared 617 assignment tasks
[2025-11-19 19:27:06] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:27:06] INFO: Identity calculation method: target_based
[2025-11-19 19:27:06] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:27:09] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:27:09] INFO: Step 6/6: Writing outputs
[2025-11-19 19:27:09] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:27:09] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:27:09] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:27:09] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:27:09] INFO: ======================================================================
[2025-11-19 19:27:09] INFO: Genotype assignment summary:
[2025-11-19 19:27:09] INFO:   Total samples: 617
[2025-11-19 19:27:09] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:27:09] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:27:09] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:27:09] INFO:     - Below identity threshold: 3
[2025-11-19 19:27:09] INFO:   Diagnostic flags:
[2025-11-19 19:27:09] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:27:09] INFO:     - Low confidence: 0
[2025-11-19 19:27:09] INFO: ======================================================================
[2025-11-19 19:27:09] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:27:09] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:27:09] INFO: 
[2025-11-19 19:27:09] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:27:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:27:09] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:27:09] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:27:09] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:27:09] INFO: 
[2025-11-19 19:27:09] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:27:09] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:27:09] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:27:09] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:27:10] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:27:10] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:27:10] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:27:10] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:27:10] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:27:10] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:27:10] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:27:10] INFO: Created 6 base name mappings
[2025-11-19 19:27:10] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:27:10] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:27:10] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:27:10] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:27:10] INFO: 
[2025-11-19 19:27:10] INFO: PHASE 6: Visualization
[2025-11-19 19:27:10] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:27:10] INFO: 6.1: Generating plots...
[2025-11-19 19:27:11] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:27:12] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:27:12] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:27:12] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:27:12] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:27:13] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:27:18] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:27:19] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:27:19] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:27:20] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:27:20] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:27:20] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:27:20] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:27:20] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:27:21] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 19:27:22] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:27:22] INFO:   ✓ Generated visualization plots
[2025-11-19 19:27:22] INFO: 
[2025-11-19 19:27:22] INFO: PHASE 7: Generating Reports
[2025-11-19 19:27:22] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:27:22] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:27:22] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:27:22] INFO: 
[2025-11-19 19:27:22] INFO: Cleaning up empty directories...
[2025-11-19 19:27:22] INFO:   ✓ Removed empty directories
[2025-11-19 19:27:22] INFO: 
[2025-11-19 19:27:22] INFO: Generating HTML summary report...
[2025-11-19 19:27:22] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:27:22] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:27:22] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:27:22] INFO: 
[2025-11-19 19:27:22] INFO: ================================================================================
[2025-11-19 19:27:22] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:27:22] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:27:22] INFO:   Key files:
[2025-11-19 19:27:22] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:27:22] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:27:22] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:27:22] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:27:22] INFO: ================================================================================
[2025-11-19 19:31:13] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:31:13] INFO: ================================================================================
[2025-11-19 19:31:13] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:31:13] INFO: ================================================================================
[2025-11-19 19:31:13] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:31:13] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:31:13] INFO: 
[2025-11-19 19:31:13] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:31:13] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:31:13] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:31:13] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:31:13] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:31:13] INFO: Read 685 rows and 88 columns
[2025-11-19 19:31:13] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:31:13] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:31:13] INFO: Data quality summary:
[2025-11-19 19:31:13] INFO:   total_rows: 675
[2025-11-19 19:31:13] INFO:   total_columns: 88
[2025-11-19 19:31:13] INFO:   unique_processids: 675
[2025-11-19 19:31:13] INFO:   sequences_present: 674
[2025-11-19 19:31:13] INFO:   sequences_missing: 1
[2025-11-19 19:31:13] INFO:   empty_sequences: 0
[2025-11-19 19:31:13] INFO:   coords_present: 229
[2025-11-19 19:31:13] INFO:   coords_missing: 446
[2025-11-19 19:31:13] INFO:   centroid_coords: 58
[2025-11-19 19:31:13] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:31:13] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:31:13] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:31:13] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:31:13] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:31:13] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:31:13] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:31:37] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:31:37] INFO: Creating point geometries from coordinates
[2025-11-19 19:31:37] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:31:37] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:31:38] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:31:38] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:31:38] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:31:38] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:31:38] INFO: 
[2025-11-19 19:31:38] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:31:38] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:31:38] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:31:38] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:31:38] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:31:38] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:31:38] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:31:38] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:31:43] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:31:43] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:31:44] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:31:44] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:31:44] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:32:02] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:32:02] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:32:02] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:32:02] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:32:02] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:32:02] INFO: 
[2025-11-19 19:32:02] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:32:02] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:32:02] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:32:02] INFO: ======================================================================
[2025-11-19 19:32:02] INFO: Starting genotype assignment workflow
[2025-11-19 19:32:02] INFO: ======================================================================
[2025-11-19 19:32:02] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:32:02] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:32:02] INFO: Loaded 617 samples from metadata
[2025-11-19 19:32:02] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:32:02] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:32:02] INFO: Loaded 6 consensus groups
[2025-11-19 19:32:02] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:32:02] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:32:02] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:32:02] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:32:02] INFO: Prepared 617 assignment tasks
[2025-11-19 19:32:02] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:32:02] INFO: Identity calculation method: target_based
[2025-11-19 19:32:02] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:32:05] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:32:05] INFO: Step 6/6: Writing outputs
[2025-11-19 19:32:05] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:32:05] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:32:06] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:32:06] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:32:06] INFO: ======================================================================
[2025-11-19 19:32:06] INFO: Genotype assignment summary:
[2025-11-19 19:32:06] INFO:   Total samples: 617
[2025-11-19 19:32:06] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:32:06] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:32:06] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:32:06] INFO:     - Below identity threshold: 3
[2025-11-19 19:32:06] INFO:   Diagnostic flags:
[2025-11-19 19:32:06] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:32:06] INFO:     - Low confidence: 0
[2025-11-19 19:32:06] INFO: ======================================================================
[2025-11-19 19:32:06] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:32:06] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:32:06] INFO: 
[2025-11-19 19:32:06] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:32:06] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:32:06] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:32:06] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:32:06] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:32:06] INFO: 
[2025-11-19 19:32:06] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:32:06] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:32:06] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:32:06] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:32:07] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:32:07] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:32:07] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:32:07] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:32:07] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:32:07] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:32:07] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:32:07] INFO: Created 6 base name mappings
[2025-11-19 19:32:07] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:32:07] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:32:07] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:32:07] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:32:07] INFO: 
[2025-11-19 19:32:07] INFO: PHASE 6: Visualization
[2025-11-19 19:32:07] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:32:07] INFO: 6.1: Generating plots...
[2025-11-19 19:32:08] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:32:08] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:32:09] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:32:09] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:32:09] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:32:09] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:32:14] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:32:15] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:32:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:32:16] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:32:16] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:32:16] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:32:16] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:32:16] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:32:18] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 19:32:18] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:32:18] INFO:   ✓ Generated visualization plots
[2025-11-19 19:32:18] INFO: 
[2025-11-19 19:32:18] INFO: PHASE 7: Generating Reports
[2025-11-19 19:32:18] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:32:18] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:32:18] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:32:18] INFO: 
[2025-11-19 19:32:18] INFO: Cleaning up empty directories...
[2025-11-19 19:32:18] INFO:   ✓ Removed empty directories
[2025-11-19 19:32:18] INFO: 
[2025-11-19 19:32:18] INFO: Generating HTML summary report...
[2025-11-19 19:32:18] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:32:18] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:32:18] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:32:18] INFO: 
[2025-11-19 19:32:18] INFO: ================================================================================
[2025-11-19 19:32:18] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:32:18] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:32:18] INFO:   Key files:
[2025-11-19 19:32:18] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:32:18] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:32:18] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:32:18] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:32:18] INFO: ================================================================================
[2025-11-19 19:36:51] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:36:51] INFO: ================================================================================
[2025-11-19 19:36:51] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:36:51] INFO: ================================================================================
[2025-11-19 19:36:51] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:36:51] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:36:51] INFO: 
[2025-11-19 19:36:51] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:36:51] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:36:51] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:36:51] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:36:51] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:36:51] INFO: Read 685 rows and 88 columns
[2025-11-19 19:36:51] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:36:51] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:36:51] INFO: Data quality summary:
[2025-11-19 19:36:51] INFO:   total_rows: 675
[2025-11-19 19:36:51] INFO:   total_columns: 88
[2025-11-19 19:36:51] INFO:   unique_processids: 675
[2025-11-19 19:36:51] INFO:   sequences_present: 674
[2025-11-19 19:36:51] INFO:   sequences_missing: 1
[2025-11-19 19:36:51] INFO:   empty_sequences: 0
[2025-11-19 19:36:51] INFO:   coords_present: 229
[2025-11-19 19:36:51] INFO:   coords_missing: 446
[2025-11-19 19:36:51] INFO:   centroid_coords: 58
[2025-11-19 19:36:51] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:36:51] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:36:51] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:36:51] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:36:51] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:36:51] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:36:51] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:37:15] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:37:15] INFO: Creating point geometries from coordinates
[2025-11-19 19:37:15] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:37:15] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:37:15] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:37:15] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:37:15] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:37:15] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:37:15] INFO: 
[2025-11-19 19:37:15] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:37:15] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:15] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:37:15] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:37:15] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:37:15] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:37:15] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:37:15] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:37:21] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:37:21] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:37:22] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:37:22] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:37:22] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:37:40] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:37:40] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:37:40] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:37:40] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:37:40] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:37:40] INFO: 
[2025-11-19 19:37:40] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:37:40] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:40] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:37:40] INFO: ======================================================================
[2025-11-19 19:37:40] INFO: Starting genotype assignment workflow
[2025-11-19 19:37:40] INFO: ======================================================================
[2025-11-19 19:37:40] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:37:40] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:37:40] INFO: Loaded 617 samples from metadata
[2025-11-19 19:37:40] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:37:40] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:37:40] INFO: Loaded 6 consensus groups
[2025-11-19 19:37:40] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:37:40] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:37:40] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:37:40] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:37:40] INFO: Prepared 617 assignment tasks
[2025-11-19 19:37:40] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:37:40] INFO: Identity calculation method: target_based
[2025-11-19 19:37:40] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:37:44] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:37:44] INFO: Step 6/6: Writing outputs
[2025-11-19 19:37:44] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:37:44] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:37:44] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:37:44] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:37:44] INFO: ======================================================================
[2025-11-19 19:37:44] INFO: Genotype assignment summary:
[2025-11-19 19:37:44] INFO:   Total samples: 617
[2025-11-19 19:37:44] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:37:44] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:37:44] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:37:44] INFO:     - Below identity threshold: 3
[2025-11-19 19:37:44] INFO:   Diagnostic flags:
[2025-11-19 19:37:44] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:37:44] INFO:     - Low confidence: 0
[2025-11-19 19:37:44] INFO: ======================================================================
[2025-11-19 19:37:44] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:37:44] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:37:44] INFO: 
[2025-11-19 19:37:44] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:37:44] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:44] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:37:44] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:37:44] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:37:44] INFO: 
[2025-11-19 19:37:44] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:37:44] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:44] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:37:44] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:37:45] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:37:45] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:37:45] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:37:45] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:37:45] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:37:45] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:37:45] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:37:45] INFO: Created 6 base name mappings
[2025-11-19 19:37:45] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:37:45] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:37:45] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:37:45] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:37:45] INFO: 
[2025-11-19 19:37:45] INFO: PHASE 6: Visualization
[2025-11-19 19:37:45] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:45] INFO: 6.1: Generating plots...
[2025-11-19 19:37:46] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:37:47] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:37:47] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:37:47] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:37:47] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:37:47] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:37:52] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:37:54] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:37:54] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:37:54] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:37:54] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:37:54] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:37:54] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:37:55] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:37:56] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 19:37:56] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:37:56] INFO:   ✓ Generated visualization plots
[2025-11-19 19:37:56] INFO: 
[2025-11-19 19:37:56] INFO: PHASE 7: Generating Reports
[2025-11-19 19:37:56] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:37:56] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:37:56] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:37:56] INFO: 
[2025-11-19 19:37:56] INFO: Cleaning up empty directories...
[2025-11-19 19:37:56] INFO:   ✓ Removed empty directories
[2025-11-19 19:37:56] INFO: 
[2025-11-19 19:37:56] INFO: Generating HTML summary report...
[2025-11-19 19:37:56] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:37:56] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:37:56] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:37:56] INFO: 
[2025-11-19 19:37:56] INFO: ================================================================================
[2025-11-19 19:37:56] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:37:56] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:37:56] INFO:   Key files:
[2025-11-19 19:37:56] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:37:56] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:37:56] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:37:56] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:37:56] INFO: ================================================================================
[2025-11-19 19:47:32] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:47:32] INFO: ================================================================================
[2025-11-19 19:47:32] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:47:32] INFO: ================================================================================
[2025-11-19 19:47:32] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:47:32] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:47:32] INFO: 
[2025-11-19 19:47:32] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:47:32] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:47:32] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:47:32] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:47:32] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:47:32] INFO: Read 685 rows and 88 columns
[2025-11-19 19:47:32] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:47:32] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:47:32] INFO: Data quality summary:
[2025-11-19 19:47:32] INFO:   total_rows: 675
[2025-11-19 19:47:32] INFO:   total_columns: 88
[2025-11-19 19:47:32] INFO:   unique_processids: 675
[2025-11-19 19:47:32] INFO:   sequences_present: 674
[2025-11-19 19:47:32] INFO:   sequences_missing: 1
[2025-11-19 19:47:32] INFO:   empty_sequences: 0
[2025-11-19 19:47:32] INFO:   coords_present: 229
[2025-11-19 19:47:32] INFO:   coords_missing: 446
[2025-11-19 19:47:32] INFO:   centroid_coords: 58
[2025-11-19 19:47:32] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:47:32] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:47:32] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:47:32] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:47:32] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:47:32] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:47:32] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:47:55] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:47:55] INFO: Creating point geometries from coordinates
[2025-11-19 19:47:55] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:47:55] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:47:56] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:47:56] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:47:56] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:47:56] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:47:56] INFO: 
[2025-11-19 19:47:56] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:47:56] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:47:56] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:47:56] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:47:56] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:47:56] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:47:56] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:47:56] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:48:01] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:48:01] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:48:02] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:48:02] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:48:02] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:48:20] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:48:20] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:48:20] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:48:20] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:48:20] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:48:20] INFO: 
[2025-11-19 19:48:20] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:48:20] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:48:20] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:48:20] INFO: ======================================================================
[2025-11-19 19:48:20] INFO: Starting genotype assignment workflow
[2025-11-19 19:48:20] INFO: ======================================================================
[2025-11-19 19:48:20] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:48:20] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:48:20] INFO: Loaded 617 samples from metadata
[2025-11-19 19:48:20] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:48:20] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:48:20] INFO: Loaded 6 consensus groups
[2025-11-19 19:48:20] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:48:20] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:48:20] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:48:20] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:48:20] INFO: Prepared 617 assignment tasks
[2025-11-19 19:48:20] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:48:20] INFO: Identity calculation method: target_based
[2025-11-19 19:48:20] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:48:23] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:48:23] INFO: Step 6/6: Writing outputs
[2025-11-19 19:48:23] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:48:23] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:48:23] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:48:23] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:48:23] INFO: ======================================================================
[2025-11-19 19:48:23] INFO: Genotype assignment summary:
[2025-11-19 19:48:23] INFO:   Total samples: 617
[2025-11-19 19:48:23] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:48:23] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:48:23] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:48:23] INFO:     - Below identity threshold: 3
[2025-11-19 19:48:23] INFO:   Diagnostic flags:
[2025-11-19 19:48:23] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:48:23] INFO:     - Low confidence: 0
[2025-11-19 19:48:23] INFO: ======================================================================
[2025-11-19 19:48:23] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:48:23] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:48:23] INFO: 
[2025-11-19 19:48:23] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:48:23] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:48:23] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:48:24] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:48:24] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:48:24] INFO: 
[2025-11-19 19:48:24] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:48:24] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:48:24] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:48:24] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:48:24] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:48:24] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:48:25] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:48:25] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:48:25] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:48:25] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:48:25] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:48:25] INFO: Created 6 base name mappings
[2025-11-19 19:48:25] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:48:25] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:48:25] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:48:25] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:48:25] INFO: 
[2025-11-19 19:48:25] INFO: PHASE 6: Visualization
[2025-11-19 19:48:25] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:48:25] INFO: 6.1: Generating plots...
[2025-11-19 19:48:27] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:48:27] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:48:28] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:48:28] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:48:28] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:48:28] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:48:33] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:48:34] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:48:35] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:48:35] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:48:35] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:48:35] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:48:35] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:48:35] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:48:36] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 19:48:37] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:48:37] INFO:   ✓ Generated visualization plots
[2025-11-19 19:48:37] INFO: 
[2025-11-19 19:48:37] INFO: PHASE 7: Generating Reports
[2025-11-19 19:48:37] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:48:37] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:48:37] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:48:37] INFO: 
[2025-11-19 19:48:37] INFO: Cleaning up empty directories...
[2025-11-19 19:48:37] INFO:   ✓ Removed empty directories
[2025-11-19 19:48:37] INFO: 
[2025-11-19 19:48:37] INFO: Generating HTML summary report...
[2025-11-19 19:48:37] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:48:37] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:48:37] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:48:37] INFO: 
[2025-11-19 19:48:37] INFO: ================================================================================
[2025-11-19 19:48:37] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:48:37] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:48:37] INFO:   Key files:
[2025-11-19 19:48:37] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:48:37] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:48:37] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:48:37] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:48:37] INFO: ================================================================================
[2025-11-19 19:52:56] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:52:56] INFO: ================================================================================
[2025-11-19 19:52:56] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:52:56] INFO: ================================================================================
[2025-11-19 19:52:56] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:52:56] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:52:56] INFO: 
[2025-11-19 19:52:56] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:52:56] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:52:56] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:52:56] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:52:56] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:52:56] INFO: Read 685 rows and 88 columns
[2025-11-19 19:52:56] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:52:56] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:52:56] INFO: Data quality summary:
[2025-11-19 19:52:56] INFO:   total_rows: 675
[2025-11-19 19:52:56] INFO:   total_columns: 88
[2025-11-19 19:52:56] INFO:   unique_processids: 675
[2025-11-19 19:52:56] INFO:   sequences_present: 674
[2025-11-19 19:52:56] INFO:   sequences_missing: 1
[2025-11-19 19:52:56] INFO:   empty_sequences: 0
[2025-11-19 19:52:56] INFO:   coords_present: 229
[2025-11-19 19:52:56] INFO:   coords_missing: 446
[2025-11-19 19:52:56] INFO:   centroid_coords: 58
[2025-11-19 19:52:56] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:52:56] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:52:56] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:52:56] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:52:56] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:52:56] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:52:56] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:53:19] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:53:19] INFO: Creating point geometries from coordinates
[2025-11-19 19:53:19] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:53:19] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:53:20] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:53:20] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:53:20] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:53:20] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:53:20] INFO: 
[2025-11-19 19:53:20] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:53:20] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:53:20] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:53:20] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:53:20] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:53:20] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:53:20] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:53:20] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:53:25] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:53:25] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:53:27] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:53:27] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:53:27] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 19:53:44] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 19:53:44] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 19:53:44] INFO: Clustering complete: 6 clusters formed
[2025-11-19 19:53:45] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 19:53:45] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 19:53:45] INFO: 
[2025-11-19 19:53:45] INFO: PHASE 3: Genotype Assignment
[2025-11-19 19:53:45] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:53:45] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 19:53:45] INFO: ======================================================================
[2025-11-19 19:53:45] INFO: Starting genotype assignment workflow
[2025-11-19 19:53:45] INFO: ======================================================================
[2025-11-19 19:53:45] INFO: Using edlib for fast edit distance calculation
[2025-11-19 19:53:45] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 19:53:45] INFO: Loaded 617 samples from metadata
[2025-11-19 19:53:45] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:53:45] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:53:45] INFO: Loaded 6 consensus groups
[2025-11-19 19:53:45] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:53:45] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:53:45] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 19:53:45] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 19:53:45] INFO: Prepared 617 assignment tasks
[2025-11-19 19:53:45] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 19:53:45] INFO: Identity calculation method: target_based
[2025-11-19 19:53:45] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 19:53:49] INFO: Completed genotype assignment for 617 samples
[2025-11-19 19:53:49] INFO: Step 6/6: Writing outputs
[2025-11-19 19:53:49] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:53:49] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 19:53:49] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 19:53:49] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 19:53:49] INFO: ======================================================================
[2025-11-19 19:53:49] INFO: Genotype assignment summary:
[2025-11-19 19:53:49] INFO:   Total samples: 617
[2025-11-19 19:53:49] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 19:53:49] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 19:53:49] INFO:     - No sequence in FASTA: 19
[2025-11-19 19:53:49] INFO:     - Below identity threshold: 3
[2025-11-19 19:53:49] INFO:   Diagnostic flags:
[2025-11-19 19:53:49] INFO:     - Ties (ambiguous): 2
[2025-11-19 19:53:49] INFO:     - Low confidence: 0
[2025-11-19 19:53:49] INFO: ======================================================================
[2025-11-19 19:53:49] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 19:53:49] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 19:53:49] INFO: 
[2025-11-19 19:53:49] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 19:53:49] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:53:49] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 19:53:49] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 19:53:49] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:53:49] INFO: 
[2025-11-19 19:53:49] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 19:53:49] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:53:49] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 19:53:49] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:53:50] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:53:50] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:53:50] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:53:50] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:53:50] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 19:53:50] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 19:53:50] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 19:53:50] INFO: Created 6 base name mappings
[2025-11-19 19:53:50] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:53:50] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:53:50] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:53:50] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 19:53:50] INFO: 
[2025-11-19 19:53:50] INFO: PHASE 6: Visualization
[2025-11-19 19:53:50] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:53:50] INFO: 6.1: Generating plots...
[2025-11-19 19:53:52] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 19:53:52] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 19:53:53] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 19:53:53] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:53:53] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:53:53] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:53:58] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 19:53:59] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 19:53:59] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 19:53:59] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 19:54:00] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 19:54:00] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 19:54:00] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 19:54:00] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 19:54:01] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 19:54:01] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 19:54:01] INFO:   ✓ Generated visualization plots
[2025-11-19 19:54:01] INFO: 
[2025-11-19 19:54:01] INFO: PHASE 7: Generating Reports
[2025-11-19 19:54:01] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:54:02] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:54:02] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 19:54:02] INFO: 
[2025-11-19 19:54:02] INFO: Cleaning up empty directories...
[2025-11-19 19:54:02] INFO:   ✓ Removed empty directories
[2025-11-19 19:54:02] INFO: 
[2025-11-19 19:54:02] INFO: Generating HTML summary report...
[2025-11-19 19:54:02] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 19:54:02] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:54:02] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:54:02] INFO: 
[2025-11-19 19:54:02] INFO: ================================================================================
[2025-11-19 19:54:02] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 19:54:02] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:54:02] INFO:   Key files:
[2025-11-19 19:54:02] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 19:54:02] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 19:54:02] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 19:54:02] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 19:54:02] INFO: ================================================================================
[2025-11-19 19:59:18] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline.log
[2025-11-19 19:59:18] INFO: ================================================================================
[2025-11-19 19:59:18] INFO: BOLDGenotyper Pipeline - Sphyrna_lewini
[2025-11-19 19:59:18] INFO: ================================================================================
[2025-11-19 19:59:18] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:59:18] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 19:59:18] INFO: 
[2025-11-19 19:59:18] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_pipeline_parameters.json
[2025-11-19 19:59:18] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-19 19:59:18] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:59:18] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-19 19:59:18] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-19 19:59:18] INFO: Read 685 rows and 88 columns
[2025-11-19 19:59:18] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-19 19:59:18] INFO: After removing duplicates: 675 rows remaining
[2025-11-19 19:59:18] INFO: Data quality summary:
[2025-11-19 19:59:18] INFO:   total_rows: 675
[2025-11-19 19:59:18] INFO:   total_columns: 88
[2025-11-19 19:59:18] INFO:   unique_processids: 675
[2025-11-19 19:59:18] INFO:   sequences_present: 674
[2025-11-19 19:59:18] INFO:   sequences_missing: 1
[2025-11-19 19:59:18] INFO:   empty_sequences: 0
[2025-11-19 19:59:18] INFO:   coords_present: 229
[2025-11-19 19:59:18] INFO:   coords_missing: 446
[2025-11-19 19:59:18] INFO:   centroid_coords: 58
[2025-11-19 19:59:18] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-19 19:59:18] INFO: 1.2: Filtering coordinate quality...
[2025-11-19 19:59:18] INFO: Excluded 58 samples with centroid coordinates
[2025-11-19 19:59:18] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-19 19:59:18] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-19 19:59:18] INFO: 1.3: Assigning ocean basins...
[2025-11-19 19:59:18] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-19 19:59:41] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-19 19:59:41] INFO: Creating point geometries from coordinates
[2025-11-19 19:59:41] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-19 19:59:41] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-19 19:59:42] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-19 19:59:42] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-19 19:59:42] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-19 19:59:42] INFO:   ✓ Assigned ocean basins to samples
[2025-11-19 19:59:42] INFO: 
[2025-11-19 19:59:42] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-19 19:59:42] INFO: --------------------------------------------------------------------------------
[2025-11-19 19:59:42] INFO: 2.1: Generating FASTA from sequences...
[2025-11-19 19:59:42] INFO:   Minimum sequence length: 400 bp
[2025-11-19 19:59:42] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-19 19:59:42] INFO:   ✓ Created 598 FASTA records
[2025-11-19 19:59:42] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-19 19:59:42] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 19:59:47] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta
[2025-11-19 19:59:47] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta -automated1
[2025-11-19 19:59:48] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_trimmed.fasta
[2025-11-19 19:59:48] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-19 19:59:48] INFO: Calculating pairwise distances for 595 sequences
[2025-11-19 20:00:07] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-19 20:00:07] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-19 20:00:07] INFO: Clustering complete: 6 clusters formed
[2025-11-19 20:00:08] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus_metadata.csv
[2025-11-19 20:00:08] INFO:   ✓ Identified 6 unique genotypes
[2025-11-19 20:00:08] INFO: 
[2025-11-19 20:00:08] INFO: PHASE 3: Genotype Assignment
[2025-11-19 20:00:08] INFO: --------------------------------------------------------------------------------
[2025-11-19 20:00:08] INFO: 3.1: Assigning samples to genotypes...
[2025-11-19 20:00:08] INFO: ======================================================================
[2025-11-19 20:00:08] INFO: Starting genotype assignment workflow
[2025-11-19 20:00:08] INFO: ======================================================================
[2025-11-19 20:00:08] INFO: Using edlib for fast edit distance calculation
[2025-11-19 20:00:08] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-19 20:00:08] INFO: Loaded 617 samples from metadata
[2025-11-19 20:00:08] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 20:00:08] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 20:00:08] INFO: Loaded 6 consensus groups
[2025-11-19 20:00:08] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 20:00:08] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna_lewini.fasta
[2025-11-19 20:00:08] INFO: Extracted 598 unique processids from FASTA
[2025-11-19 20:00:08] INFO: Step 4/6: Preparing assignment tasks
[2025-11-19 20:00:08] INFO: Prepared 617 assignment tasks
[2025-11-19 20:00:08] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-19 20:00:08] INFO: Identity calculation method: target_based
[2025-11-19 20:00:08] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-19 20:00:11] INFO: Completed genotype assignment for 617 samples
[2025-11-19 20:00:11] INFO: Step 6/6: Writing outputs
[2025-11-19 20:00:11] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 20:00:11] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-19 20:00:11] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna_lewini_with_genotypes.tsv
[2025-11-19 20:00:11] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna_lewini_diagnostics.csv
[2025-11-19 20:00:11] INFO: ======================================================================
[2025-11-19 20:00:11] INFO: Genotype assignment summary:
[2025-11-19 20:00:11] INFO:   Total samples: 617
[2025-11-19 20:00:11] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-19 20:00:11] INFO:   Unassigned: 22 (3.6%)
[2025-11-19 20:00:11] INFO:     - No sequence in FASTA: 19
[2025-11-19 20:00:11] INFO:     - Below identity threshold: 3
[2025-11-19 20:00:11] INFO:   Diagnostic flags:
[2025-11-19 20:00:11] INFO:     - Ties (ambiguous): 2
[2025-11-19 20:00:11] INFO:     - Low confidence: 0
[2025-11-19 20:00:11] INFO: ======================================================================
[2025-11-19 20:00:11] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-19 20:00:11] INFO:   ✓ Assignment rate: 96.4%
[2025-11-19 20:00:11] INFO: 
[2025-11-19 20:00:11] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-19 20:00:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 20:00:11] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-19 20:00:11] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-19 20:00:11] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 20:00:11] INFO: 
[2025-11-19 20:00:11] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-19 20:00:11] INFO: --------------------------------------------------------------------------------
[2025-11-19 20:00:11] INFO: 5.1: Building phylogenetic tree...
[2025-11-19 20:00:11] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 20:00:12] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 20:00:12] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned.fasta
[2025-11-19 20:00:12] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 20:00:12] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 20:00:12] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-19 20:00:12] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-19 20:00:12] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-19 20:00:12] INFO: Created 6 base name mappings
[2025-11-19 20:00:12] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 20:00:12] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 20:00:12] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 20:00:12] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna_lewini_aligned_relabeled.fasta
[2025-11-19 20:00:12] INFO: 
[2025-11-19 20:00:12] INFO: PHASE 6: Visualization
[2025-11-19 20:00:12] INFO: --------------------------------------------------------------------------------
[2025-11-19 20:00:12] INFO: 6.1: Generating plots...
[2025-11-19 20:00:14] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.png
[2025-11-19 20:00:14] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.png
[2025-11-19 20:00:15] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.png
[2025-11-19 20:00:15] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 20:00:15] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 20:00:15] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 20:00:20] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.png
[2025-11-19 20:00:21] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.png
[2025-11-19 20:00:21] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar.pdf
[2025-11-19 20:00:21] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_totaldistribution_bar.pdf
[2025-11-19 20:00:22] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_identity_distribution.pdf
[2025-11-19 20:00:22] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree_relabeled.nwk
[2025-11-19 20:00:22] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-19 20:00:22] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-19 20:00:23] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_map_faceted.pdf
[2025-11-19 20:00:24] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna_lewini_distribution_bar_faceted.pdf
[2025-11-19 20:00:24] INFO:   ✓ Generated visualization plots
[2025-11-19 20:00:24] INFO: 
[2025-11-19 20:00:24] INFO: PHASE 7: Generating Reports
[2025-11-19 20:00:24] INFO: --------------------------------------------------------------------------------
[2025-11-19 20:00:24] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 20:00:24] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna_lewini_assignment_summary.csv
[2025-11-19 20:00:24] INFO: 
[2025-11-19 20:00:24] INFO: Cleaning up empty directories...
[2025-11-19 20:00:24] INFO:   ✓ Removed empty directories
[2025-11-19 20:00:24] INFO: 
[2025-11-19 20:00:24] INFO: Generating HTML summary report...
[2025-11-19 20:00:24] INFO: Generating HTML summary report for Sphyrna_lewini...
[2025-11-19 20:00:24] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 20:00:24] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 20:00:24] INFO: 
[2025-11-19 20:00:24] INFO: ================================================================================
[2025-11-19 20:00:24] INFO: ✓ Pipeline completed successfully for Sphyrna_lewini
[2025-11-19 20:00:24] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-19 20:00:24] INFO:   Key files:
[2025-11-19 20:00:24] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_annotated.csv
[2025-11-19 20:00:24] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna_lewini_consensus.fasta
[2025-11-19 20:00:24] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna_lewini_tree.nwk
[2025-11-19 20:00:24] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna_lewini_summary_report.html
[2025-11-19 20:00:24] INFO: ================================================================================
