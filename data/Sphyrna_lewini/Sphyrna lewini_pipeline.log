[2025-11-20 14:45:07] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 14:45:07] INFO: ================================================================================
[2025-11-20 14:45:07] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 14:45:07] INFO: ================================================================================
[2025-11-20 14:45:07] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:45:07] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:45:07] INFO: 
[2025-11-20 14:45:07] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 14:45:07] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 14:45:07] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:45:07] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 14:45:07] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:45:07] INFO: Read 685 rows and 88 columns
[2025-11-20 14:45:07] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 14:45:07] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 14:45:07] INFO: Data quality summary:
[2025-11-20 14:45:07] INFO:   total_rows: 675
[2025-11-20 14:45:07] INFO:   total_columns: 88
[2025-11-20 14:45:07] INFO:   unique_processids: 675
[2025-11-20 14:45:07] INFO:   sequences_present: 674
[2025-11-20 14:45:07] INFO:   sequences_missing: 1
[2025-11-20 14:45:07] INFO:   empty_sequences: 0
[2025-11-20 14:45:07] INFO:   coords_present: 229
[2025-11-20 14:45:07] INFO:   coords_missing: 446
[2025-11-20 14:45:07] INFO:   centroid_coords: 58
[2025-11-20 14:45:07] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 14:45:07] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 14:45:07] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 14:45:07] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 14:45:07] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 14:45:07] INFO: 1.3: Assigning ocean basins...
[2025-11-20 14:45:07] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 14:45:32] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 14:45:32] INFO: Creating point geometries from coordinates
[2025-11-20 14:45:32] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 14:45:32] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 14:45:33] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 14:45:33] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 14:45:33] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 14:45:33] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 14:45:33] INFO: 
[2025-11-20 14:45:33] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 14:45:33] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:45:33] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 14:45:33] INFO:   Minimum sequence length: 400 bp
[2025-11-20 14:45:33] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 14:45:33] INFO:   ✓ Created 598 FASTA records
[2025-11-20 14:45:33] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 14:45:33] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:45:39] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 14:45:39] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 14:45:41] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 14:45:41] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 14:45:41] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 14:46:00] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 14:46:00] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-20 14:46:00] INFO: Clustering complete: 4 clusters formed
[2025-11-20 14:46:00] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 14:46:00] INFO:   ✓ Identified 4 unique genotypes
[2025-11-20 14:46:00] INFO: 
[2025-11-20 14:46:00] INFO: PHASE 3: Genotype Assignment
[2025-11-20 14:46:00] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:46:00] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 14:46:00] INFO: ======================================================================
[2025-11-20 14:46:00] INFO: Starting genotype assignment workflow
[2025-11-20 14:46:00] INFO: ======================================================================
[2025-11-20 14:46:00] INFO: Using edlib for fast edit distance calculation
[2025-11-20 14:46:00] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 14:46:00] INFO: Loaded 617 samples from metadata
[2025-11-20 14:46:00] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:46:00] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:46:00] INFO: Loaded 4 consensus groups
[2025-11-20 14:46:00] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:46:00] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:46:00] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 14:46:00] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 14:46:00] INFO: Prepared 617 assignment tasks
[2025-11-20 14:46:00] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 14:46:00] INFO: Identity calculation method: target_based
[2025-11-20 14:46:00] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 14:46:03] INFO: Completed genotype assignment for 617 samples
[2025-11-20 14:46:03] INFO: Step 6/6: Writing outputs
[2025-11-20 14:46:03] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:46:03] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-20 14:46:03] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:46:03] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 14:46:03] INFO: ======================================================================
[2025-11-20 14:46:03] INFO: Genotype assignment summary:
[2025-11-20 14:46:03] INFO:   Total samples: 617
[2025-11-20 14:46:03] INFO:   Successfully assigned: 486 (78.8%)
[2025-11-20 14:46:03] INFO:   Unassigned: 131 (21.2%)
[2025-11-20 14:46:03] INFO:     - No sequence in FASTA: 19
[2025-11-20 14:46:03] INFO:     - Below identity threshold: 112
[2025-11-20 14:46:03] INFO:   Diagnostic flags:
[2025-11-20 14:46:03] INFO:     - Ties (ambiguous): 0
[2025-11-20 14:46:03] INFO:     - Low confidence: 127
[2025-11-20 14:46:03] INFO: ======================================================================
[2025-11-20 14:46:03] INFO:   ✓ Assigned 486/617 samples to genotypes
[2025-11-20 14:46:03] INFO:   ✓ Assignment rate: 78.8%
[2025-11-20 14:46:03] INFO: 
[2025-11-20 14:46:03] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 14:46:03] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:46:03] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 14:46:04] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-20 14:46:04] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:46:04] INFO: 
[2025-11-20 14:46:04] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 14:46:04] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:46:04] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 14:46:04] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:46:05] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:46:05] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:46:05] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:46:05] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:46:05] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 14:46:05] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 14:46:05] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-20 14:46:05] INFO: Created 4 base name mappings
[2025-11-20 14:46:05] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:46:05] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:46:05] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:46:05] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:46:05] INFO: 
[2025-11-20 14:46:05] INFO: PHASE 6: Visualization
[2025-11-20 14:46:05] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:46:05] INFO: 6.1: Generating plots...
[2025-11-20 14:46:07] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 14:46:07] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 14:46:07] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:46:11] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 14:46:12] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 14:46:13] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 14:46:13] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:46:13] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 14:46:13] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 14:46:14] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 14:46:14] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:46:14] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 14:46:15] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 14:46:15] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 14:46:15] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:46:15] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 14:46:15] INFO:   ✓ Generated visualization plots
[2025-11-20 14:46:15] INFO: 
[2025-11-20 14:46:15] INFO: PHASE 7: Generating Reports
[2025-11-20 14:46:15] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:46:15] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:46:15] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:46:15] INFO: 
[2025-11-20 14:46:15] INFO: Cleaning up empty directories...
[2025-11-20 14:46:15] INFO:   ✓ Removed empty directories
[2025-11-20 14:46:15] INFO: 
[2025-11-20 14:46:15] INFO: Generating HTML summary report...
[2025-11-20 14:46:15] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 14:46:15] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:46:15] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:46:15] INFO: 
[2025-11-20 14:46:15] INFO: ================================================================================
[2025-11-20 14:46:15] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 14:46:15] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:46:15] INFO:   Key files:
[2025-11-20 14:46:15] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:46:15] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:46:15] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:46:15] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:46:15] INFO: ================================================================================
[2025-11-20 14:49:58] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 14:49:58] INFO: ================================================================================
[2025-11-20 14:49:58] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 14:49:58] INFO: ================================================================================
[2025-11-20 14:49:58] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:49:58] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:49:58] INFO: 
[2025-11-20 14:49:58] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 14:49:58] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 14:49:58] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:49:58] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 14:49:58] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:49:58] INFO: Read 685 rows and 88 columns
[2025-11-20 14:49:58] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 14:49:58] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 14:49:58] INFO: Data quality summary:
[2025-11-20 14:49:58] INFO:   total_rows: 675
[2025-11-20 14:49:58] INFO:   total_columns: 88
[2025-11-20 14:49:58] INFO:   unique_processids: 675
[2025-11-20 14:49:58] INFO:   sequences_present: 674
[2025-11-20 14:49:58] INFO:   sequences_missing: 1
[2025-11-20 14:49:58] INFO:   empty_sequences: 0
[2025-11-20 14:49:58] INFO:   coords_present: 229
[2025-11-20 14:49:58] INFO:   coords_missing: 446
[2025-11-20 14:49:58] INFO:   centroid_coords: 58
[2025-11-20 14:49:58] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 14:49:58] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 14:49:58] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 14:49:58] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 14:49:58] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 14:49:58] INFO: 1.3: Assigning ocean basins...
[2025-11-20 14:49:58] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 14:50:22] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 14:50:22] INFO: Creating point geometries from coordinates
[2025-11-20 14:50:22] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 14:50:22] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 14:50:23] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 14:50:23] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 14:50:23] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 14:50:23] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 14:50:23] INFO: 
[2025-11-20 14:50:23] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 14:50:23] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:50:23] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 14:50:23] INFO:   Minimum sequence length: 400 bp
[2025-11-20 14:50:23] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 14:50:23] INFO:   ✓ Created 598 FASTA records
[2025-11-20 14:50:23] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 14:50:23] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:50:28] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 14:50:28] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 14:50:30] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 14:50:30] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 14:50:30] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 14:50:48] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 14:50:48] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-20 14:50:48] INFO: Clustering complete: 4 clusters formed
[2025-11-20 14:50:48] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 14:50:48] INFO:   ✓ Identified 4 unique genotypes
[2025-11-20 14:50:48] INFO: 
[2025-11-20 14:50:48] INFO: PHASE 3: Genotype Assignment
[2025-11-20 14:50:48] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:50:48] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 14:50:48] INFO: ======================================================================
[2025-11-20 14:50:48] INFO: Starting genotype assignment workflow
[2025-11-20 14:50:48] INFO: ======================================================================
[2025-11-20 14:50:48] INFO: Using edlib for fast edit distance calculation
[2025-11-20 14:50:48] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 14:50:48] INFO: Loaded 617 samples from metadata
[2025-11-20 14:50:48] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:50:48] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:50:48] INFO: Loaded 4 consensus groups
[2025-11-20 14:50:48] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:50:48] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:50:48] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 14:50:48] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 14:50:48] INFO: Prepared 617 assignment tasks
[2025-11-20 14:50:48] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 14:50:48] INFO: Identity calculation method: target_based
[2025-11-20 14:50:48] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 14:50:51] INFO: Completed genotype assignment for 617 samples
[2025-11-20 14:50:51] INFO: Step 6/6: Writing outputs
[2025-11-20 14:50:51] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:50:51] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-20 14:50:51] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:50:51] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 14:50:51] INFO: ======================================================================
[2025-11-20 14:50:51] INFO: Genotype assignment summary:
[2025-11-20 14:50:51] INFO:   Total samples: 617
[2025-11-20 14:50:51] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 14:50:51] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 14:50:51] INFO:     - No sequence in FASTA: 19
[2025-11-20 14:50:51] INFO:     - Below identity threshold: 3
[2025-11-20 14:50:51] INFO:   Diagnostic flags:
[2025-11-20 14:50:51] INFO:     - Ties (ambiguous): 0
[2025-11-20 14:50:51] INFO:     - Low confidence: 0
[2025-11-20 14:50:51] INFO: ======================================================================
[2025-11-20 14:50:51] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 14:50:51] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 14:50:52] INFO: 
[2025-11-20 14:50:52] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 14:50:52] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:50:52] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 14:50:52] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-20 14:50:52] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:50:52] INFO: 
[2025-11-20 14:50:52] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 14:50:52] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:50:52] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 14:50:52] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:50:53] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:50:53] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:50:53] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:50:53] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:50:53] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 14:50:53] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 14:50:53] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-20 14:50:53] INFO: Created 4 base name mappings
[2025-11-20 14:50:53] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:50:53] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:50:53] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:50:53] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:50:53] INFO: 
[2025-11-20 14:50:53] INFO: PHASE 6: Visualization
[2025-11-20 14:50:53] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:50:53] INFO: 6.1: Generating plots...
[2025-11-20 14:50:54] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 14:50:54] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 14:50:54] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:50:58] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 14:50:59] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 14:51:00] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 14:51:00] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:51:00] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 14:51:00] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 14:51:00] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 14:51:00] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:51:01] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 14:51:02] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 14:51:02] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 14:51:02] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:51:02] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 14:51:02] INFO:   ✓ Generated visualization plots
[2025-11-20 14:51:02] INFO: 
[2025-11-20 14:51:02] INFO: PHASE 7: Generating Reports
[2025-11-20 14:51:02] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:51:02] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:51:02] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:51:02] INFO: 
[2025-11-20 14:51:02] INFO: Cleaning up empty directories...
[2025-11-20 14:51:02] INFO:   ✓ Removed empty directories
[2025-11-20 14:51:02] INFO: 
[2025-11-20 14:51:02] INFO: Generating HTML summary report...
[2025-11-20 14:51:02] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 14:51:02] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:51:02] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:51:02] INFO: 
[2025-11-20 14:51:02] INFO: ================================================================================
[2025-11-20 14:51:02] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 14:51:02] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:51:02] INFO:   Key files:
[2025-11-20 14:51:02] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:51:02] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:51:02] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:51:02] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:51:02] INFO: ================================================================================
[2025-11-20 14:53:49] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 14:53:49] INFO: ================================================================================
[2025-11-20 14:53:49] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 14:53:49] INFO: ================================================================================
[2025-11-20 14:53:49] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:53:49] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:53:49] INFO: 
[2025-11-20 14:53:49] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 14:53:49] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 14:53:49] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:53:49] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 14:53:49] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 14:53:49] INFO: Read 685 rows and 88 columns
[2025-11-20 14:53:49] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 14:53:49] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 14:53:49] INFO: Data quality summary:
[2025-11-20 14:53:49] INFO:   total_rows: 675
[2025-11-20 14:53:49] INFO:   total_columns: 88
[2025-11-20 14:53:49] INFO:   unique_processids: 675
[2025-11-20 14:53:49] INFO:   sequences_present: 674
[2025-11-20 14:53:49] INFO:   sequences_missing: 1
[2025-11-20 14:53:49] INFO:   empty_sequences: 0
[2025-11-20 14:53:49] INFO:   coords_present: 229
[2025-11-20 14:53:49] INFO:   coords_missing: 446
[2025-11-20 14:53:49] INFO:   centroid_coords: 58
[2025-11-20 14:53:49] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 14:53:49] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 14:53:49] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 14:53:49] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 14:53:49] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 14:53:49] INFO: 1.3: Assigning ocean basins...
[2025-11-20 14:53:49] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 14:54:14] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 14:54:14] INFO: Creating point geometries from coordinates
[2025-11-20 14:54:14] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 14:54:14] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 14:54:15] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 14:54:15] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 14:54:15] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 14:54:15] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 14:54:15] INFO: 
[2025-11-20 14:54:15] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 14:54:15] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:15] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 14:54:15] INFO:   Minimum sequence length: 400 bp
[2025-11-20 14:54:15] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 14:54:15] INFO:   ✓ Created 598 FASTA records
[2025-11-20 14:54:15] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 14:54:15] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:54:20] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 14:54:20] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 14:54:22] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 14:54:22] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 14:54:22] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 14:54:40] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 14:54:40] INFO: Clustering sequences with average linkage, threshold=0.02
[2025-11-20 14:54:40] INFO: Clustering complete: 8 clusters formed
[2025-11-20 14:54:40] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 14:54:40] INFO:   ✓ Identified 8 unique genotypes
[2025-11-20 14:54:40] INFO: 
[2025-11-20 14:54:40] INFO: PHASE 3: Genotype Assignment
[2025-11-20 14:54:40] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:40] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 14:54:40] INFO: ======================================================================
[2025-11-20 14:54:40] INFO: Starting genotype assignment workflow
[2025-11-20 14:54:40] INFO: ======================================================================
[2025-11-20 14:54:40] INFO: Using edlib for fast edit distance calculation
[2025-11-20 14:54:40] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 14:54:40] INFO: Loaded 617 samples from metadata
[2025-11-20 14:54:40] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:54:40] INFO: Read 8 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:54:40] INFO: Loaded 8 consensus groups
[2025-11-20 14:54:40] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:54:40] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 14:54:40] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 14:54:40] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 14:54:40] INFO: Prepared 617 assignment tasks
[2025-11-20 14:54:40] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 14:54:40] INFO: Identity calculation method: target_based
[2025-11-20 14:54:40] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 14:54:43] INFO: Completed genotype assignment for 617 samples
[2025-11-20 14:54:43] INFO: Step 6/6: Writing outputs
[2025-11-20 14:54:43] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:54:43] INFO: Renamed 8 consensus groups with sample counts (_nZ suffix)
[2025-11-20 14:54:43] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 14:54:43] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 14:54:43] INFO: ======================================================================
[2025-11-20 14:54:43] INFO: Genotype assignment summary:
[2025-11-20 14:54:43] INFO:   Total samples: 617
[2025-11-20 14:54:43] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 14:54:43] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 14:54:43] INFO:     - No sequence in FASTA: 19
[2025-11-20 14:54:43] INFO:     - Below identity threshold: 3
[2025-11-20 14:54:43] INFO:   Diagnostic flags:
[2025-11-20 14:54:43] INFO:     - Ties (ambiguous): 11
[2025-11-20 14:54:43] INFO:     - Low confidence: 0
[2025-11-20 14:54:43] INFO: ======================================================================
[2025-11-20 14:54:43] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 14:54:43] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 14:54:43] INFO: 
[2025-11-20 14:54:43] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 14:54:43] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:43] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 14:54:43] INFO:   ✓ Assigned taxonomy to 8 consensus groups
[2025-11-20 14:54:43] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:54:43] INFO: 
[2025-11-20 14:54:43] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 14:54:43] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:43] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 14:54:43] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:54:44] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:54:44] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 14:54:44] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:54:44] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:54:44] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 14:54:44] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 14:54:44] INFO: Loaded 8 label mappings from taxonomy CSV
[2025-11-20 14:54:44] INFO: Created 8 base name mappings
[2025-11-20 14:54:44] INFO: Relabeled 8 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:54:44] INFO: Relabeled 8 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:54:44] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:54:44] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 14:54:44] INFO: 
[2025-11-20 14:54:44] INFO: PHASE 6: Visualization
[2025-11-20 14:54:44] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:44] INFO: 6.1: Generating plots...
[2025-11-20 14:54:46] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 14:54:46] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 14:54:46] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:54:52] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 14:54:53] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 14:54:54] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 14:54:54] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:54:54] INFO: Auto-scaled tree figure size to (8, 5) for 8 tips
[2025-11-20 14:54:54] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 14:54:55] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 14:54:55] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 14:54:56] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 14:54:57] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 14:54:57] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 14:54:57] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 14:54:57] INFO: Auto-scaled tree figure size to (8, 5) for 8 tips
[2025-11-20 14:54:57] INFO:   ✓ Generated visualization plots
[2025-11-20 14:54:57] INFO: 
[2025-11-20 14:54:57] INFO: PHASE 7: Generating Reports
[2025-11-20 14:54:57] INFO: --------------------------------------------------------------------------------
[2025-11-20 14:54:57] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:54:57] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 14:54:57] INFO: 
[2025-11-20 14:54:57] INFO: Cleaning up empty directories...
[2025-11-20 14:54:57] INFO:   ✓ Removed empty directories
[2025-11-20 14:54:57] INFO: 
[2025-11-20 14:54:57] INFO: Generating HTML summary report...
[2025-11-20 14:54:57] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 14:54:57] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:54:57] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:54:57] INFO: 
[2025-11-20 14:54:57] INFO: ================================================================================
[2025-11-20 14:54:57] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 14:54:57] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 14:54:57] INFO:   Key files:
[2025-11-20 14:54:57] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 14:54:57] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 14:54:57] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 14:54:57] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 14:54:57] INFO: ================================================================================
[2025-11-20 15:07:10] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:07:10] INFO: ================================================================================
[2025-11-20 15:07:10] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:07:10] INFO: ================================================================================
[2025-11-20 15:07:10] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:07:10] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:07:10] INFO: 
[2025-11-20 15:07:10] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:07:10] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:07:10] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:07:10] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:07:10] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:07:10] INFO: Read 685 rows and 88 columns
[2025-11-20 15:07:10] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:07:10] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:07:10] INFO: Data quality summary:
[2025-11-20 15:07:10] INFO:   total_rows: 675
[2025-11-20 15:07:10] INFO:   total_columns: 88
[2025-11-20 15:07:10] INFO:   unique_processids: 675
[2025-11-20 15:07:10] INFO:   sequences_present: 674
[2025-11-20 15:07:10] INFO:   sequences_missing: 1
[2025-11-20 15:07:10] INFO:   empty_sequences: 0
[2025-11-20 15:07:10] INFO:   coords_present: 229
[2025-11-20 15:07:10] INFO:   coords_missing: 446
[2025-11-20 15:07:10] INFO:   centroid_coords: 58
[2025-11-20 15:07:10] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:07:10] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:07:10] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:07:10] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:07:10] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:07:10] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:07:10] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:07:34] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:07:34] INFO: Creating point geometries from coordinates
[2025-11-20 15:07:34] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:07:34] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:07:34] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:07:34] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:07:34] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:07:34] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:07:34] INFO: 
[2025-11-20 15:07:34] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:07:34] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:07:34] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:07:34] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:07:34] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:07:34] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:07:34] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:07:34] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:07:40] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:07:40] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:07:41] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:07:41] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:07:41] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:07:59] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:07:59] INFO: Clustering sequences with average linkage, threshold=0.025
[2025-11-20 15:07:59] INFO: Clustering complete: 7 clusters formed
[2025-11-20 15:07:59] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:07:59] INFO:   ✓ Identified 7 unique genotypes
[2025-11-20 15:07:59] INFO: 
[2025-11-20 15:07:59] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:07:59] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:07:59] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:07:59] INFO: ======================================================================
[2025-11-20 15:07:59] INFO: Starting genotype assignment workflow
[2025-11-20 15:07:59] INFO: ======================================================================
[2025-11-20 15:07:59] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:07:59] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:07:59] INFO: Loaded 617 samples from metadata
[2025-11-20 15:07:59] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:07:59] INFO: Read 7 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:07:59] INFO: Loaded 7 consensus groups
[2025-11-20 15:07:59] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:07:59] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:07:59] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:07:59] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:07:59] INFO: Prepared 617 assignment tasks
[2025-11-20 15:07:59] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:07:59] INFO: Identity calculation method: target_based
[2025-11-20 15:07:59] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:08:03] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:08:03] INFO: Step 6/6: Writing outputs
[2025-11-20 15:08:03] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:08:03] INFO: Renamed 7 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:08:03] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:08:03] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:08:03] INFO: ======================================================================
[2025-11-20 15:08:03] INFO: Genotype assignment summary:
[2025-11-20 15:08:03] INFO:   Total samples: 617
[2025-11-20 15:08:03] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:08:03] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:08:03] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:08:03] INFO:     - Below identity threshold: 3
[2025-11-20 15:08:03] INFO:   Diagnostic flags:
[2025-11-20 15:08:03] INFO:     - Ties (ambiguous): 11
[2025-11-20 15:08:03] INFO:     - Low confidence: 0
[2025-11-20 15:08:03] INFO: ======================================================================
[2025-11-20 15:08:03] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:08:03] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:08:03] INFO: 
[2025-11-20 15:08:03] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:08:03] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:08:03] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:08:03] INFO:   ✓ Assigned taxonomy to 7 consensus groups
[2025-11-20 15:08:03] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:08:03] INFO: 
[2025-11-20 15:08:03] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:08:03] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:08:03] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:08:03] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:08:04] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:08:04] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:08:04] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:08:04] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:08:04] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:08:04] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:08:04] INFO: Loaded 7 label mappings from taxonomy CSV
[2025-11-20 15:08:04] INFO: Created 7 base name mappings
[2025-11-20 15:08:04] INFO: Relabeled 7 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:08:04] INFO: Relabeled 7 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:08:04] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:08:04] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:08:04] INFO: 
[2025-11-20 15:08:04] INFO: PHASE 6: Visualization
[2025-11-20 15:08:04] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:08:04] INFO: 6.1: Generating plots...
[2025-11-20 15:08:05] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:08:06] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:08:06] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:08:11] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:08:12] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:08:13] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:08:13] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:08:13] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-20 15:08:13] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:08:14] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:08:14] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:08:15] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:08:15] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:08:15] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:08:15] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:08:15] INFO: Auto-scaled tree figure size to (8, 5) for 7 tips
[2025-11-20 15:08:16] INFO:   ✓ Generated visualization plots
[2025-11-20 15:08:16] INFO: 
[2025-11-20 15:08:16] INFO: PHASE 7: Generating Reports
[2025-11-20 15:08:16] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:08:16] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:08:16] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:08:16] INFO: 
[2025-11-20 15:08:16] INFO: Cleaning up empty directories...
[2025-11-20 15:08:16] INFO:   ✓ Removed empty directories
[2025-11-20 15:08:16] INFO: 
[2025-11-20 15:08:16] INFO: Generating HTML summary report...
[2025-11-20 15:08:16] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:08:16] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:08:16] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:08:16] INFO: 
[2025-11-20 15:08:16] INFO: ================================================================================
[2025-11-20 15:08:16] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:08:16] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:08:16] INFO:   Key files:
[2025-11-20 15:08:16] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:08:16] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:08:16] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:08:16] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:08:16] INFO: ================================================================================
[2025-11-20 15:09:56] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:09:56] INFO: ================================================================================
[2025-11-20 15:09:56] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:09:56] INFO: ================================================================================
[2025-11-20 15:09:56] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:09:56] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:09:56] INFO: 
[2025-11-20 15:09:56] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:09:56] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:09:56] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:09:56] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:09:56] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:09:56] INFO: Read 685 rows and 88 columns
[2025-11-20 15:09:56] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:09:56] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:09:56] INFO: Data quality summary:
[2025-11-20 15:09:56] INFO:   total_rows: 675
[2025-11-20 15:09:56] INFO:   total_columns: 88
[2025-11-20 15:09:56] INFO:   unique_processids: 675
[2025-11-20 15:09:56] INFO:   sequences_present: 674
[2025-11-20 15:09:56] INFO:   sequences_missing: 1
[2025-11-20 15:09:56] INFO:   empty_sequences: 0
[2025-11-20 15:09:56] INFO:   coords_present: 229
[2025-11-20 15:09:56] INFO:   coords_missing: 446
[2025-11-20 15:09:56] INFO:   centroid_coords: 58
[2025-11-20 15:09:56] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:09:56] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:09:56] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:09:56] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:09:56] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:09:56] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:09:56] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:10:19] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:10:19] INFO: Creating point geometries from coordinates
[2025-11-20 15:10:19] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:10:19] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:10:20] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:10:20] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:10:20] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:10:20] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:10:20] INFO: 
[2025-11-20 15:10:20] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:10:20] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:10:20] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:10:20] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:10:20] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:10:20] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:10:20] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:10:20] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:10:25] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:10:25] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:10:26] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:10:26] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:10:26] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:10:45] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:10:45] INFO: Clustering sequences with average linkage, threshold=0.03
[2025-11-20 15:10:45] INFO: Clustering complete: 6 clusters formed
[2025-11-20 15:10:45] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:10:45] INFO:   ✓ Identified 6 unique genotypes
[2025-11-20 15:10:45] INFO: 
[2025-11-20 15:10:45] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:10:45] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:10:45] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:10:45] INFO: ======================================================================
[2025-11-20 15:10:45] INFO: Starting genotype assignment workflow
[2025-11-20 15:10:45] INFO: ======================================================================
[2025-11-20 15:10:45] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:10:45] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:10:45] INFO: Loaded 617 samples from metadata
[2025-11-20 15:10:45] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:10:45] INFO: Read 6 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:10:45] INFO: Loaded 6 consensus groups
[2025-11-20 15:10:45] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:10:45] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:10:45] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:10:45] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:10:45] INFO: Prepared 617 assignment tasks
[2025-11-20 15:10:45] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:10:45] INFO: Identity calculation method: target_based
[2025-11-20 15:10:45] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:10:49] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:10:49] INFO: Step 6/6: Writing outputs
[2025-11-20 15:10:49] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:10:49] INFO: Renamed 6 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:10:49] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:10:49] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:10:49] INFO: ======================================================================
[2025-11-20 15:10:49] INFO: Genotype assignment summary:
[2025-11-20 15:10:49] INFO:   Total samples: 617
[2025-11-20 15:10:49] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:10:49] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:10:49] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:10:49] INFO:     - Below identity threshold: 3
[2025-11-20 15:10:49] INFO:   Diagnostic flags:
[2025-11-20 15:10:49] INFO:     - Ties (ambiguous): 2
[2025-11-20 15:10:49] INFO:     - Low confidence: 0
[2025-11-20 15:10:49] INFO: ======================================================================
[2025-11-20 15:10:49] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:10:49] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:10:49] INFO: 
[2025-11-20 15:10:49] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:10:49] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:10:49] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:10:49] INFO:   ✓ Assigned taxonomy to 6 consensus groups
[2025-11-20 15:10:49] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:10:49] INFO: 
[2025-11-20 15:10:49] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:10:49] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:10:49] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:10:49] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:10:50] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:10:50] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:10:50] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:10:50] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:10:50] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:10:50] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:10:50] INFO: Loaded 6 label mappings from taxonomy CSV
[2025-11-20 15:10:50] INFO: Created 6 base name mappings
[2025-11-20 15:10:50] INFO: Relabeled 6 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:10:50] INFO: Relabeled 6 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:10:50] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:10:50] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:10:50] INFO: 
[2025-11-20 15:10:50] INFO: PHASE 6: Visualization
[2025-11-20 15:10:50] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:10:50] INFO: 6.1: Generating plots...
[2025-11-20 15:10:51] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:10:52] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:10:52] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:10:57] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:10:58] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:10:58] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:10:58] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:10:58] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-20 15:10:59] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:10:59] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:10:59] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:11:01] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:11:01] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:11:01] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:11:01] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:11:01] INFO: Auto-scaled tree figure size to (8, 5) for 6 tips
[2025-11-20 15:11:01] INFO:   ✓ Generated visualization plots
[2025-11-20 15:11:01] INFO: 
[2025-11-20 15:11:01] INFO: PHASE 7: Generating Reports
[2025-11-20 15:11:01] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:11:01] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:11:01] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:11:01] INFO: 
[2025-11-20 15:11:01] INFO: Cleaning up empty directories...
[2025-11-20 15:11:01] INFO:   ✓ Removed empty directories
[2025-11-20 15:11:01] INFO: 
[2025-11-20 15:11:01] INFO: Generating HTML summary report...
[2025-11-20 15:11:01] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:11:02] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:11:02] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:11:02] INFO: 
[2025-11-20 15:11:02] INFO: ================================================================================
[2025-11-20 15:11:02] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:11:02] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:11:02] INFO:   Key files:
[2025-11-20 15:11:02] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:11:02] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:11:02] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:11:02] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:11:02] INFO: ================================================================================
[2025-11-20 15:19:52] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:19:52] INFO: ================================================================================
[2025-11-20 15:19:52] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:19:52] INFO: ================================================================================
[2025-11-20 15:19:52] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:19:52] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:19:52] INFO: 
[2025-11-20 15:19:52] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:19:52] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:19:52] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:19:52] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:19:52] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:19:52] INFO: Read 685 rows and 88 columns
[2025-11-20 15:19:52] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:19:52] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:19:52] INFO: Data quality summary:
[2025-11-20 15:19:52] INFO:   total_rows: 675
[2025-11-20 15:19:52] INFO:   total_columns: 88
[2025-11-20 15:19:52] INFO:   unique_processids: 675
[2025-11-20 15:19:52] INFO:   sequences_present: 674
[2025-11-20 15:19:52] INFO:   sequences_missing: 1
[2025-11-20 15:19:52] INFO:   empty_sequences: 0
[2025-11-20 15:19:52] INFO:   coords_present: 229
[2025-11-20 15:19:52] INFO:   coords_missing: 446
[2025-11-20 15:19:52] INFO:   centroid_coords: 58
[2025-11-20 15:19:52] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:19:52] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:19:52] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:19:52] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:19:52] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:19:52] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:19:52] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:20:17] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:20:18] INFO: Creating point geometries from coordinates
[2025-11-20 15:20:18] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:20:18] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:20:18] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:20:18] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:20:18] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:20:18] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:20:18] INFO: 
[2025-11-20 15:20:18] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:20:18] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:18] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:20:18] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:20:18] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:20:18] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:20:18] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:20:18] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:20:23] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:20:23] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:20:25] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:20:25] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:20:25] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:20:42] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:20:42] INFO: Clustering sequences with average linkage, threshold=0.04
[2025-11-20 15:20:42] INFO: Clustering complete: 4 clusters formed
[2025-11-20 15:20:43] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:20:43] INFO:   ✓ Identified 4 unique genotypes
[2025-11-20 15:20:43] INFO: 
[2025-11-20 15:20:43] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:20:43] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:43] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:20:43] INFO: ======================================================================
[2025-11-20 15:20:43] INFO: Starting genotype assignment workflow
[2025-11-20 15:20:43] INFO: ======================================================================
[2025-11-20 15:20:43] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:20:43] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:20:43] INFO: Loaded 617 samples from metadata
[2025-11-20 15:20:43] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:20:43] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:20:43] INFO: Loaded 4 consensus groups
[2025-11-20 15:20:43] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:20:43] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:20:43] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:20:43] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:20:43] INFO: Prepared 617 assignment tasks
[2025-11-20 15:20:43] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:20:43] INFO: Identity calculation method: target_based
[2025-11-20 15:20:43] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:20:46] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:20:46] INFO: Step 6/6: Writing outputs
[2025-11-20 15:20:46] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:20:46] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:20:46] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:20:46] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:20:46] INFO: ======================================================================
[2025-11-20 15:20:46] INFO: Genotype assignment summary:
[2025-11-20 15:20:46] INFO:   Total samples: 617
[2025-11-20 15:20:46] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:20:46] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:20:46] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:20:46] INFO:     - Below identity threshold: 3
[2025-11-20 15:20:46] INFO:   Diagnostic flags:
[2025-11-20 15:20:46] INFO:     - Ties (ambiguous): 0
[2025-11-20 15:20:46] INFO:     - Low confidence: 0
[2025-11-20 15:20:46] INFO: ======================================================================
[2025-11-20 15:20:46] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:20:46] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:20:46] INFO: 
[2025-11-20 15:20:46] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:20:46] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:46] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:20:46] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-20 15:20:46] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:20:46] INFO: 
[2025-11-20 15:20:46] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:20:46] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:46] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:20:46] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:20:47] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:20:47] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:20:47] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:20:47] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:20:47] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:20:47] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:20:47] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-20 15:20:47] INFO: Created 4 base name mappings
[2025-11-20 15:20:47] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:20:47] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:20:47] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:20:47] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:20:47] INFO: 
[2025-11-20 15:20:47] INFO: PHASE 6: Visualization
[2025-11-20 15:20:47] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:47] INFO: 6.1: Generating plots...
[2025-11-20 15:20:49] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:20:49] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:20:49] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:20:53] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:20:54] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:20:54] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:20:54] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:20:54] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 15:20:55] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:20:55] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:20:55] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:20:56] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:20:56] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:20:56] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:20:56] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:20:56] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 15:20:56] INFO:   ✓ Generated visualization plots
[2025-11-20 15:20:56] INFO: 
[2025-11-20 15:20:56] INFO: PHASE 7: Generating Reports
[2025-11-20 15:20:56] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:20:56] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:20:56] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:20:56] INFO: 
[2025-11-20 15:20:56] INFO: Cleaning up empty directories...
[2025-11-20 15:20:56] INFO:   ✓ Removed empty directories
[2025-11-20 15:20:56] INFO: 
[2025-11-20 15:20:56] INFO: Generating HTML summary report...
[2025-11-20 15:20:56] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:20:57] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:20:57] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:20:57] INFO: 
[2025-11-20 15:20:57] INFO: ================================================================================
[2025-11-20 15:20:57] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:20:57] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:20:57] INFO:   Key files:
[2025-11-20 15:20:57] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:20:57] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:20:57] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:20:57] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:20:57] INFO: ================================================================================
[2025-11-20 15:33:57] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:33:57] INFO: ================================================================================
[2025-11-20 15:33:57] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:33:57] INFO: ================================================================================
[2025-11-20 15:33:57] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:33:57] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:33:57] INFO: 
[2025-11-20 15:33:57] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:33:57] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:33:57] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:33:57] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:33:57] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:33:57] INFO: Read 685 rows and 88 columns
[2025-11-20 15:33:57] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:33:57] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:33:57] INFO: Data quality summary:
[2025-11-20 15:33:57] INFO:   total_rows: 675
[2025-11-20 15:33:57] INFO:   total_columns: 88
[2025-11-20 15:33:57] INFO:   unique_processids: 675
[2025-11-20 15:33:57] INFO:   sequences_present: 674
[2025-11-20 15:33:57] INFO:   sequences_missing: 1
[2025-11-20 15:33:57] INFO:   empty_sequences: 0
[2025-11-20 15:33:57] INFO:   coords_present: 229
[2025-11-20 15:33:57] INFO:   coords_missing: 446
[2025-11-20 15:33:57] INFO:   centroid_coords: 58
[2025-11-20 15:33:57] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:33:57] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:33:57] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:33:57] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:33:57] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:33:57] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:33:57] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:34:23] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:34:23] INFO: Creating point geometries from coordinates
[2025-11-20 15:34:23] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:34:23] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:34:23] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:34:23] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:34:23] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:34:23] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:34:23] INFO: 
[2025-11-20 15:34:23] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:34:23] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:34:23] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:34:23] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:34:23] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:34:23] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:34:23] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:34:23] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:34:29] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:34:29] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:34:30] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:34:30] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:34:30] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:34:48] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:34:48] INFO: Clustering sequences with average linkage, threshold=0.01
[2025-11-20 15:34:48] INFO: Clustering complete: 17 clusters formed
[2025-11-20 15:34:49] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:34:49] INFO:   ✓ Identified 17 unique genotypes
[2025-11-20 15:34:49] INFO: 
[2025-11-20 15:34:49] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:34:49] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:34:49] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:34:49] INFO: ======================================================================
[2025-11-20 15:34:49] INFO: Starting genotype assignment workflow
[2025-11-20 15:34:49] INFO: ======================================================================
[2025-11-20 15:34:49] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:34:49] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:34:49] INFO: Loaded 617 samples from metadata
[2025-11-20 15:34:49] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:34:49] INFO: Read 17 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:34:49] INFO: Loaded 17 consensus groups
[2025-11-20 15:34:49] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:34:49] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:34:49] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:34:49] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:34:49] INFO: Prepared 617 assignment tasks
[2025-11-20 15:34:49] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:34:49] INFO: Identity calculation method: target_based
[2025-11-20 15:34:49] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:34:53] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:34:53] INFO: Step 6/6: Writing outputs
[2025-11-20 15:34:53] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:34:53] INFO: Renamed 17 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:34:53] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:34:53] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:34:53] INFO: ======================================================================
[2025-11-20 15:34:53] INFO: Genotype assignment summary:
[2025-11-20 15:34:53] INFO:   Total samples: 617
[2025-11-20 15:34:53] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:34:53] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:34:53] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:34:53] INFO:     - Below identity threshold: 3
[2025-11-20 15:34:53] INFO:   Diagnostic flags:
[2025-11-20 15:34:53] INFO:     - Ties (ambiguous): 8
[2025-11-20 15:34:53] INFO:     - Low confidence: 0
[2025-11-20 15:34:53] INFO: ======================================================================
[2025-11-20 15:34:53] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:34:53] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:34:53] INFO: 
[2025-11-20 15:34:53] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:34:53] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:34:53] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:34:53] INFO:   ✓ Assigned taxonomy to 17 consensus groups
[2025-11-20 15:34:53] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:34:53] INFO: 
[2025-11-20 15:34:53] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:34:53] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:34:53] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:34:53] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:34:54] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:34:54] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:34:54] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:34:54] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:34:54] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:34:54] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:34:54] INFO: Loaded 17 label mappings from taxonomy CSV
[2025-11-20 15:34:54] INFO: Created 17 base name mappings
[2025-11-20 15:34:54] INFO: Relabeled 17 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:34:54] INFO: Relabeled 17 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:34:54] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:34:54] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:34:54] INFO: 
[2025-11-20 15:34:54] INFO: PHASE 6: Visualization
[2025-11-20 15:34:54] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:34:54] INFO: 6.1: Generating plots...
[2025-11-20 15:34:57] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:34:57] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:34:57] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:35:04] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:35:05] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:35:06] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:35:06] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:35:06] INFO: Auto-scaled tree figure size to (8, 5) for 17 tips
[2025-11-20 15:35:07] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:35:07] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:35:07] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:35:09] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:35:10] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:35:10] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:35:10] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:35:10] INFO: Auto-scaled tree figure size to (8, 5) for 17 tips
[2025-11-20 15:35:10] INFO:   ✓ Generated visualization plots
[2025-11-20 15:35:10] INFO: 
[2025-11-20 15:35:10] INFO: PHASE 7: Generating Reports
[2025-11-20 15:35:10] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:35:10] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:35:10] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:35:10] INFO: 
[2025-11-20 15:35:10] INFO: Cleaning up empty directories...
[2025-11-20 15:35:10] INFO:   ✓ Removed empty directories
[2025-11-20 15:35:10] INFO: 
[2025-11-20 15:35:10] INFO: Generating HTML summary report...
[2025-11-20 15:35:10] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:35:10] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:35:10] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:35:10] INFO: 
[2025-11-20 15:35:10] INFO: ================================================================================
[2025-11-20 15:35:10] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:35:10] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:35:10] INFO:   Key files:
[2025-11-20 15:35:10] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:35:10] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:35:10] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:35:10] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:35:10] INFO: ================================================================================
[2025-11-20 15:39:51] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:39:51] INFO: ================================================================================
[2025-11-20 15:39:51] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:39:51] INFO: ================================================================================
[2025-11-20 15:39:51] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:39:51] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:39:51] INFO: 
[2025-11-20 15:39:51] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:39:51] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:39:51] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:39:51] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:39:51] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:39:51] INFO: Read 685 rows and 88 columns
[2025-11-20 15:39:51] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:39:51] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:39:51] INFO: Data quality summary:
[2025-11-20 15:39:51] INFO:   total_rows: 675
[2025-11-20 15:39:51] INFO:   total_columns: 88
[2025-11-20 15:39:51] INFO:   unique_processids: 675
[2025-11-20 15:39:51] INFO:   sequences_present: 674
[2025-11-20 15:39:51] INFO:   sequences_missing: 1
[2025-11-20 15:39:51] INFO:   empty_sequences: 0
[2025-11-20 15:39:51] INFO:   coords_present: 229
[2025-11-20 15:39:51] INFO:   coords_missing: 446
[2025-11-20 15:39:51] INFO:   centroid_coords: 58
[2025-11-20 15:39:51] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:39:51] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:39:51] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:39:51] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:39:51] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:39:51] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:39:51] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:40:15] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:40:15] INFO: Creating point geometries from coordinates
[2025-11-20 15:40:15] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:40:15] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:40:16] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:40:16] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:40:16] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:40:16] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:40:16] INFO: 
[2025-11-20 15:40:16] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:40:16] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:16] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:40:16] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:40:16] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:40:16] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:40:16] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:40:16] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:40:21] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:40:21] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:40:23] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:40:23] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:40:23] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:40:41] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:40:41] INFO: Clustering sequences with average linkage, threshold=0.035
[2025-11-20 15:40:41] INFO: Clustering complete: 4 clusters formed
[2025-11-20 15:40:41] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:40:41] INFO:   ✓ Identified 4 unique genotypes
[2025-11-20 15:40:41] INFO: 
[2025-11-20 15:40:41] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:40:41] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:41] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:40:41] INFO: ======================================================================
[2025-11-20 15:40:41] INFO: Starting genotype assignment workflow
[2025-11-20 15:40:41] INFO: ======================================================================
[2025-11-20 15:40:41] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:40:41] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:40:41] INFO: Loaded 617 samples from metadata
[2025-11-20 15:40:41] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:40:41] INFO: Read 4 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:40:41] INFO: Loaded 4 consensus groups
[2025-11-20 15:40:41] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:40:41] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:40:41] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:40:41] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:40:41] INFO: Prepared 617 assignment tasks
[2025-11-20 15:40:41] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:40:41] INFO: Identity calculation method: target_based
[2025-11-20 15:40:41] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:40:44] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:40:44] INFO: Step 6/6: Writing outputs
[2025-11-20 15:40:44] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:40:44] INFO: Renamed 4 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:40:44] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:40:44] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:40:44] INFO: ======================================================================
[2025-11-20 15:40:44] INFO: Genotype assignment summary:
[2025-11-20 15:40:44] INFO:   Total samples: 617
[2025-11-20 15:40:44] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:40:44] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:40:44] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:40:44] INFO:     - Below identity threshold: 3
[2025-11-20 15:40:44] INFO:   Diagnostic flags:
[2025-11-20 15:40:44] INFO:     - Ties (ambiguous): 0
[2025-11-20 15:40:44] INFO:     - Low confidence: 0
[2025-11-20 15:40:44] INFO: ======================================================================
[2025-11-20 15:40:44] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:40:44] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:40:44] INFO: 
[2025-11-20 15:40:44] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:40:44] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:44] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:40:44] INFO:   ✓ Assigned taxonomy to 4 consensus groups
[2025-11-20 15:40:44] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:40:44] INFO: 
[2025-11-20 15:40:44] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:40:44] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:44] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:40:44] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:40:45] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:40:45] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:40:45] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:40:45] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:40:45] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:40:45] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:40:45] INFO: Loaded 4 label mappings from taxonomy CSV
[2025-11-20 15:40:45] INFO: Created 4 base name mappings
[2025-11-20 15:40:45] INFO: Relabeled 4 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:40:45] INFO: Relabeled 4 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:40:45] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:40:45] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:40:45] INFO: 
[2025-11-20 15:40:45] INFO: PHASE 6: Visualization
[2025-11-20 15:40:45] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:45] INFO: 6.1: Generating plots...
[2025-11-20 15:40:47] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:40:47] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:40:47] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:40:51] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:40:52] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:40:52] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:40:52] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:40:52] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 15:40:53] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:40:53] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:40:53] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:40:54] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:40:54] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:40:55] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:40:55] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:40:55] INFO: Auto-scaled tree figure size to (8, 5) for 4 tips
[2025-11-20 15:40:55] INFO:   ✓ Generated visualization plots
[2025-11-20 15:40:55] INFO: 
[2025-11-20 15:40:55] INFO: PHASE 7: Generating Reports
[2025-11-20 15:40:55] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:40:55] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:40:55] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:40:55] INFO: 
[2025-11-20 15:40:55] INFO: Cleaning up empty directories...
[2025-11-20 15:40:55] INFO:   ✓ Removed empty directories
[2025-11-20 15:40:55] INFO: 
[2025-11-20 15:40:55] INFO: Generating HTML summary report...
[2025-11-20 15:40:55] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:40:55] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:40:55] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:40:55] INFO: 
[2025-11-20 15:40:55] INFO: ================================================================================
[2025-11-20 15:40:55] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:40:55] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:40:55] INFO:   Key files:
[2025-11-20 15:40:55] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:40:55] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:40:55] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:40:55] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:40:55] INFO: ================================================================================
[2025-11-20 15:42:20] INFO: Logging to file: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline.log
[2025-11-20 15:42:20] INFO: ================================================================================
[2025-11-20 15:42:20] INFO: BOLDGenotyper Pipeline - Sphyrna lewini
[2025-11-20 15:42:20] INFO: ================================================================================
[2025-11-20 15:42:20] INFO: Input TSV: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:42:20] INFO: Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:42:20] INFO: 
[2025-11-20 15:42:20] INFO: Saved pipeline parameters to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_pipeline_parameters.json
[2025-11-20 15:42:20] INFO: PHASE 1: Data Loading and Quality Control
[2025-11-20 15:42:20] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:42:20] INFO: 1.1: Parsing BOLD TSV metadata...
[2025-11-20 15:42:20] INFO: Reading BOLD TSV file: data/Sphyrna_lewini_scallopedhammerhead.tsv
[2025-11-20 15:42:21] INFO: Read 685 rows and 88 columns
[2025-11-20 15:42:21] WARNING: Found 10 duplicate processids. Examples: ['GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16', 'GBMTG5082-16']. Keeping only first occurrence of each duplicate.
[2025-11-20 15:42:21] INFO: After removing duplicates: 675 rows remaining
[2025-11-20 15:42:21] INFO: Data quality summary:
[2025-11-20 15:42:21] INFO:   total_rows: 675
[2025-11-20 15:42:21] INFO:   total_columns: 88
[2025-11-20 15:42:21] INFO:   unique_processids: 675
[2025-11-20 15:42:21] INFO:   sequences_present: 674
[2025-11-20 15:42:21] INFO:   sequences_missing: 1
[2025-11-20 15:42:21] INFO:   empty_sequences: 0
[2025-11-20 15:42:21] INFO:   coords_present: 229
[2025-11-20 15:42:21] INFO:   coords_missing: 446
[2025-11-20 15:42:21] INFO:   centroid_coords: 58
[2025-11-20 15:42:21] INFO:   ✓ Loaded 675 samples with 88 columns
[2025-11-20 15:42:21] INFO: 1.2: Filtering coordinate quality...
[2025-11-20 15:42:21] INFO: Excluded 58 samples with centroid coordinates
[2025-11-20 15:42:21] INFO: Coordinate filtering: 617/675 samples retained (91.4%), 58 excluded
[2025-11-20 15:42:21] INFO:   ✓ Retained 617/675 samples after coordinate filtering
[2025-11-20 15:42:21] INFO: 1.3: Assigning ocean basins...
[2025-11-20 15:42:21] INFO: Loading GOaS shapefile from: /Users/stesmith/Documents/depredation/boldgenotyper/GOaS_v1_20211214/goas_v01.shp
[2025-11-20 15:42:45] INFO: Loaded 10 ocean basins from GOaS shapefile
[2025-11-20 15:42:45] INFO: Creating point geometries from coordinates
[2025-11-20 15:42:45] INFO: Creating point geometries for 171/617 samples with coordinates
[2025-11-20 15:42:45] INFO: Performing spatial join for 171/617 samples with valid coordinates
[2025-11-20 15:42:45] INFO: Spatial join results: 71 assigned to basins, 100 outside all basins
[2025-11-20 15:42:45] WARNING: 58.5% of coordinates fall outside GOaS basins. This may indicate terrestrial coordinates or incomplete basin coverage.
[2025-11-20 15:42:45] INFO: Assigned 546 samples to 'Unknown' basin (no coordinates or outside all basins)
[2025-11-20 15:42:45] INFO:   ✓ Assigned ocean basins to samples
[2025-11-20 15:42:45] INFO: 
[2025-11-20 15:42:45] INFO: PHASE 2: Sequence Dereplication and Consensus Generation
[2025-11-20 15:42:45] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:42:45] INFO: 2.1: Generating FASTA from sequences...
[2025-11-20 15:42:45] INFO:   Minimum sequence length: 400 bp
[2025-11-20 15:42:45] WARNING:   ⚠ Skipped 19 samples with missing or invalid sequences
[2025-11-20 15:42:45] INFO:   ✓ Created 598 FASTA records
[2025-11-20 15:42:45] INFO: 2.2: Dereplicating sequences (clustering at 99% identity)...
[2025-11-20 15:42:45] INFO: Running MAFFT alignment: mafft --auto /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:42:51] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta
[2025-11-20 15:42:51] INFO: Running trimAl: trimal -in /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_aligned.fasta -out /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta -automated1
[2025-11-20 15:42:52] INFO: trimAl completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_trimmed.fasta
[2025-11-20 15:42:52] INFO:   Filtered 3 sequences shorter than 300 bp after trimming
[2025-11-20 15:42:52] INFO: Calculating pairwise distances for 595 sequences
[2025-11-20 15:43:10] INFO: Distance calculation complete: 176715 pairwise distances
[2025-11-20 15:43:10] INFO: Clustering sequences with average linkage, threshold=0.015
[2025-11-20 15:43:10] INFO: Clustering complete: 10 clusters formed
[2025-11-20 15:43:10] INFO: Wrote consensus metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus_metadata.csv
[2025-11-20 15:43:10] INFO:   ✓ Identified 10 unique genotypes
[2025-11-20 15:43:10] INFO: 
[2025-11-20 15:43:10] INFO: PHASE 3: Genotype Assignment
[2025-11-20 15:43:10] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:43:10] INFO: 3.1: Assigning samples to genotypes...
[2025-11-20 15:43:10] INFO: ======================================================================
[2025-11-20 15:43:10] INFO: Starting genotype assignment workflow
[2025-11-20 15:43:10] INFO: ======================================================================
[2025-11-20 15:43:10] INFO: Using edlib for fast edit distance calculation
[2025-11-20 15:43:10] INFO: Step 1/6: Loading metadata from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/02_filtered_metadata.tsv
[2025-11-20 15:43:10] INFO: Loaded 617 samples from metadata
[2025-11-20 15:43:10] INFO: Step 2/6: Loading consensus sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:43:10] INFO: Read 10 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:43:10] INFO: Loaded 10 consensus groups
[2025-11-20 15:43:10] INFO: Step 3/6: Loading raw sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:43:10] INFO: Read 598 sequences from /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/Sphyrna lewini.fasta
[2025-11-20 15:43:10] INFO: Extracted 598 unique processids from FASTA
[2025-11-20 15:43:10] INFO: Step 4/6: Preparing assignment tasks
[2025-11-20 15:43:10] INFO: Prepared 617 assignment tasks
[2025-11-20 15:43:10] INFO: Step 5/6: Assigning genotypes (using 4 processes)
[2025-11-20 15:43:10] INFO: Identity calculation method: target_based
[2025-11-20 15:43:10] INFO: Tie margin: 0.003, tie_min_identity: 0.95
[2025-11-20 15:43:13] INFO: Completed genotype assignment for 617 samples
[2025-11-20 15:43:13] INFO: Step 6/6: Writing outputs
[2025-11-20 15:43:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:43:13] INFO: Renamed 10 consensus groups with sample counts (_nZ suffix)
[2025-11-20 15:43:13] INFO: Wrote updated metadata to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/genotype_assignments/Sphyrna lewini_with_genotypes.tsv
[2025-11-20 15:43:13] INFO: Wrote diagnostics to /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_diagnostics.csv
[2025-11-20 15:43:13] INFO: ======================================================================
[2025-11-20 15:43:13] INFO: Genotype assignment summary:
[2025-11-20 15:43:13] INFO:   Total samples: 617
[2025-11-20 15:43:13] INFO:   Successfully assigned: 595 (96.4%)
[2025-11-20 15:43:13] INFO:   Unassigned: 22 (3.6%)
[2025-11-20 15:43:13] INFO:     - No sequence in FASTA: 19
[2025-11-20 15:43:13] INFO:     - Below identity threshold: 3
[2025-11-20 15:43:13] INFO:   Diagnostic flags:
[2025-11-20 15:43:13] INFO:     - Ties (ambiguous): 1
[2025-11-20 15:43:13] INFO:     - Low confidence: 0
[2025-11-20 15:43:13] INFO: ======================================================================
[2025-11-20 15:43:13] INFO:   ✓ Assigned 595/617 samples to genotypes
[2025-11-20 15:43:13] INFO:   ✓ Assignment rate: 96.4%
[2025-11-20 15:43:13] INFO: 
[2025-11-20 15:43:13] INFO: PHASE 4: Taxonomy Assignment to Consensus Groups
[2025-11-20 15:43:13] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:43:13] INFO: 4.1: Assigning taxonomy to consensus groups...
[2025-11-20 15:43:13] INFO:   ✓ Assigned taxonomy to 10 consensus groups
[2025-11-20 15:43:13] INFO:   ✓ Saved annotated dataset: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:43:13] INFO: 
[2025-11-20 15:43:13] INFO: PHASE 5: Phylogenetic Analysis
[2025-11-20 15:43:13] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:43:13] INFO: 5.1: Building phylogenetic tree...
[2025-11-20 15:43:13] INFO: Running MAFFT alignment: mafft --auto --thread 4 /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:43:15] INFO: MAFFT alignment completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:43:15] INFO: Running FastTree: fasttree -nt -gtr -gamma /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned.fasta
[2025-11-20 15:43:15] INFO: FastTree completed: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:43:15] INFO:   ✓ Built phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:43:15] INFO: 5.2: Creating relabeled tree and alignment files...
[2025-11-20 15:43:15] INFO: Relabeling tree and alignment with consensus_group_sp labels
[2025-11-20 15:43:15] INFO: Loaded 10 label mappings from taxonomy CSV
[2025-11-20 15:43:15] INFO: Created 10 base name mappings
[2025-11-20 15:43:15] INFO: Relabeled 10 tree tips, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:43:15] INFO: Relabeled 10 sequences, wrote to: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:43:15] INFO:   ✓ Created relabeled tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:43:15] INFO:   ✓ Created relabeled alignment (intermediate): /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/phylogenetic/Sphyrna lewini_aligned_relabeled.fasta
[2025-11-20 15:43:15] INFO: 
[2025-11-20 15:43:15] INFO: PHASE 6: Visualization
[2025-11-20 15:43:15] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:43:15] INFO: 6.1: Generating plots...
[2025-11-20 15:43:16] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.png
[2025-11-20 15:43:17] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.png
[2025-11-20 15:43:17] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:43:22] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.png
[2025-11-20 15:43:23] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.png
[2025-11-20 15:43:24] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.png
[2025-11-20 15:43:24] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:43:24] INFO: Auto-scaled tree figure size to (8, 5) for 10 tips
[2025-11-20 15:43:24] INFO: Saved ocean basin abundance (relative) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar.pdf
[2025-11-20 15:43:25] INFO: Saved ocean basin abundance (total counts) plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_totaldistribution_bar.pdf
[2025-11-20 15:43:25] INFO: Creating faceted distribution map with cartopy backgrounds, faceting by species
[2025-11-20 15:43:26] INFO: Saved faceted distribution map: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_map_faceted.pdf
[2025-11-20 15:43:26] INFO: Saved faceted basin abundance plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/visualization/Sphyrna lewini_distribution_bar_faceted.pdf
[2025-11-20 15:43:27] INFO: Saved identity distribution plot: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/genotype_assignments/Sphyrna lewini_identity_distribution.pdf
[2025-11-20 15:43:27] INFO: Using relabeled tree for visualization: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree_relabeled.nwk
[2025-11-20 15:43:27] INFO: Auto-scaled tree figure size to (8, 5) for 10 tips
[2025-11-20 15:43:27] INFO:   ✓ Generated visualization plots
[2025-11-20 15:43:27] INFO: 
[2025-11-20 15:43:27] INFO: PHASE 7: Generating Reports
[2025-11-20 15:43:27] INFO: --------------------------------------------------------------------------------
[2025-11-20 15:43:27] INFO: Assignment summary saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:43:27] INFO:   ✓ Generated assignment summary: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/reports/Sphyrna lewini_assignment_summary.csv
[2025-11-20 15:43:27] INFO: 
[2025-11-20 15:43:27] INFO: Cleaning up empty directories...
[2025-11-20 15:43:27] INFO:   ✓ Removed empty directories
[2025-11-20 15:43:27] INFO: 
[2025-11-20 15:43:27] INFO: Generating HTML summary report...
[2025-11-20 15:43:27] INFO: Generating HTML summary report for Sphyrna lewini...
[2025-11-20 15:43:27] INFO: HTML report saved: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:43:27] INFO:   ✓ Generated HTML report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:43:27] INFO: 
[2025-11-20 15:43:27] INFO: ================================================================================
[2025-11-20 15:43:27] INFO: ✓ Pipeline completed successfully for Sphyrna lewini
[2025-11-20 15:43:27] INFO:   Output directory: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini
[2025-11-20 15:43:27] INFO:   Key files:
[2025-11-20 15:43:27] INFO:     - Annotated data: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_annotated.csv
[2025-11-20 15:43:27] INFO:     - Consensus sequences: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/intermediate/dereplication/Sphyrna lewini_consensus.fasta
[2025-11-20 15:43:27] INFO:     - Phylogenetic tree: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/phylogenetic/Sphyrna lewini_tree.nwk
[2025-11-20 15:43:27] INFO:     - HTML summary report: /Users/stesmith/Documents/depredation/boldgenotyper/data/Sphyrna_lewini/Sphyrna lewini_summary_report.html
[2025-11-20 15:43:27] INFO: ================================================================================
